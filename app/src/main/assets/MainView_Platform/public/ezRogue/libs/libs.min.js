"use strict";function loader(){this._init()}loader.prototype._init=function(){};loader.prototype._setStartProgressVal=function(a){core.dom.startTopProgress.style.width=a+"%"};loader.prototype._setStartLoadTipText=function(a){core.dom.startTopLoadTips.innerText=a};loader.prototype._load=function(a){if(main.useCompress){this._load_async(a)}else{this._load_sync(a)}};loader.prototype._load_sync=function(a){this._loadAnimates_sync();this._loadMusic_sync();core.loader._loadMaterials_sync(function(){core.loader._loadExtraImages_sync(function(){core.loader._loadAutotiles_sync(function(){core.loader._loadTilesets_sync(a)})})})};loader.prototype._load_async=function(d){core.loader._setStartLoadTipText("正在加载资源文件...");var c={};var b=function(e){if(!c[e]){c[e]={loaded:0,total:0,finished:false}}return function(h,j){c[e].loaded=h;c[e].total=j;var f=0,g=0;for(var i in c){f+=c[i].loaded;g+=c[i].total}if(g>0){if(f==g){core.loader._setStartLoadTipText("正在处理资源文件... 请稍候...")}else{core.loader._setStartLoadTipText("正在加载资源文件... "+core.formatSize(f)+" / "+core.formatSize(g)+" ("+(f/g*100).toFixed(2)+"%)")}core.loader._setStartProgressVal(f/g*100)}}};var a=function(e){return function(){setTimeout(function(){c[e].finished=true;for(var f in c){if(!c[f].finished){return}}d()})}};this._loadAnimates_async(b("animates"),a("animates"));this._loadMusic_async(b("sounds"),a("sounds"));this._loadMaterials_async(b("materials"),a("materials"));this._loadExtraImages_async(b("images"),a("images"));this._loadAutotiles_async(b("autotiles"),a("autotiles"));this._loadTilesets_async(b("tilesets"),a("tilesets"))};loader.prototype._loadMaterials_sync=function(a){this._setStartLoadTipText("正在加载资源文件...");this.loadImages("materials",core.materials,core.material.images,function(){core.loader._loadMaterials_afterLoad();a()})};loader.prototype._loadMaterials_async=function(b,a){this.loadImagesFromZip("project/materials/materials.h5data",core.materials,core.material.images,b,function(){core.loader._loadMaterials_afterLoad();a()})};loader.prototype._loadMaterials_afterLoad=function(){var a=core.splitImage(core.material.images.icons);for(var b in core.statusBar.icons){if(typeof core.statusBar.icons[b]=="number"){core.statusBar.icons[b]=a[core.statusBar.icons[b]];if(core.statusBar.image[b]!=null){core.statusBar.image[b].src=core.statusBar.icons[b].src}}}};loader.prototype._loadExtraImages_sync=function(a){core.material.images.images={};this._setStartLoadTipText("正在加载图片文件...");core.loadImages("images",core.images,core.material.images.images,a)};loader.prototype._loadExtraImages_async=function(d,c){core.material.images.images={};var b=core.images;var a=b.filter(function(e){return e.toLowerCase().endsWith(".gif")});b=b.filter(function(e){return !e.toLowerCase().endsWith(".gif")});this.loadImagesFromZip("project/images/images.h5data",b,core.material.images.images,d,c);a.forEach(function(e){this.loadImage("images",e,function(f,g){if(g!=null){core.material.images.images[e]=g}})},this)};loader.prototype._loadAutotiles_sync=function(b){core.material.images.autotile={};var c=Object.keys(core.material.icons.autotile);var a={};this._setStartLoadTipText("正在加载自动元件...");this.loadImages("autotiles",c,a,function(){core.loader._loadAutotiles_afterLoad(c,a);b()})};loader.prototype._loadAutotiles_async=function(d,c){core.material.images.autotile={};var b=Object.keys(core.material.icons.autotile);var a={};this.loadImagesFromZip("project/autotiles/autotiles.h5data",b,a,d,function(){core.loader._loadAutotiles_afterLoad(b,a);c()})};loader.prototype._loadAutotiles_afterLoad=function(b,a){b.forEach(function(c){core.material.images.autotile[c]=a[c]});setTimeout(function(){core.maps._makeAutotileEdges()})};loader.prototype._loadTilesets_sync=function(a){core.material.images.tilesets={};this._setStartLoadTipText("正在加载额外素材...");this.loadImages("tilesets",core.tilesets,core.material.images.tilesets,function(){core.loader._loadTilesets_afterLoad();a()})};loader.prototype._loadTilesets_async=function(b,a){core.material.images.tilesets={};this.loadImagesFromZip("project/tilesets/tilesets.h5data",core.tilesets,core.material.images.tilesets,b,function(){core.loader._loadTilesets_afterLoad();a()})};loader.prototype._loadTilesets_afterLoad=function(){for(var b in core.material.images.tilesets){var a=core.material.images.tilesets[b];if(a.width%32!=0||a.height%32!=0){console.warn("警告！"+b+"的宽或高不是32的倍数！")}if(a.width*a.height>32*32*3000){console.warn("警告！"+b+"上的图块素材个数大于3000！")}}};loader.prototype.loadImages=function(b,e,f,a){if(!e||e.length==0){if(a){a()}return}var d=0;for(var c=0;c<e.length;c++){this.loadImage(b,e[c],function(g,h){core.loader._setStartLoadTipText("正在加载图片 "+g+"...");if(f[g]!==undefined){if(h!=null){f[g]=h}return}f[g]=h;d++;core.loader._setStartProgressVal(d*(100/e.length));if(d==e.length){if(a){a()}}})}};loader.prototype.loadImage=function(b,f,a){try{var g=f;if(g.indexOf(".")<0){g=g+".png"}var d=new Image();d.onload=function(){d.setAttribute("_width",d.width);d.setAttribute("_height",d.height);a(f,d)};d.onerror=function(){a(f,null)};d.src="project/"+b+"/"+g+"?v="+main.version;if(g.endsWith(".gif")){a(f,null)}}catch(c){console.error(c)}};loader.prototype.loadImagesFromZip=function(e,a,d,c,b){if(!a||a.length==0){if(b){b()}return}core.unzip(e+"?v="+main.version,function(g){var f=1;a.forEach(function(j){var i=j;if(i.indexOf(".")<0){i+=".png"}if(i in g){var h=new Image();var k=URL.createObjectURL(g[i]);f++;h.onload=function(){f--;URL.revokeObjectURL(k);h.setAttribute("_width",h.width);h.setAttribute("_height",h.height);if(f==0&&b){b()}};h.src=k;d[j]=h}});f--;if(f==0&&b){b()}},null,false,c)};loader.prototype._loadAnimates_sync=function(){this._setStartLoadTipText("正在加载动画文件...");if(main.supportBunch){if(core.animates.length>0){core.http("GET","__all_animates__?v="+main.version+"&id="+core.animates.join(","),null,function(a){var c=a.split("@@@~~~###~~~@@@");for(var b=0;b<core.animates.length;++b){if(c[b]!=""){core.material.animates[core.animates[b]]=core.loader._loadAnimate(c[b])}else{console.error("无法找到动画文件"+core.animates[b]+"！")}}},"text/plain; charset=x-user-defined")}return}core.animates.forEach(function(a){core.http("GET","project/animates/"+a+".animate?v="+main.version,null,function(b){core.material.animates[a]=core.loader._loadAnimate(b)},function(b){console.error(b);core.material.animates[a]=null},"text/plain; charset=x-user-defined")})};loader.prototype._loadAnimates_async=function(b,a){core.unzip("project/animates/animates.h5data?v="+main.version,function(c){for(var d in c){if(d.endsWith(".animate")){var e=d.substring(0,d.length-8);if(core.animates.indexOf(e)>=0){core.material.animates[e]=core.loader._loadAnimate(c[d])}}}a()},null,true,b)};loader.prototype._loadAnimate=function(a){try{a=JSON.parse(a);var b={};b.ratio=a.ratio;b.se=a.se;b.pitch=a.pitch;b.images=[];a.bitmaps.forEach(function(g){if(!g){b.images.push(null)}else{try{var f=new Image();f.src=g;b.images.push(f)}catch(d){console.error(d);b.images.push(null)}}});b.frame=a.frame_max;b.frames=[];a.frames.forEach(function(e){var d=[];e.forEach(function(f){d.push({index:f[0],x:f[1],y:f[2],zoom:f[3],opacity:f[4],mirror:f[5]||0,angle:f[6]||0,})});b.frames.push(d)});return b}catch(c){console.error(c);return null}};loader.prototype._loadMusic_sync=function(){this._setStartLoadTipText("正在加载音效文件...");core.bgms.forEach(function(a){core.loader.loadOneMusic(a)});core.sounds.forEach(function(a){core.loader.loadOneSound(a)});core.playBgm(main.startBgm)};loader.prototype._loadMusic_async=function(b,a){core.bgms.forEach(function(c){core.loader.loadOneMusic(c)});core.unzip("project/sounds/sounds.h5data?v="+main.version,function(c){setTimeout(function(){for(var d in c){if(core.sounds.indexOf(d)>=0){core.loader._loadOneSound_decodeData(d,c[d])}}});a()},null,false,b);core.playBgm(main.startBgm)};loader.prototype.loadOneMusic=function(b){var a=new Audio();a.preload="none";if(main.bgmRemote){a.src=main.bgmRemoteRoot+core.firstData.name+"/"+b}else{a.src="project/bgms/"+b}a.loop="loop";core.material.bgms[b]=a};loader.prototype.loadOneSound=function(a){core.http("GET","project/sounds/"+a+"?v="+main.version,null,function(b){core.loader._loadOneSound_decodeData(a,b)},function(b){console.error(b);core.material.sounds[a]=null},null,"arraybuffer")};loader.prototype._loadOneSound_decodeData=function(d,b){if(b instanceof Blob){var a=new zip.BlobReader(b);a.init(function(){a.readUint8Array(0,a.size,function(e){core.loader._loadOneSound_decodeData(d,e.buffer)})});return}try{core.musicStatus.audioContext.decodeAudioData(b,function(e){core.material.sounds[d]=e},function(f){console.error(f);core.material.sounds[d]=null})}catch(c){console.error(c);core.material.sounds[d]=null}};loader.prototype.loadBgm=function(b){b=core.getMappedName(b);if(!core.material.bgms[b]){return}if(!core.musicStatus.bgmStatus){return}var a=core.musicStatus.cachedBgms.indexOf(b);if(a>=0){core.musicStatus.cachedBgms.splice(a,1)}else{this._preloadBgm(core.material.bgms[b]);if(core.musicStatus.cachedBgms.length==core.musicStatus.cachedBgmCount){this.freeBgm(core.musicStatus.cachedBgms.pop())}}core.musicStatus.cachedBgms.unshift(b)};loader.prototype._preloadBgm=function(a){a.volume=0;a.play()};loader.prototype.freeBgm=function(a){a=core.getMappedName(a);if(!core.material.bgms[a]){return}core.musicStatus.cachedBgms=core.musicStatus.cachedBgms.filter(function(b){return b!=a});core.material.bgms[a].removeAttribute("src");core.material.bgms[a].load();core.material.bgms[a]=null;if(a==core.musicStatus.playingBgm){core.musicStatus.playingBgm=null}setTimeout(function(){core.loader.loadOneMusic(a)},3000)};"use strict";function utils(){this._init();this.scan={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};this.scan2={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0},leftup:{x:-1,y:-1},leftdown:{x:-1,y:1},rightup:{x:1,y:-1},rightdown:{x:1,y:1}}}utils.prototype._init=function(){};utils.prototype.replaceText=function(e,d){if(typeof e!="string"){return e}var c=e.indexOf("${");if(c<0){return e}var a=0,b=c;while(++b<e.length){if(e.charAt(b)=="{"){a++}if(e.charAt(b)=="}"){a--}if(a==0){break}}if(a!=0){return e}var f=core.calValue(e.substring(c+2,b),d);if(f==null){f=""}return e.substring(0,c)+f+core.replaceText(e.substring(b+1),d)};utils.prototype.replaceValue=function(a){if(typeof a=="string"&&(a.indexOf(":")>=0||a.indexOf("flag：")>=0||a.indexOf("global：")>=0)){if(a.indexOf("status:")>=0){a=a.replace(/status:([a-zA-Z0-9_]+)/g,"core.getStatus('$1')")}if(a.indexOf("buff:")>=0){a=a.replace(/buff:([a-zA-Z0-9_]+)/g,"core.getBuff('$1')")}if(a.indexOf("item:")>=0){a=a.replace(/item:([a-zA-Z0-9_]+)/g,"core.itemCount('$1')")}if(a.indexOf("flag:")>=0||a.indexOf("flag：")>=0){a=a.replace(/flag[:：]([a-zA-Z0-9_\u4E00-\u9FCC\u3040-\u30FF\u2160-\u216B\u0391-\u03C9]+)/g,"core.getFlag('$1', 0)")}if(a.indexOf("global:")>=0||a.indexOf("global：")>=0){a=a.replace(/global[:：]([a-zA-Z0-9_\u4E00-\u9FCC\u3040-\u30FF\u2160-\u216B\u0391-\u03C9]+)/g,"core.getGlobal('$1', 0)")}if(a.indexOf("enemy:")>=0){a=a.replace(/enemy:([a-zA-Z0-9_]+)[\.:]([a-zA-Z0-9_]+)/g,"core.material.enemys['$1'].$2")}if(a.indexOf("blockId:")>=0){a=a.replace(/blockId:(\d+),(\d+)/g,"core.getBlockId($1, $2)")}if(a.indexOf("blockNumber:")>=0){a=a.replace(/blockNumber:(\d+),(\d+)/g,"core.getBlockNumber($1, $2)")}if(a.indexOf("blockCls:")>=0){a=a.replace(/blockCls:(\d+),(\d+)/g,"core.getBlockCls($1, $2)")}if(a.indexOf("equip:")>=0){a=a.replace(/equip:(\d)/g,"core.getEquip($1)")}if(a.indexOf("temp:")>=0){a=a.replace(/temp:([a-zA-Z0-9_]+)/g,"core.getFlag('@temp@$1', 0)")}}return a};utils.prototype.calValue=function(value,prefix){if(!core.isset(value)){return null}if(typeof value==="string"){if(value.indexOf(":")>=0||value.indexOf("flag：")>=0||value.indexOf("global：")>=0){if(value.indexOf("switch:")>=0){value=value.replace(/switch:([a-zA-Z0-9_]+)/g,"core.getFlag('"+(prefix||":f@x@y")+"@$1', 0)")}value=this.replaceValue(value)}return eval(value)}if(value instanceof Function){return value()}return value};utils.prototype.unshift=function(c,d){if(!(c instanceof Array)||d==null){return}if(d instanceof Array){core.clone(d).reverse().forEach(function(a){c.unshift(a)})}else{c.unshift(d)}return c};utils.prototype.push=function(c,d){if(!(c instanceof Array)||d==null){return}if(d instanceof Array){core.clone(d).forEach(function(a){c.push(a)})}else{c.push(d)}return c};utils.prototype.decompress=function(c){try{var b=lzw_decode(c);if(b){return JSON.parse(b)}}catch(a){}try{var b=LZString.decompress(c);if(b){return JSON.parse(b)}}catch(a){}try{return JSON.parse(c)}catch(a){console.error(a)}return null};utils.prototype.setLocalStorage=function(b,d){try{if(d==null){this.removeLocalStorage(b);return}var c=JSON.stringify(d).replace(/[\u007F-\uFFFF]/g,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).substr(-4)});localStorage.setItem(core.firstData.name+"_"+b,c);if(b=="autoSave"){core.saves.ids[0]=true}else{if(/^save\d+$/.test(b)){core.saves.ids[parseInt(b.substring(4))]=true}}return true}catch(a){console.error(a);return false}};utils.prototype.getLocalStorage=function(c,a){try{var d=JSON.parse(localStorage.getItem(core.firstData.name+"_"+c));if(d==null){return a}return d}catch(b){return a}};utils.prototype.removeLocalStorage=function(a){localStorage.removeItem(core.firstData.name+"_"+a);if(a=="autoSave"){delete core.saves.ids[0]}else{if(/^save\d+$/.test(a)){delete core.saves.ids[parseInt(a.substring(4))]}}};utils.prototype.setLocalForage=function(c,g,f,b){if(g==null){this.removeLocalForage(c);return}var d=core.firstData.name+"_"+c;var e=JSON.stringify(g).replace(/[\u007F-\uFFFF]/g,function(h){return"\\u"+("0000"+h.charCodeAt(0).toString(16)).substr(-4)});var a=function(h){if(h){if(b){b(h)}}else{if(c=="autoSave"){core.saves.ids[0]=true}else{if(/^save\d+$/.test(c)){core.saves.ids[parseInt(c.substring(4))]=true}}if(f){f()}}};this._setLocalForage_set(d,e,a)};utils.prototype._setLocalForage_set=function(d,e,a){if(window.jsinterface&&window.jsinterface.setLocalForage){var c=setTimeout(null);core["__callback"+c]=a;core.saves.cache[d]=e;window.jsinterface.setLocalForage(c,d,e)}else{var b=e.length>100000?LZString.compress(e):lzw_encode(e);core.saves.cache[d]=b;localforage.setItem(d,b,a)}};utils.prototype.getLocalForage=function(d,b,f,c){var e=core.firstData.name+"_"+d;var a=function(g,i){if(g){if(c){c(g)}}else{core.saves.cache[e]=i;if(!f){return}if(i!=null){var h=core.utils.decompress(i);f(h==null?b:h);return}f(b)}};if(core.saves.cache[e]!=null){return a(null,core.saves.cache[e])}this._getLocalForage_get(e,a)};utils.prototype._getLocalForage_get=function(c,a){if(window.jsinterface&&window.jsinterface.getLocalForage){var b=setTimeout(null);core["__callback"+b]=a;window.jsinterface.getLocalForage(b,c)}else{localforage.getItem(c,a)}};utils.prototype.removeLocalForage=function(c,e,b){var d=core.firstData.name+"_"+c;var a=function(f){if(f){if(b){b(f)}}else{if(c=="autoSave"){delete core.saves.ids[0]}else{if(/^save\d+$/.test(c)){delete core.saves.ids[parseInt(c.substring(4))]}}if(e){e()}}};delete core.saves.cache[d];this._removeLocalForage_remove(d,a)};utils.prototype._removeLocalForage_remove=function(c,a){if(window.jsinterface&&window.jsinterface.removeLocalForage){var b=setTimeout(null);core["__callback"+b]=a;window.jsinterface.removeLocalForage(b,c)}else{localforage.removeItem(c,a)}};utils.prototype.clearLocalForage=function(a){core.saves.cache={};if(window.jsinterface&&window.jsinterface.clearLocalForage){var b=setTimeout(null);core["__callback"+b]=a;window.jsinterface.clearLocalForage(b)}else{localforage.clear(a)}};utils.prototype.iterateLocalForage=function(c,a){if(window.jsinterface&&window.jsinterface.iterateLocalForage){var b=setTimeout(null);core["__iter"+b]=c;core["__callback"+b]=a;window.jsinterface.iterateLocalForage(b)}else{localforage.iterate(c,a)}};utils.prototype.keysLocalForage=function(a){if(window.jsinterface&&window.jsinterface.keysLocalForage){var b=setTimeout(null);core["__callback"+b]=a;window.jsinterface.keysLocalForage(b)}else{localforage.keys(a)}};utils.prototype.lengthLocalForage=function(a){if(window.jsinterface&&window.jsinterface.lengthLocalForage){var b=setTimeout(null);core["__callback"+b]=a;window.jsinterface.lengthLocalForage(b)}else{localforage.length(a)}};utils.prototype.setGlobal=function(a,b){if(core.isReplaying()){return}core.setLocalStorage(a,b)};utils.prototype.getGlobal=function(c,b){var d;if(core.isReplaying()){var a=core.status.replay.toReplay.shift();if(a.indexOf("input2:")==0){d=JSON.parse(core.decodeBase64(a.substring(7)));core.setFlag("__global__"+c,d);core.status.route.push("input2:"+core.encodeBase64(JSON.stringify(d)))}else{core.status.replay.toReplay.unshift(a);d=core.getFlag("__global__"+c,core.getLocalStorage(c,b))}}else{d=core.getLocalStorage(c,b);core.setFlag("__global__"+c,d);core.status.route.push("input2:"+core.encodeBase64(JSON.stringify(d)))}return d};utils.prototype.clone=function(b,c,e){if(!core.isset(b)){return null}if(b instanceof Date){var a=new Date();a.setTime(b.getTime());return a}if(b instanceof Array){var a=[];for(var d in b){if(!c||c(d,b[d])){a[d]=core.clone(b[d],e?c:null,e)}}return a}if(b instanceof Function){return b}if(b instanceof Object){var a={};for(var d in b){if(b.hasOwnProperty(d)&&(!c||c(d,b[d]))){a[d]=core.clone(b[d],e?c:null,e)}}return a}return b};utils.prototype.cloneArray=function(a){if(!(a instanceof Array)){return this.clone(a)}if(a[0] instanceof Array){return a.map(function(b){return b.slice()})}else{return a.slice()}};utils.prototype.splitImage=function(g,n,e){if(typeof g=="string"){g=core.getMappedName(g);g=core.material.images.images[g]}if(!g){return[]}n=n||32;e=e||n;var b=document.createElement("canvas");var c=b.getContext("2d");var a=[];for(var l=0;l<g.height;l+=e){for(var f=0;f<g.width;f+=n){var m=Math.min(n,g.width-f),d=Math.min(e,g.height-l);b.width=m;b.height=d;core.drawImage(c,g,f,l,m,d,0,0,m,d);var k=new Image();k.src=b.toDataURL("image/png");a.push(k)}}return a};utils.prototype.formatDate=function(a){if(!a){a=new Date()}return""+a.getFullYear()+"-"+core.setTwoDigits(a.getMonth()+1)+"-"+core.setTwoDigits(a.getDate())+" "+core.setTwoDigits(a.getHours())+":"+core.setTwoDigits(a.getMinutes())+":"+core.setTwoDigits(a.getSeconds())};utils.prototype.formatDate2=function(a){if(!a){a=new Date()}return""+a.getFullYear()+core.setTwoDigits(a.getMonth()+1)+core.setTwoDigits(a.getDate())+core.setTwoDigits(a.getHours())+core.setTwoDigits(a.getMinutes())+core.setTwoDigits(a.getSeconds())};utils.prototype.formatTime=function(a){return core.setTwoDigits(parseInt(a/3600000))+":"+core.setTwoDigits(parseInt(a/60000)%60)+":"+core.setTwoDigits(parseInt(a/1000)%60)};utils.prototype.setTwoDigits=function(a){return(parseInt(a)<10&&parseInt(a)>=0)?"0"+a:a};utils.prototype.formatSize=function(a){if(a<1024){return a+"B"}else{if(a<1024*1024){return(a/1024).toFixed(2)+"KB"}else{return(a/1024/1024).toFixed(2)+"MB"}}};utils.prototype.formatBigNumber=function(g,a){if(a===true){a=5}if(!a||a<5){a=6}g=Math.trunc(parseFloat(g));if(g==null||!Number.isFinite(g)){return"???"}var f=[{val:10000,suffix:"w"},{val:100000000,suffix:"e"},{val:1000000000000,suffix:"z"},{val:1e+16,suffix:"j"},{val:1e+20,suffix:"g"},];if(Math.abs(g)>1e+20*Math.pow(10,a-2)){return g.toExponential(0)}var d=g<0?"-":"";if(d){--a}g=Math.abs(g);if(g<Math.pow(10,a)){return d+g}for(var c=0;c<f.length;++c){var b=f[c];var e=(g/b.val).toFixed(a).substring(0,a);if(e.indexOf(".")<0){continue}e=e.substring(0,e[e.length-2]=="."?e.length-2:e.length-1);return d+e+b.suffix}return d+g.toExponential(0)};utils.prototype.applyEasing=function(c){var b={easeIn:function(d){return Math.pow(d,3)},easeOut:function(d){return 1-Math.pow(1-d,3)},easeInOut:function(d){if(d<0.5){return Math.pow(d,2)*2}else{return 1-Math.pow(1-d,2)*2}},linear:function(d){return d}};if(c=="random"){var a=Object.keys(b);c=a[Math.floor(Math.random()*a.length)]}return b[c]||b.linear};utils.prototype.arrayToRGB=function(a){if(!(a instanceof Array)){return a}var d=this.clamp(parseInt(a[0]),0,255),c=this.clamp(parseInt(a[1]),0,255),b=this.clamp(parseInt(a[2]),0,255);return"#"+((1<<24)+(d<<16)+(c<<8)+b).toString(16).slice(1)};utils.prototype.arrayToRGBA=function(a){if(!(a instanceof Array)){return a}if(a[3]==null){a[3]=1}var e=this.clamp(parseInt(a[0]),0,255),d=this.clamp(parseInt(a[1]),0,255),c=this.clamp(parseInt(a[2]),0,255),b=this.clamp(parseFloat(a[3]),0,1);return"rgba("+e+","+d+","+c+","+b+")"};utils.prototype.encodeRoute=function(d){var a="",c="",b=0;d.forEach(function(e){if(e=="up"||e=="down"||e=="left"||e=="right"){if(e!=c&&b>0){a+=c.substring(0,1).toUpperCase();if(b>1){a+=b}b=0}c=e;b++}else{if(b>0){a+=c.substring(0,1).toUpperCase();if(b>1){a+=b}b=0}a+=core.utils._encodeRoute_encodeOne(e)}});if(b>0){a+=c.substring(0,1).toUpperCase();if(b>1){a+=b}}return LZString.compressToBase64(a)};utils.prototype._encodeRoute_id2number=function(a){var b=core.maps.getNumberById(a);return b==0?a:b};utils.prototype._encodeRoute_encodeOne=function(a){if(a.indexOf("item:")==0){return"I"+this._encodeRoute_id2number(a.substring(5))+":"}else{if(a.indexOf("unEquip:")==0){return"u"+a.substring(8)}else{if(a.indexOf("equip:")==0){return"e"+this._encodeRoute_id2number(a.substring(6))+":"}else{if(a.indexOf("saveEquip:")==0){return"s"+a.substring(10)}else{if(a.indexOf("loadEquip:")==0){return"l"+a.substring(10)}else{if(a.indexOf("fly:")==0){return"F"+a.substring(4)+":"}else{if(a=="choices:none"){return"c"}else{if(a.indexOf("choices:")==0){return"C"+a.substring(8)}else{if(a.indexOf("shop:")==0){return"S"+a.substring(5)+":"}else{if(a=="turn"){return"T"}else{if(a.indexOf("turn:")==0){return"t"+a.substring(5).substring(0,1).toUpperCase()+":"}else{if(a=="getNext"){return"G"}else{if(a=="input:none"){return"p"}else{if(a.indexOf("input:")==0){return"P"+a.substring(6)}else{if(a.indexOf("input2:")==0){return"Q"+a.substring(7)+":"}else{if(a=="no"){return"N"}else{if(a.indexOf("move:")==0){return"M"+a.substring(5)}else{if(a.indexOf("key:")==0){return"K"+a.substring(4)}else{if(a.indexOf("click:")==0){return"k"+a.substring(6)}else{if(a.indexOf("random:")==0){return"X"+a.substring(7)}}}}}}}}}}}}}}}}}}}}return"("+a+")"};utils.prototype.decodeRoute=function(c){if(!c){return c}try{var d=LZString.decompressFromBase64(c);if(d!=null&&/^[-_a-zA-Z0-9+\/=:()]*$/.test(d)){if(d!=""||c.length<8){c=d}}}catch(b){}var a={route:c,index:0,ans:[]};while(a.index<a.route.length){this._decodeRoute_decodeOne(a,a.route.charAt(a.index++))}return a.ans};utils.prototype._decodeRoute_getNumber=function(b,d){var e="";var c=true;while(true){var a=b.route.charAt(b.index);if(a>="0"&&a<="9"){e+=a}else{if(a=="-"&&c){e+=a}else{break}}c=false;b.index++}if(e.length==0){e="1"}return d?e:parseInt(e)};utils.prototype._decodeRoute_getString=function(a){var b="";while(a.index<a.route.length&&a.route.charAt(a.index)!=":"){b+=a.route.charAt(a.index++)}a.index++;return b};utils.prototype._decodeRoute_number2id=function(b){if(/^\d+$/.test(b)){var a=core.maps.blocksInfo[b];if(a){return a.id}}return b};utils.prototype._decodeRoute_decodeOne=function(b,a){if(a=="("){var e=b.route.indexOf(")",b.index);if(e>=0){b.ans.push(b.route.substring(b.index,e));b.index=e+1;return}}var g=(a=="I"||a=="e"||a=="F"||a=="S"||a=="Q"||a=="t")?this._decodeRoute_getString(b):this._decodeRoute_getNumber(b);var f={U:"up",D:"down",L:"left",R:"right"};switch(a){case"U":case"D":case"L":case"R":for(var d=0;d<g;d++){b.ans.push(f[a])}break;case"I":b.ans.push("item:"+this._decodeRoute_number2id(g));break;case"u":b.ans.push("unEquip:"+g);break;case"e":b.ans.push("equip:"+this._decodeRoute_number2id(g));break;case"s":b.ans.push("saveEquip:"+g);break;case"l":b.ans.push("loadEquip:"+g);break;case"F":b.ans.push("fly:"+g);break;case"c":b.ans.push("choices:none");break;case"C":b.ans.push("choices:"+g);break;case"S":b.ans.push("shop:"+g);break;case"T":b.ans.push("turn");break;case"t":b.ans.push("turn:"+f[g]);break;case"G":b.ans.push("getNext");break;case"p":b.ans.push("input:none");break;case"P":b.ans.push("input:"+g);break;case"Q":b.ans.push("input2:"+g);break;case"N":b.ans.push("no");break;case"M":++b.index;b.ans.push("move:"+g+":"+this._decodeRoute_getNumber(b));break;case"K":b.ans.push("key:"+g);break;case"k":++b.index;var h=this._decodeRoute_getNumber(b);++b.index;var j=this._decodeRoute_getNumber(b);b.ans.push("click:"+g+":"+h+":"+j);break;case"X":b.ans.push("random:"+g);break}};utils.prototype.isset=function(a){return a!=null&&!(typeof a=="number"&&isNaN(a))};utils.prototype.subarray=function(c,d){if(!(c instanceof Array)||!(d instanceof Array)||c.length<d.length){return null}for(var e=0;e<d.length;++e){if(c[e]!=d[e]){return null}}return c.slice(d.length)};utils.prototype.inArray=function(a,b){return(a instanceof Array)&&a.indexOf(b)>=0};utils.prototype.clamp=function(g,c,d){var f=Math.min(c,d),e=Math.max(c,d);return Math.min(Math.max(g||0,f),e)};utils.prototype.getCookie=function(b){var a=document.cookie.match(new RegExp("(^| )"+b+"=([^;]+)"));return a?a[2]:null};utils.prototype.setStatusBarInnerHTML=function(f,h,c){if(!core.statusBar[f]){return}if(typeof h=="number"){h=this.formatBigNumber(h)}var d=/^[-a-zA-Z0-9`~!@#$%^&*()_=+\[{\]}\\|;:'",<.>\/?]*$/.test(h);var g="font-style: "+(d?"italic":"normal")+"; ";g+="text-shadow: #000 1px 0 0, #000 0 1px 0, #000 -1px 0 0, #000 0 -1px 0; ";var e=this.strlen(h)||1;g+="font-size: "+Math.min(1,7/e)+"em; ";if(c){g+=c}var a=core.statusBar[f].getAttribute("_style");var b=core.statusBar[f].getAttribute("_value");if(a==g){if(h==b){return}core.statusBar[f].children[0].innerText=h}else{core.statusBar[f].innerHTML="<span class='_status' style='"+g+"'></span>";core.statusBar[f].children[0].innerText=h;core.statusBar[f].setAttribute("_style",g)}core.statusBar[f].setAttribute("_value",h)};utils.prototype.strlen=function(d){var a=0;for(var b=0,c=d.length;b<c;b++){a+=d.charCodeAt(b)<256?1:2}return a};utils.prototype.turnDirection=function(d,a){a=a||core.getHeroLoc("direction");var b=["left","leftup","up","rightup","right","rightdown","down","leftdown"];if(b.indexOf(d)>=0){return d}if(d==":hero"){return core.getHeroLoc("direction")}if(d==":backhero"){return this.turnDirection(":back",core.getHeroLoc("direction"))}if(typeof d==="number"&&d%45==0){d/=45}else{switch(d){case":left":d=6;break;case":right":d=2;break;case":back":d=4;break;default:d=0;break}}var c=b.indexOf(a);if(c<0){return a}return b[(c+(d||0))%b.length]};utils.prototype.matchWildcard=function(b,c){try{return new RegExp("^"+b.split(/\*+/).map(function(d){return d.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&")}).join(".*")+"$").test(c)}catch(a){return false}};utils.prototype.matchRegex=function(b,c){try{if(b.startsWith("^")){b=b.substring(1)}if(b.endsWith("$")){b=b.substring(0,b.length-1)}return new RegExp("^"+b+"$").test(c)}catch(a){return false}};utils.prototype.encodeBase64=function(a){return btoa(encodeURIComponent(a).replace(/%([0-9A-F]{2})/g,function(b,c){return String.fromCharCode(parseInt(c,16))}))};utils.prototype.decodeBase64=function(a){return decodeURIComponent(atob(a).split("").map(function(b){return"%"+("00"+b.charCodeAt(0).toString(16)).slice(-2)}).join(""))};utils.prototype.rand=function(b){var c=core.getFlag("__rand__");c=this.__next_rand(c);core.setFlag("__rand__",c);var a=c/2147483647;if(b&&b>0){return Math.floor(a*b)}return a};utils.prototype.rand2=function(b){b=b||2147483648;b=Math.abs(b);var c;if(core.isReplaying()){var a=core.status.replay.toReplay.shift();if(a.indexOf("random:")==0){c=parseInt(a.substring(7));if(isNaN(c)||c>=b||c<0){console.warn("错误！当前random:项超过范围。将重新随机生成！");c=Math.floor(Math.random()*b)}}else{console.warn("错误！当前需要一个random:项。将重新随机生成！");c=Math.floor(Math.random()*b)}}else{c=Math.floor(Math.random()*b)}core.status.route.push("random:"+c);return c};utils.prototype.__init_seed=function(){var a=new Date().getTime()%34834795+3534;a=this.__next_rand(a);a=this.__next_rand(a);a=this.__next_rand(a);core.setFlag("__seed__",a);core.setFlag("__rand__",a)};utils.prototype.__next_rand=function(a){a=(a%127773)*16807-~~(a/127773)*2836;a+=a<0?2147483647:0;return a};utils.prototype.readFile=function(d,b,a,c){core.platform.successCallback=d;core.platform.errorCallback=b;if(window.jsinterface){window.jsinterface.readFile();return}if(!core.platform.isOnline){alert("离线状态下不支持文件读取！");if(b){b()}return}if(core.platform.fileReader==null){alert("当前浏览器不支持FileReader！");if(b){b()}return}if(core.platform.fileInput==null){core.platform.fileInput=document.createElement("input");core.platform.fileInput.style.opacity=0;core.platform.fileInput.type="file";core.platform.fileInput.onchange=function(){var e=core.platform.fileInput.files;if(e.length==0){if(core.platform.errorCallback){core.platform.errorCallback()}return}if(!c){core.platform.fileReader.readAsText(core.platform.fileInput.files[0])}else{core.platform.fileReader.readAsDataURL(core.platform.fileInput.files[0])}core.platform.fileInput.value=""}}core.platform.fileInput.value="";if(a){core.platform.fileInput.accept=a}core.platform.fileInput.click()};utils.prototype.readFileContent=function(a){var c=null;if(a.slice(0,4)==="data"){if(core.platform.successCallback){core.platform.successCallback(a)}return}try{c=JSON.parse(LZString.decompressFromBase64(a))}catch(b){}if(!c){try{c=JSON.parse(a)}catch(b){console.error(b)}}if(c){if(core.platform.successCallback){core.platform.successCallback(c)}return}if(core.platform.errorCallback){core.platform.errorCallback()}};utils.prototype.download=function(d,b){if(window.jsinterface){window.jsinterface.download(d,b);return}if(!core.platform.isOnline){alert("离线状态下不支持下载操作！");return}if(core.platform.isIOS){if(core.copy(b)){alert("iOS平台下不支持直接下载文件！\n所有应下载内容已经复制到您的剪切板，请自行创建空白文件并粘贴。")}else{alert("iOS平台下不支持下载操作！")}return}if(!core.platform.isPC){if(!core.platform.isChrome||core.platform.isQQ||core.platform.isWeChat){if(core.copy(b)){alert("移动端只有Chrome浏览器支持直接下载文件！\n所有应下载内容已经复制到您的剪切板，请自行创建空白文件并粘贴。")}else{alert("该平台或浏览器暂不支持下载操作！")}return}}if(core.platform.isSafari){alert("你当前使用的是Safari浏览器，不支持直接下载文件。\n即将打开一个新窗口为应下载内容，请自行全选复制然后创建空白文件并粘贴。");var a=new Blob([b],{type:"text/plain;charset=utf-8"});var e=window.URL.createObjectURL(a);var f=window.open(e,"_blank");window.URL.revokeObjectURL(e);return}var a=new Blob([b],{type:"text/plain;charset=utf-8"});if(window.navigator.msSaveOrOpenBlob){window.navigator.msSaveBlob(a,d)}else{var e=window.URL.createObjectURL(a);var c=window.document.createElement("a");c.href=e;c.download=d;document.body.appendChild(c);c.click();document.body.removeChild(c);window.URL.revokeObjectURL(e)}};utils.prototype.copy=function(a){if(window.jsinterface){window.jsinterface.copy(a);return true}if(!core.platform.supportCopy){return false}var d=document.createElement("textarea");d.style.position="fixed";d.style.top=0;d.style.left=0;d.style.width="2em";d.style.height="2em";d.style.padding=0;d.style.border="none";d.style.outline="none";d.style.boxShadow="none";d.style.background="transparent";d.value=a;document.body.appendChild(d);d.focus();d.setSelectionRange(0,d.value.length);var c=false;try{c=document.execCommand("copy")}catch(b){c=false}document.body.removeChild(d);return c};utils.prototype.myconfirm=function(a,c,b){main.dom.inputDiv.style.display="block";main.dom.inputMessage.innerHTML=a.replace(/\n/g,"<br/>");main.dom.inputBox.style.display="none";main.dom.inputYes.blur();main.dom.inputNo.blur();core.status.holdingKeys=[];core.platform.successCallback=c;core.platform.errorCallback=b};utils.prototype.myprompt=function(b,c,a){main.dom.inputDiv.style.display="block";main.dom.inputMessage.innerHTML=b.replace(/\n/g,"<br/>");main.dom.inputBox.style.display="block";main.dom.inputBox.value=c==null?"":c;main.dom.inputYes.blur();main.dom.inputNo.blur();setTimeout(function(){main.dom.inputBox.focus()});core.status.holdingKeys=[];core.platform.successCallback=core.platform.errorCallback=a};utils.prototype.showWithAnimate=function(b,e,a){b.style.display="block";if(!e||main.mode!="play"){b.style.opacity=1;if(a){a()}return}b.style.opacity=0;var c=0;var d=window.setInterval(function(){c+=0.03;b.style.opacity=c;if(c>1){clearInterval(d);if(a){a()}}},e)};utils.prototype.hideWithAnimate=function(c,e,a){if(!e||main.mode!="play"){c.style.display="none";if(a){a()}return}c.style.opacity=1;var d=1;var b=window.setInterval(function(){d-=0.03;c.style.opacity=d;if(d<0){c.style.display="none";clearInterval(b);if(a){a()}}},e)};utils.prototype.getGuid=function(){var a=localStorage.getItem("guid");if(a!=null){return a}a="xxxxxxxx_xxxx_4xxx_yxxx_xxxxxxxxxxxx".replace(/[xy]/g,function(b){var d=Math.random()*16|0,e=b=="x"?d:(d&3|8);return e.toString(16)});localStorage.setItem("guid",a);return a};utils.prototype.hashCode=function(d){if(typeof d=="string"){var b=0,c,a;if(d.length===0){return b}for(c=0;c<d.length;c++){a=d.charCodeAt(c);b=((b<<5)-b)+a;b|=0}return b}return this.hashCode(JSON.stringify(d).split("").sort().join(""))};utils.prototype.same=function(c,d){if(c==null&&d==null){return true}if(c==null||d==null){return false}if(c===d){return true}if(c instanceof Array&&d instanceof Array){if(c.length!=d.length){return false}for(var e=0;e<c.length;e++){if(!this.same(c[e],d[e])){return false}}return true}if(c instanceof Object&&d instanceof Object){var f={};for(var e in c){f[e]=true}for(var e in d){f[e]=true}for(var e in f){if(!this.same(c[e],d[e])){return false}}return true}return false};utils.prototype.unzip=function(b,f,d,c,e){var a=function(g){console.error(g);if(d){d(g)}};if(!window.zip){return a("zip.js not exists!")}if(typeof b=="string"){return core.http("GET",b,null,function(g){core.unzip(g,f,d,c)},a,null,"blob",e)}if(!(b instanceof Blob)){return a("Should use Blob or URL as input")}zip.createReader(new zip.BlobReader(b),function(g){g.getEntries(function(h){core.utils._unzip_readEntries(h,function(i){g.close(function(){if(f){f(i)}})},c)})},a)};utils.prototype._unzip_readEntries=function(b,e,a){var d={};if(b==null||b.length==0){return e(d)}var c=b.length;b.forEach(function(f){f.getData(a?new zip.TextWriter("utf8"):new zip.BlobWriter(),function(g){d[f.filename]=g;c--;if(c==0){e(d)}})})};utils.prototype.http=function(g,h,b,f,a,c,e,d){var i=new XMLHttpRequest();i.open(g,h,true);if(c){i.overrideMimeType(c)}if(e){i.responseType=e}i.onload=function(j){if(i.status==200){if(f){f(i.response)}}else{if(a){a("HTTP "+i.status)}}};i.onprogress=function(j){if(j.lengthComputable){if(d){d(j.loaded,j.total)}}};i.onabort=function(){if(a){a("Abort")}};i.ontimeout=function(){if(a){a("Timeout")}};i.onerror=function(){if(a){a("Error on Connection")}};if(b){i.send(b)}else{i.send()}};function lzw_encode(h){var d={};var c=(h+"").split("");var f=[];var b;var g=c[0];var a=256;for(var e=1;e<c.length;e++){b=c[e];if(d[g+b]!=null){g+=b}else{f.push(g.length>1?d[g]:g.charCodeAt(0));d[g+b]=a;a++;g=b}}f.push(g.length>1?d[g]:g.charCodeAt(0));for(var e=0;e<f.length;e++){f[e]=String.fromCharCode(f[e])}return f.join("")}function lzw_decode(k){var e={};var d=(k+"").split("");var b=d[0];var g=b;var h=[b];var a=256;var j;for(var f=1;f<d.length;f++){var c=d[f].charCodeAt(0);if(c<256){j=d[f]}else{j=e[c]?e[c]:(g+b)}h.push(j);b=j.charAt(0);e[a]=g+b;a++;g=j}return h.join("")};"use strict";function items(){this._init()}items.prototype._init=function(){this.items=items_296f5d02_12fd_4166_a7c1_b5e830c9ee3a;for(var a in this.items){this.items[a].id=a}};items.prototype.getItems=function(){var c=core.clone(this.items);var a=core.getFlag("equipInfo");if(a){for(var b in a){c[b].equip=core.clone(a[b])}}return c};items.prototype.getItemEffect=function(itemId,itemNum){var itemCls=core.material.items[itemId].cls;if(itemCls==="items"){var curr_hp=core.status.hero.hp;var itemEffect=core.material.items[itemId].itemEffect;if(itemEffect){try{for(var i=0;i<itemNum;++i){eval(itemEffect)}}catch(e){console.error(e)}}core.status.hero.statistics.hp+=core.status.hero.hp-curr_hp;var useItemEvent=core.material.items[itemId].useItemEvent;if(useItemEvent){try{core.insertAction(useItemEvent)}catch(e){console.error(e)}}core.updateStatusBar(false,true)}else{core.addItem(itemId,itemNum)}};items.prototype.getItemEffectTip=function(d){var b=core.material.items[d].cls;if(b==="items"){var c=core.material.items[d].itemEffectTip;if(c){try{return core.replaceText(c)||""}catch(a){console.error(a);return""}}}return""};items.prototype.useItem=function(b,c,a){if(!this.canUseItem(b)){if(a){a()}return}this._useItemEffect(b);this._afterUseItem(b);if(!c){core.status.route.push("item:"+b)}if(a){a()}};items.prototype._useItemEffect=function(itemId){var useItemEffect=core.material.items[itemId].useItemEffect;if(useItemEffect){try{eval(useItemEffect)}catch(e){console.error(e)}}var useItemEvent=core.material.items[itemId].useItemEvent;if(useItemEvent){try{core.insertAction(useItemEvent)}catch(e){console.error(e)}}};items.prototype._afterUseItem=function(b){var a=core.material.items[b].cls;if(a=="tools"){core.status.hero.items[a][b]--}if(core.status.hero.items[a][b]<=0){delete core.status.hero.items[a][b]}core.updateStatusBar(false,true)};items.prototype.canUseItem=function(itemId){if(!core.hasItem(itemId)){return false}var canUseItemEffect=core.material.items[itemId].canUseItemEffect;if(canUseItemEffect){try{return eval(canUseItemEffect)}catch(e){console.error(e);return false}}};items.prototype.itemCount=function(b){if(!core.material.items[b]||!core.isPlaying()){return 0}var a=core.material.items[b].cls;if(a=="items"){return 0}return core.status.hero.items[a][b]||0};items.prototype.hasItem=function(a){return this.itemCount(a)>0};items.prototype.hasEquip=function(b){if(!(core.material.items[b]||{}).equip||!core.isPlaying()){return null}for(var a in core.status.hero.equipment){if(core.status.hero.equipment[a]==b){return true}}return false};items.prototype.getEquip=function(a){return core.status.hero.equipment[a]||null};items.prototype.setItem=function(b,c){c=c||0;var a=core.material.items[b].cls;if(a=="items"){return}core.status.hero.items[a][b]=c;if(core.status.hero.items[a][b]<=0){delete core.status.hero.items[a][b]}core.updateStatusBar()};items.prototype.addItem=function(c,d){if(d==null){d=1}var b=core.material.items[c];var a=b.cls;if(a=="items"){return}if(core.status.hero.items[a][c]==null){core.status.hero.items[a][c]=0}core.status.hero.items[a][c]+=d;if(core.status.hero.items[a][c]<=0){delete core.status.hero.items[a][c]}if(a=="constants"&&core.status.hero.items[a][c]>1){core.status.hero.items[a][c]=1}core.updateStatusBar()};items.prototype.removeItem=function(b,c){if(c==null){c=1}if(!core.hasItem(b)){return false}var a=core.material.items[b].cls;core.status.hero.items[a][b]-=c;if(core.status.hero.items[a][b]<=0){delete core.status.hero.items[a][b]}core.updateStatusBar();return true};items.prototype.getEquipTypeByName=function(b){var c=core.status.globalAttribute.equipName;var d=[];for(var a=0;a<c.length;++a){if(c[a]===b){d.push(a);if(!core.status.hero.equipment[a]){return a}}}return d.length==1?d[0]:-1};items.prototype.getEquipTypeById=function(a){var b=core.material.items[a].equip.type;if(typeof b=="string"){b=this.getEquipTypeByName(b)}return b};items.prototype.canEquip=function(equipId,hint){var equip=core.material.items[equipId]||{};if(!equip.equip){if(hint){core.playSound("操作失败");core.drawTip("不合法的装备！")}return false}if(!core.hasItem(equipId)&&!core.hasEquip(equipId)){if(hint){core.playSound("操作失败");core.drawTip("你当前没有"+equip.name+"，无法换装")}return false}var canUseItemEffect=core.material.items[equipId].canUseItemEffect;if(canUseItemEffect){try{if(!eval(canUseItemEffect)){if(hint){core.playSound("操作失败");core.drawTip("当前不可换上"+equip.name)}return false}}catch(e){console.error(e);return false}}return true};items.prototype.loadEquip=function(b,a){if(!this.canEquip(b,true)){if(a){a()}return}var c=core.material.items[b]||{};var d=this.getEquipTypeById(b);if(d<0){core.playSound("操作失败");core.drawTip("当前没有"+c.equip.type+"的空位！");if(a){a()}return}this._realLoadEquip(d,b,core.status.hero.equipment[d],a)};items.prototype.unloadEquip=function(b,a){var c=core.status.hero.equipment[b];if(!c){if(a){a()}return}this._realLoadEquip(b,null,c,a)};items.prototype.compareEquipment=function(c,b){var g={value:{},percentage:{}};var d=core.material.items[c],h=core.material.items[b];for(var f in g){for(var e in core.status.hero){if(typeof core.status.hero[e]=="number"){var a=0;if(d){a+=((d.equip||{})[f]||{})[e]||0}if(h){a-=((h.equip||{})[f]||{})[e]||0}if(a!=0){g[f][e]=a}}}}return g};items.prototype._loadEquipEffect=function(a,d){var c=core.compareEquipment(a,d);for(var b in c.percentage){core.addBuff(b,c.percentage[b]/100)}for(var b in c.value){core.status.hero[b]+=c.value[b]}};items.prototype._realLoadEquip=function(d,c,f,a){var b=core.material.items[c]||{},e=core.material.items[f]||{};this._realLoadEquip_playSound();this._loadEquipEffect(c,f);if(c){core.removeItem(c)}if(f){core.addItem(f)}core.status.hero.equipment[d]=c||null;if(c){core.drawTip("已装备上"+b.name,c)}else{if(f){core.drawTip("已卸下"+e.name,f)}}if(a){a()}};items.prototype._realLoadEquip_playSound=function(){if(core.hasFlag("__quickLoadEquip__")){return}core.stopSound();core.playSound("穿脱装备")};items.prototype.quickSaveEquip=function(a){var b=core.getFlag("saveEquips",[]);b[a]=core.clone(core.status.hero.equipment);core.setFlag("saveEquips",b);core.status.route.push("saveEquip:"+a);core.drawTip("已保存"+a+"号套装")};items.prototype.quickLoadEquip=function(d){var a=core.getFlag("saveEquips",[])[d];if(!a){core.playSound("操作失败");core.drawTip(d+"号套装不存在");return}var b=core.status.globalAttribute.equipName.length;for(var c=0;c<b;c++){var h=a[c];if(h&&!this.canEquip(h,true)){return}}core.status.route.push("loadEquip:"+d);core.setFlag("__quickLoadEquip__",true);var g=[];for(var c=0;c<b;c++){var e=core.status.hero.equipment[c];var f=a[c];if(e!=f){g.push(f||null);if(e){this.unloadEquip(c)}}}for(var c in g){var f=g[c];if(f){this.loadEquip(f)}}core.removeFlag("__quickLoadEquip__");this._realLoadEquip_playSound();core.drawTip("成功换上"+d+"号套装")};items.prototype.setEquip=function(b,j,d,i,e,f){var a=core.material.items[b];if(!a||a.cls!="equips"){return}var c=a.equip||{};if(!c[j]){c[j]={}}var h=core.clone(c);h[j][d]=core.events._updateValueByOperator(core.calValue(i,f),c[j][d],e);if(core.hasEquip(b)){var g="temp:"+b;core.material.items[g]={cls:"equips",equip:core.clone(h)};this._loadEquipEffect(g,b);delete core.material.items[g];core.updateStatusBar()}a.equip=core.clone(h);flags.equipInfo=flags.equipInfo||{};flags.equipInfo[b]=core.clone(h)};"use strict";function icons(){this._init()}icons.prototype._init=function(){this.icons=icons_4665ee12_3a1f_44a4_bea3_0fccba634dc1;this.tilesetStartOffset=10000};icons.prototype.getIcons=function(){var a=core.clone(this.icons);a.hero.leftup=a.hero.leftdown=a.hero.left;a.hero.rightup=a.hero.rightdown=a.hero.right;return a};icons.prototype.getClsFromId=function(b){for(var a in core.material.icons){if(a!="hero"&&b in core.material.icons[a]){return a}}return null};icons.prototype.getAllIconIds=function(){if(this.allIconIds){return this.allIconIds}this.allIconIds=[];for(var a in this.icons){this.allIconIds=this.allIconIds.concat(Object.keys(this.icons[a]))}return this.allIconIds};icons.prototype._getAnimateFrames=function(a){if(a=="enemys"||a=="npcs"){return 2}if(a=="animates"||a=="enemy48"||a=="npc48"){return 4}return 1};icons.prototype.getTilesetOffset=function(c){if(typeof c=="string"){c=core.getIdOfThis(c);if(!/^X\d+$/.test(c)){return null}c=parseInt(c.substring(1))}else{if(typeof c!="number"){return null}}core.tilesets=core.tilesets||[];var f=this.tilesetStartOffset;for(var b in core.tilesets){var e=core.tilesets[b];var d=core.material.images.tilesets[e];var g=Math.floor(parseInt(d.getAttribute("_width"))/32),a=Math.floor(parseInt(d.getAttribute("_height"))/32);if(c>=f&&c<f+g*a){var h=(c-f)%g,j=parseInt((c-f)/g);return{image:e,x:h,y:j}}f+=this.tilesetStartOffset}return null};"use strict";function enemys(){this._init()}enemys.prototype._init=function(){this.enemys=enemys_fcae963b_31c9_42b4_b48c_bb48d09f3f80;this.enemydata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.enemys;for(var a in this.enemys){this.enemys[a].id=a}if(main.mode=="play"){this.enemydata.hasSpecial=function(c,d){return core.enemys.hasSpecial(c,d)}}};enemys.prototype.getEnemys=function(){var c=core.clone(this.enemys);var b=core.getFlag("enemyInfo");if(b){for(var d in b){for(var e in b[d]){c[d][e]=core.clone(b[d][e])}}}for(var d in c){if(c[d].faceIds){var a=c[d].faceIds.down;if(a!=null&&a!=d&&c[a]){c[d]={id:d};for(var f in c[a]){if(f!="id"&&c[a].hasOwnProperty(f)){(function(h,g,i){Object.defineProperty(c[h],i,{get:function(){return c[g][i]},set:function(j){c[g][i]=j},enumerable:true})})(d,a,f)}}}}}return c};enemys.prototype.hasSpecial=function(a,b){if(a==null){return false}if(a instanceof Array){return a.indexOf(b)>=0}if(typeof a=="number"){return a===b}if(typeof a=="string"){return this.hasSpecial(core.material.enemys[a],b)}if(a.special!=null){return this.hasSpecial(a.special,b)}return false};enemys.prototype.getSpecials=function(){return this.enemydata.getSpecials()};enemys.prototype.getSpecialText=function(a){if(typeof a=="string"){a=core.material.enemys[a]}if(!a){return[]}var c=a.special;var e=[];var d=this.getSpecials();if(d){for(var b=0;b<d.length;b++){if(this.hasSpecial(c,d[b][0])){e.push(this._calSpecialContent(a,d[b][1]))}}}return e};enemys.prototype.getSpecialColor=function(b){if(typeof b=="string"){b=core.material.enemys[b]}if(!b){return[]}var d=b.special;var a=[];var e=this.getSpecials();if(e){for(var c=0;c<e.length;c++){if(this.hasSpecial(d,e[c][0])){a.push(e[c][3]||null)}}}return a};enemys.prototype.getSpecialFlag=function(a){if(typeof a=="string"){a=core.material.enemys[a]}if(!a){return[]}var d=a.special;var b=0;var e=this.getSpecials();if(e){for(var c=0;c<e.length;c++){if(this.hasSpecial(d,e[c][0])){b|=(e[c][4]||0)}}}return b};enemys.prototype.getSpecialHint=function(a,d){var e=this.getSpecials();if(d==null){if(e==null){return[]}var b=[];for(var c=0;c<e.length;c++){if(this.hasSpecial(a,e[c][0])){b.push("\r["+core.arrayToRGBA(e[c][3]||"#FF6A6A")+"]\\d"+this._calSpecialContent(a,e[c][1])+"：\\d\r[]"+this._calSpecialContent(a,e[c][2]))}}return b}if(e==null){return""}for(var c=0;c<e.length;c++){if(d==e[c][0]){return"\r[#FF6A6A]\\d"+this._calSpecialContent(a,e[c][1])+"：\\d\r[]"+this._calSpecialContent(a,e[c][2])}}return""};enemys.prototype._calSpecialContent=function(b,a){if(typeof a=="string"){return a}if(typeof b=="string"){b=core.material.enemys[b]}if(a instanceof Function){return a(b)}return""};enemys.prototype.getEnemyValue=function(b,d,e,f,c){c=c||core.status.floorId;if((((flags.enemyOnPoint||{})[c]||{})[e+","+f]||{})[d]!=null){return flags.enemyOnPoint[c][e+","+f][d]}if(b==null){var a=core.getBlock(e,f,c);if(a==null){return null}b=core.material.enemys[a.event.id]}if(typeof b=="string"){b=core.material.enemys[b]}if(b==null){return null}return b[d]};enemys.prototype.canBattle=function(b,d,e,c){if(typeof b=="string"){b=core.material.enemys[b]}var a=this.getDamage(b,d,e,c);return a!=null&&a<core.status.hero.hp};enemys.prototype.getDamageString=function(c,e,f,d){if(typeof c=="string"){c=core.material.enemys[c]}var b=this.getDamage(c,e,f,d);var a="#000000";if(b==null){b="???";a="#FF2222"}else{if(b<=0){a="#11FF11"}else{if(b<core.status.hero.hp/3){a="#FFFFFF"}else{if(b<core.status.hero.hp*2/3){a="#FFFF00"}else{if(b<core.status.hero.hp){a="#FF9933"}else{a="#FF2222"}}}}b=core.formatBigNumber(b,true);if(core.enemys.hasSpecial(c,19)){b+="+"}if(core.enemys.hasSpecial(c,21)){b+="-"}if(core.enemys.hasSpecial(c,11)){b+="^"}}return{damage:b,color:a}};enemys.prototype.nextCriticals=function(a,d,g,h,b){if(typeof a=="string"){a=core.material.enemys[a]}d=d||1;var f=this._nextCriticals_special(a,d,g,h,b);if(f!=null){return f}var c=this.getDamageInfo(a,null,g,h,b);if(c==null){var e=this._nextCriticals_overAtk(a,g,h,b);if(e==null){return[]}if(typeof e[1]=="number"){return[[e[0],-e[1]]]}c=e[1];c.__over__=true;c.__overAtk__=e[0]}if(typeof c=="number"){return[[0,0]]}if(c.damage<=0&&!core.flags.enableNegativeDamage){return[[c.__overAtk__||0,0]]}if(core.flags.useLoop){if(core.status.hero.atk<=(main.criticalUseLoop||1)){return this._nextCriticals_useLoop(a,c,d,g,h,b)}else{return this._nextCriticals_useBinarySearch(a,c,d,g,h,b)}}else{return this._nextCriticals_useTurn(a,c,d,g,h,b)}};enemys.prototype._nextCriticals_overAtk=function(b,d,e,c){var a=function(f,h){var k=f,g=h;if(k>g){return null}while(k<g){var i=Math.floor((k+g)/2);if(i-k>g-i){i--}var j=core.enemys.getDamageInfo(b,{atk:i},d,e,c);if(j!=null){g=i}else{k=i+1}}var j=core.enemys.getDamageInfo(b,{atk:k},d,e,c);return j==null?null:[k-core.status.hero.atk,j]};return a(core.status.hero.atk+1,core.getEnemyValue(b,"hp",d,e,c)+core.getEnemyValue(b,"def",d,e,c))};enemys.prototype._nextCriticals_special=function(a,c,d,e,b){if(this.hasSpecial(a.special,10)||this.hasSpecial(a.special,3)){return[]}return null};enemys.prototype._nextCriticals_useLoop=function(b,e,j,m,n,c){var h=e.mon_hp,d=core.status.hero.atk,g=e.mon_def,k=e.damage;var f=[];var l=d;if(e.__over__){l+=e.__overAtk__;f.push([e.__overAtk__,-e.damage])}for(var a=l+1;a<=h+g;a++){var i=this.getDamageInfo(b,{atk:a},m,n,c);if(i==null||(typeof i=="number")){break}if(k>i.damage){k=i.damage;f.push([a-d,e.damage-i.damage]);if(i.damage<=0&&!core.flags.enableNegativeDamage){break}if(f.length>=j){break}}}if(f.length==0){f.push([0,0])}return f};enemys.prototype._nextCriticals_useBinarySearch=function(c,f,k,n,o,d){var i=f.mon_hp,e=core.status.hero.atk,h=f.mon_def,l=f.damage;var g=[];var m=e;if(f.__over__){m+=f.__overAtk__;g.push([f.__overAtk__,-f.damage])}var a=function(p,r){var u=Math.floor(p),q=Math.floor(r);if(u>q){return null}while(u<q){var s=Math.floor((u+q)/2);if(s-u>q-s){s--}var t=core.enemys.getDamageInfo(c,{atk:s},n,o,d);if(t==null||(typeof t=="number")){return null}if(l>t.damage){q=s}else{u=s+1}}var t=core.enemys.getDamageInfo(c,{atk:u},n,o,d);return t==null||(typeof t=="number")||t.damage>=l?null:[u,t.damage]};var b=m;while(true){var j=a(b+1,i+h,l);if(j==null){break}b=j[0];l=j[1];g.push([b-e,f.damage-l]);if(l<=0&&!core.flags.enableNegativeDamage){break}if(g.length>=k){break}}if(g.length==0){g.push([0,0])}return g};enemys.prototype._nextCriticals_useTurn=function(a,d,j,o,p,b){var g=d.mon_hp,c=core.status.hero.atk,f=d.mon_def,n=d.turn;if(n>=1000000){return this._nextCriticals_useBinarySearch(a,d,j,o,p,b)}var e=[],k=null;var l=c;if(d.__over__){l+=d.__overAtk__;e.push([d.__overAtk__,-d.damage])}for(var m=n-1;m>=1;m--){var h=Math.ceil(g/m)+f;h=Math.ceil(h/core.getBuff("atk"));if(h<=l){break}if(h!=k){var i=this.getDamageInfo(a,{atk:h},o,p,b);if(i==null||(typeof i=="number")){break}e.push([h-c,Math.floor(d.damage-i.damage)]);if(i.damage<=0&&!core.flags.enableNegativeDamage){break}k=h}if(e.length>=j){break}}if(e.length==0){e.push([0,0])}return e};enemys.prototype.getDefDamage=function(a,c,f,g,b){if(typeof a=="string"){a=core.material.enemys[a]}c=c||1;var e=this._getDamage(a,null,f,g,b);var d=this._getDamage(a,{def:core.status.hero.def+c},f,g,b);if(e==null||d==null){return"???"}return e-d};enemys.prototype.getEnemyInfo=function(a,c,d,e,b){if(a==null){return null}if(typeof a=="string"){a=core.material.enemys[a]}return this.enemydata.getEnemyInfo(a,c,d,e,b)};enemys.prototype.getDamageInfo=function(a,c,d,e,b){if(a==null){return null}if(typeof a=="string"){a=core.material.enemys[a]}return this.enemydata.getDamageInfo(a,c,d,e,b)};enemys.prototype.getDamage=function(a,c,d,b){return this._getDamage(a,null,c,d,b)};enemys.prototype._getDamage=function(a,c,e,f,b){if(a==null){a=core.getBlockId(e,f,b)}if(typeof a=="string"){a=core.material.enemys[a]}if(a==null){return null}var d=this.getDamageInfo(a,c,e,f,b);if(d==null){return null}if(typeof d=="number"){return d}return d.damage};enemys.prototype.getCurrentEnemys=function(b){b=b||core.status.floorId;var a=[],c={};core.extractBlocks(b);core.status.maps[b].blocks.forEach(function(d){if(!d.disable&&d.event.cls.indexOf("enemy")==0){this._getCurrentEnemys_addEnemy(d.event.id,a,c,d.x,d.y,b)}},this);return this._getCurrentEnemys_sort(a)};enemys.prototype._getCurrentEnemys_getEnemy=function(b){var a=core.material.enemys[b];if(!a){return null}return core.material.enemys[a.displayIdInBook]||core.material.enemys[(a.faceIds||{}).down]||a};enemys.prototype._getCurrentEnemys_addEnemy=function(d,g,p,r,s,h){var c=this._getCurrentEnemys_getEnemy(d);if(c==null){return}var k=c.id;var f=this.getEnemyInfo(c,null,null,null,h);var l=this.getEnemyInfo(c,null,r,s,h);if(!core.flags.enableEnemyPoint||(l.atk==f.atk&&l.def==f.def&&l.hp==f.hp)){r=null;s=null}else{for(var j=0;j<g.length;++j){var m=g[j];if(k==m.id&&m.locs!=null&&l.atk==m.atk&&l.def==m.def&&l.hp==m.hp){m.locs.push([r,s]);return}}f=l}var k=c.id+":"+r+":"+s;if(p[k]){return}p[k]=true;var o=core.enemys.getSpecialText(c);var n=core.enemys.getSpecialColor(c);var a=this.nextCriticals(c,1,r,s,h);if(a.length>0){a=a[0]}var b=core.clone(c);for(var q in f){b[q]=f[q]}if(r!=null&&s!=null){b.locs=[[r,s]]}b.name=core.getEnemyValue(c,"name",r,s,h);b.specialText=o;b.specialColor=n;b.damage=this.getDamage(c,r,s,h);b.critical=a[0];b.criticalDamage=a[1];b.defDamage=this._getCurrentEnemys_addEnemy_defDamage(c,r,s,h);g.push(b)};enemys.prototype._getCurrentEnemys_addEnemy_defDamage=function(a,d,e,b){var c=core.status.maps[b||core.status.floorId].ratio||1;return this.getDefDamage(a,c,d,e,b)};enemys.prototype._getCurrentEnemys_sort=function(a){return a.sort(function(c,d){if(c.damage==d.damage){return c.money-d.money}if(c.damage==null){return 1}if(d.damage==null){return -1}return c.damage-d.damage})};enemys.prototype.hasEnemyLeft=function(c,e){if(e==null){e=core.status.floorId}if(!(e instanceof Array)){e=[e]}var d={};if(c instanceof Array){c.forEach(function(b){d[b]=true})}else{if(c){d[c]=true}else{d=null}}for(var f=0;f<e.length;f++){core.extractBlocks(e[f]);var g=core.status.maps[e[f]].blocks;for(var a=0;a<g.length;a++){if(!g[a].disable&&g[a].event.cls.indexOf("enemy")===0){if(d===null||d[core.getFaceDownId(g[a])]){return true}}}}return false};"use strict";function events(){this._init()}events.prototype._init=function(){this.eventdata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.events;this.commonEvent=events_c12a15a8_c380_4b28_8144_256cba95f760.commonEvent;this.systemEvents={};this.actions={}};events.prototype.resetGame=function(c,b,a,d,e){this.eventdata.resetGame(c,b,a,d,e)};events.prototype.startGame=function(b,d,c,a){main.dom.levelChooseButtons.style.display="none";main.dom.startButtonGroup.style.display="none";b=b||"";if(main.mode!="play"){return}if(core.flags.startUsingCanvas||c!=null){core.dom.startPanel.style.display="none";this._startGame_start(b,d,c,a)}else{core.hideStartAnimate(function(){core.events._startGame_start(b,d,c,a)})}};events.prototype._startGame_start=function(b,d,c,a){core.resetGame(core.firstData.hero,b,null,core.cloneArray(core.initStatus.maps));core.setHeroLoc("x",-1);core.setHeroLoc("y",-1);if(d!=null&&d>0){core.setFlag("__seed__",d);core.setFlag("__rand__",d)}else{core.utils.__init_seed()}core.clearStatusBar();var e=[];if(core.flags.startUsingCanvas){core.hideStatusBar();core.dom.musicBtn.style.display="block";core.push(e,core.firstData.startCanvas)}core.push(e,{type:"function","function":"function() { core.events._startGame_setHard(); }"});core.push(e,core.firstData.startText);this.insertAction(e,null,null,function(){core.events._startGame_afterStart(a)});if(c!=null){core.startReplay(c)}};events.prototype._startGame_setHard=function(){var b=0;var a="red";main.levelChoose.forEach(function(c){if(c.name==core.status.hard){b=c.hard;a=core.arrayToRGBA(c.color||[255,0,0,1]);core.insertAction(c.action)}});core.setFlag("hard",b||0);core.setFlag("__hardColor__",a)};events.prototype._startGame_afterStart=function(a){core.ui.closePanel();core.changeFloor(core.firstData.floorId,null,core.firstData.hero.loc,null,function(){core.insertAction([]);if(a){a()}});this._startGame_upload()};events.prototype._startGame_upload=function(){var a=new FormData();a.append("type","people");a.append("name",core.firstData.name);a.append("version",core.firstData.version);a.append("platform",core.platform.string);a.append("hard",core.encodeBase64(core.status.hard));a.append("hardCode",core.getFlag("hard",0));a.append("base64",1);core.utils.http("POST","/games/upload.php",a)};events.prototype.win=function(c,b,a){if(!a){core.status.gameOver=true}return this.eventdata.win(c,b,a)};events.prototype.lose=function(a){};events.prototype.gameOver=function(a,b,c){if(!core.status.extraEvent){core.clearMap("all");core.deleteAllCanvas();core.dom.gif2.innerHTML="";core.setWeather()}core.ui.closePanel();if(main.isCompetition&&a!=null){if(a==""){a="恭喜通关"}a+="[比赛]"}var d=null;if(b){d="录像回放完毕！"}else{if(core.hasFlag("debug")){d="\t[系统提示]调试模式下无法上传成绩"}}if(d!=null){core.drawText(d,core.restart)}else{this._gameOver_confirmUpload(a,c)}};events.prototype._gameOver_confirmUpload=function(a,b){core.ui.closePanel();if(a==null){this._gameOver_confirmDownload(a);return}core.ui.drawConfirmBox("你想记录你的ID和成绩吗？",function(){if(main.isCompetition){core.events._gameOver_doUpload("",a,b)}else{var d=core.getCookie("id")||"";var c="请输入你的ID：\n（登录状态下输入数字用户编号可成为蓝名成绩并计入用户通关数）";if(d){c="请输入你的ID：\n（输入数字用户编号"+d+"可成为蓝名成绩并计入用户通关数）"}core.myprompt(c,d,function(e){core.events._gameOver_doUpload(e,a,b)})}},function(){if(main.isCompetition){core.events._gameOver_confirmDownload(a)}else{core.events._gameOver_doUpload(null,a,b)}})};events.prototype._gameOver_doUpload=function(e,a,d){var c=core.status.hero.hp;if(e==null){c=1}core.ui.closePanel();var b=new FormData();b.append("type","score");b.append("name",core.firstData.name);b.append("version",core.firstData.version);b.append("platform",core.platform.string);b.append("hard",core.encodeBase64(core.status.hard));b.append("username",core.encodeBase64(e||""));b.append("ending",core.encodeBase64(a));b.append("lv",core.status.hero.lv);b.append("hp",Math.min(c,Math.pow(2,63)));b.append("atk",core.status.hero.atk);b.append("def",core.status.hero.def);b.append("mdef",core.status.hero.mdef);b.append("money",core.status.hero.money);b.append("experience",core.status.hero.exp);b.append("steps",core.status.hero.steps);b.append("norank",d?1:0);b.append("seed",core.getFlag("__seed__"));b.append("totalTime",Math.floor(core.status.hero.statistics.totalTime/1000));b.append("route",core.encodeRoute(core.status.route));b.append("base64",1);if(main.isCompetition){core.http("POST","/games/competition/upload.php",b)}else{core.http("POST","/games/upload.php",b)}core.events._gameOver_confirmDownload(a)};events.prototype._gameOver_confirmDownload=function(a){core.ui.closePanel();core.ui.drawConfirmBox("你想下载录像吗？",function(){var b={name:core.firstData.name,version:core.firstData.version,hard:core.status.hard,seed:core.getFlag("__seed__"),route:core.encodeRoute(core.status.route)};core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5route",LZString.compressToBase64(JSON.stringify(b)));core.events._gameOver_askRate(a)},function(){core.events._gameOver_askRate(a)})};events.prototype._gameOver_askRate=function(a){core.ui.closePanel();if(core.status.extraEvent){core.status.event=core.status.extraEvent;delete core.status.extraEvent;core.lockControl();core.doAction();return}if(a==null){if(!core.hasSave(0)){core.ui.closePanel();core.restart();return}core.status.event.selection=0;core.ui.drawConfirmBox("你想读取自动存档么？",function(){core.ui.closePanel();core.doSL("autoSave","load")},function(){core.ui.closePanel();core.restart()});return}core.ui.drawConfirmBox("恭喜通关！你想查看榜单、评论，\n以及评分和标色投票吗？",function(){if(core.platform.isPC){window.open("/tower/?name="+core.firstData.name,"_blank");core.restart()}else{window.location.href="/tower/?name="+core.firstData.name}},function(){core.restart()})};events.prototype.restart=function(){core.showStartAnimate();core.playBgm(main.startBgm)};events.prototype.confirmRestart=function(){core.playSound("打开界面");core.status.event.selection=1;core.ui.drawConfirmBox("你确定要返回标题页面吗？",function(){core.playSound("确定");core.ui.closePanel();core.restart()},function(){core.playSound("取消");core.ui.closePanel()})};events.prototype.registerSystemEvent=function(b,a){this.systemEvents[b]=a};events.prototype.unregisterSystemEvent=function(a){delete this.systemEvents[a]};events.prototype.doSystemEvent=function(d,b,a){core.clearRouteFolding();if(this.systemEvents[d]){try{return core.doFunc(this.systemEvents[d],this,b,a)}catch(c){console.error(c);console.error("ERROR in systemEvents["+d+"]")}}if(this["_sys_"+d]){return this["_sys_"+d](b,a)}console.error("未知的系统事件: "+d+"！");if(a){a()}};events.prototype.trigger=function(x,y,callback){var _executeCallback=function(){if(callback){setTimeout(callback,1)}return};if(core.status.gameOver){return _executeCallback()}if(core.status.event.id=="action"){core.insertAction({type:"function","function":"function () { core.events._trigger_inAction("+x+","+y+"); }",async:true},null,null,null,true);return _executeCallback()}if(core.status.event.id){return _executeCallback()}var block=core.getBlock(x,y);if(block==null){return _executeCallback()}if(block.event.script){core.clearRouteFolding();try{eval(block.event.script)}catch(ee){console.error(ee)}}if(block.event.event){core.clearRouteFolding();core.insertAction(block.event.event,block.x,block.y);return _executeCallback()}if(block.event.trigger&&block.event.trigger!="null"){var noPass=block.event.noPass,trigger=block.event.trigger;if(noPass){core.clearAutomaticRouteNode(x,y)}if(trigger=="changeFloor"&&!noPass&&this._trigger_ignoreChangeFloor(block)){return _executeCallback()}core.status.automaticRoute.moveDirectly=false;this.doSystemEvent(trigger,block)}return _executeCallback()};events.prototype._trigger_inAction=function(x,y){if(core.status.gameOver||core.status.event.id!="action"){return}var block=core.getBlock(x,y);if(block==null){return core.doAction()}try{eval(block.event.script)}catch(ee){console.error(ee)}if(block.event.event){core.clearRouteFolding();core.insertAction(block.event.event,block.x,block.y);return core.doAction()}if(block.event.trigger&&block.event.trigger!="null"){this.setEvents(null,x,y);if(block.event.trigger=="action"){this.insertAction(block.event.data)}else{this.doSystemEvent(block.event.trigger,block,core.doAction);return}}return core.doAction()};events.prototype._trigger_ignoreChangeFloor=function(b){var a=core.flags.ignoreChangeFloor;if(b.event.data&&b.event.data.ignoreChangeFloor!=null){a=b.event.data.ignoreChangeFloor}if(a){if(core.isReplaying()){if(core.status.replay.toReplay[0]=="no"){core.status.replay.toReplay.shift();core.status.route.push("no");return true}}else{if(core.status.automaticRoute.autoHeroMove||core.status.automaticRoute.autoStep<core.status.automaticRoute.autoStepRoutes.length){core.status.route.push("no");return true}}}return false};events.prototype._sys_battle=function(c,b){var a=[];core.push(a,core.floors[core.status.floorId].beforeBattle[c.x+","+c.y]);core.push(a,(core.material.enemys[c.event.id]||{}).beforeBattle);if(a.length>0){core.push(a,[{type:"battle",x:c.x,y:c.y}]);core.clearContinueAutomaticRoute();var d=core.status.event.id=="action";if(d){core.insertAction(a,c.x,c.y);core.doAction()}else{core.autosave(true);core.insertAction(a,c.x,c.y,b)}}else{this.battle(c.event.id,c.x,c.y,false,b)}};events.prototype.battle=function(c,d,e,b,a){core.saveAndStopAutomaticRoute();c=c||core.getBlockId(d,e);if(!c){return core.clearContinueAutomaticRoute(a)}if(!core.enemys.canBattle(c,d,e)&&!b&&!core.status.event.id){core.stopSound();core.playSound("操作失败");core.drawTip("你打不过此怪物！",c);return core.clearContinueAutomaticRoute(a)}if(!core.status.event.id){core.autosave(true)}if(!this.beforeBattle(c,d,e)){return core.clearContinueAutomaticRoute(a)}this.afterBattle(c,d,e);if(a){a()}};events.prototype.beforeBattle=function(a,b,c){return this.eventdata.beforeBattle(a,b,c)};events.prototype.afterBattle=function(a,b,c){return this.eventdata.afterBattle(a,b,c)};events.prototype._sys_openDoor=function(b,a){this.openDoor(b.x,b.y,true,function(){core.replay();if(a){a()}})};events.prototype.openDoor=function(e,f,d,b){var a=core.getBlock(e,f);core.saveAndStopAutomaticRoute();if(!this._openDoor_check(a,e,f,d)){var c=core.status.lockControl;core.waitHeroToStop(function(){if(!c){core.unlockControl()}if(b){b()}});return}if(core.status.replay.speed==24){core.status.replay.animate=true;core.removeBlock(e,f);setTimeout(function(){core.status.replay.animate=false;core.events.afterOpenDoor(a.event.id,e,f);if(b){b()}},1)}else{this._openDoor_animate(a,e,f,b)}};events.prototype._openDoor_check=function(a,i,j,h){var b=function(){core.clearContinueAutomaticRoute();return false};if(a==null||a.event==null){return b()}var d=a.event.id;if(core.material.icons.animates[d]==null&&core.material.icons.npc48[d]==null){return b()}if(d=="steelDoor"&&core.flags.steelDoorWithoutKey){h=false}var c=a.event.doorInfo;if(c==null){return b()}var e=c.keys||{};if(h){for(var f in e){var g=e[f];if(f.endsWith(":o")){f=f.substring(0,f.length-2)}if(!core.material.items[f]){core.stopSound();core.playSound("操作失败");core.drawTip("无法开启此门");return b()}if(core.itemCount(f)<g){core.stopSound();core.playSound("操作失败");core.drawTip("你的"+((core.material.items[f]||{}).name||"钥匙")+"不足！",null,true);return false}}if(!core.status.event.id){core.autosave(true)}for(var f in e){if(!f.endsWith(":o")){core.removeItem(f,e[f])}}}core.playSound(c.openSound);return true};events.prototype._openDoor_animate=function(b,h,i,d){var c=core.getBlockInfo(b);c.opacity=b.opacity;c.filter=b.filter;var g=(b.event.doorInfo.time||160)/4;var f=core.status.lockControl;core.lockControl();core.status.replay.animate=true;core.removeBlock(h,i);c.posX=0;core.maps._drawBlockInfo(c,h,i);var e=function(){core.maps._removeBlockFromMap(core.status.floorId,b);if(!f){core.unlockControl()}core.status.replay.animate=false;core.events.afterOpenDoor(b.event.id,h,i);if(d){d()}};var a=window.setInterval(function(){c.posX++;if(c.posX==4){clearInterval(a);delete core.animateFrame.asyncId[a];e();return}core.maps._drawBlockInfo(c,h,i)},core.status.replay.speed==24?1:g/Math.max(core.status.replay.speed,1));core.animateFrame.lastAsyncId=a;core.animateFrame.asyncId[a]=e};events.prototype.afterOpenDoor=function(a,b,c){return this.eventdata.afterOpenDoor(a,b,c)};events.prototype._sys_getItem=function(b,a){this.getItem(b.event.id,1,b.x,b.y,false,a)};events.prototype.getItem=function(d,i,k,l,f,a){if(i==null){i=1}var g=core.material.items[d].cls;core.removeBlock(k,l);core.items.getItemEffect(d,i);var j="获得 "+core.material.items[d].name;if(i>1){j+="x"+i}if(g==="items"&&i==1){j+=core.items.getItemEffectTip(d)}core.drawTip(j,d);if(!core.hasFlag("__itemHint__")){core.setFlag("__itemHint__",[])}var h=core.getFlag("__itemHint__");if(core.flags.itemFirstText&&h.indexOf(d)<0&&g!="items"){var c=core.material.items[d].text||"该道具暂无描述";try{c=core.replaceText(c)}catch(b){}if(!core.status.event.id||core.status.event.id=="action"){core.insertAction("\t["+core.material.items[d].name+","+d+"]"+c+"\n"+(d.endsWith("Key")?"（钥匙类道具，遇到对应的门时自动打开）":g=="tools"?"（消耗类道具，请按T在道具栏使用）":g=="constants"?"（永久类道具，请按T在道具栏使用）":g=="equips"?"（装备类道具，请按Q在装备栏进行装备）":""))}h.push(d)}this.afterGetItem(d,k,l,f);if(a){a()}};events.prototype.afterGetItem=function(a,c,d,b){this.eventdata.afterGetItem(a,c,d,b)};events.prototype.getNextItem=function(b){if(core.isMoving()||!core.flags.enableGentleClick){return false}if(this._canGetNextItem()){return this._getNextItem(null,b)}var a=["up","down","left","right"].filter(function(c){return core.events._canGetNextItem(c)});return a.length>0?this._getNextItem(a[0],b):false};events.prototype._canGetNextItem=function(b){b=b||core.getHeroLoc("direction");if(!core.canMoveHero(null,null,b)){return}var c=core.getHeroLoc("x")+core.utils.scan[b].x;var d=core.getHeroLoc("y")+core.utils.scan[b].y;var a=core.getBlock(c,d);return a!=null&&!a.event.script&&!a.event.event&&a.event.trigger=="getItem"};events.prototype._getNextItem=function(a,b){a=a||core.getHeroLoc("direction");var c=core.getHeroLoc("x")+core.utils.scan[a].x;var d=core.getHeroLoc("y")+core.utils.scan[a].y;if(!b){core.status.route.push("getNext")}this.getItem(core.getBlockId(c,d),1,c,d,true);return true};events.prototype._sys_changeFloor=function(b,a){b=b.event.data;var c={};if(b.loc){c={x:b.loc[0],y:b.loc[1]}}if(b.direction){c.direction=b.direction}if(core.status.event.id!="action"){core.status.event.id=null}core.changeFloor(b.floorId,b.stair,c,b.time,function(){core.replay();if(a){a()}})};events.prototype.changeFloor=function(b,e,c,f,a){var d=this._changeFloor_getInfo(b,e,c,f);if(d==null){if(a){a()}return}b=d.floorId;d.locked=core.status.lockControl;core.dom.floorNameLabel.innerText=core.status.maps[b].title;core.lockControl();core.stopAutomaticRoute();core.clearContinueAutomaticRoute();core.status.replay.animate=true;clearInterval(core.interval.onDownInterval);core.interval.onDownInterval="tmp";this._changeFloor_beforeChange(d,a)};events.prototype._changeFloor_getInfo=function(a,d,b,e){a=a||core.status.floorId;if(a==":before"){var c=core.floorIds.indexOf(core.status.floorId);if(c>0){a=core.floorIds[c-1]}else{a=core.status.floorId}}else{if(a==":next"){var c=core.floorIds.indexOf(core.status.floorId);if(c<core.floorIds.length-1){a=core.floorIds[c+1]}else{a=core.status.floorId}}else{if(a==":now"){a=core.status.floorId}}}if(!core.status.maps[a]){console.error("不存在的楼层："+a);return null}if(main.mode!="play"||core.isReplaying()){e=0}if(e==null){e=core.values.floorChangeTime}e/=20;return{floorId:a,time:e,heroLoc:core.clone(this._changeFloor_getHeroLoc(a,d,b))}};events.prototype._changeFloor_getHeroLoc=function(b,e,c){if(!c){c=core.clone(core.status.hero.loc)}if(e){if(e==":now"){c=core.clone(core.status.hero.loc)}else{if(e==":symmetry"){c.x=core.bigmap.width-1-core.getHeroLoc("x");c.y=core.bigmap.height-1-core.getHeroLoc("y")}else{if(e==":symmetry_x"){c.x=core.bigmap.width-1-core.getHeroLoc("x")}else{if(e==":symmetry_y"){c.y=core.bigmap.height-1-core.getHeroLoc("y")}else{if(core.status.maps[b][e]){c.x=core.status.maps[b][e][0];c.y=core.status.maps[b][e][1]}else{core.extractBlocks(b);var a=core.status.maps[b].blocks;for(var d in a){if(!a[d].disable&&a[d].event.id===e){c.x=a[d].x;c.y=a[d].y;break}}}}}}}}["x","y","direction"].forEach(function(f){if(c[f]==null){c[f]=core.getHeroLoc(f)}});return c};events.prototype._changeFloor_beforeChange=function(b,a){this._changeFloor_playSound();window.setTimeout(function(){if(b.time==0){core.events._changeFloor_changing(b,a)}else{core.showWithAnimate(core.dom.floorMsgGroup,b.time/2,function(){core.events._changeFloor_changing(b,a)})}},25)};events.prototype._changeFloor_playSound=function(){if(core.hasFlag("__fromLoad__")){core.playSound("读档")}else{if(core.hasFlag("__isFlying__")){core.playSound("飞行器")}else{core.playSound("上下楼")}}};events.prototype._changeFloor_changing=function(c,b){this.changingFloor(c.floorId,c.heroLoc);var a=flags.__lockViewport__;core.setFlag("__lockViewport__",null);core.drawHero();core.setFlag("__lockViewport__",a);if(c.time==0){this._changeFloor_afterChange(c,b)}else{core.hideWithAnimate(core.dom.floorMsgGroup,c.time/4,function(){core.events._changeFloor_afterChange(c,b)})}};events.prototype._changeFloor_afterChange=function(b,a){if(!b.locked){core.unlockControl()}core.status.replay.animate=false;core.events.afterChangeFloor(b.floorId);if(a){a()}};events.prototype.changingFloor=function(a,b){this.eventdata.changingFloor(a,b)};events.prototype.afterChangeFloor=function(a){if(main.mode!="play"){return}return this.eventdata.afterChangeFloor(a)};events.prototype.hasVisitedFloor=function(a){if(!core.hasFlag("__visited__")){core.setFlag("__visited__",{})}return core.getFlag("__visited__")[a]||false};events.prototype.visitFloor=function(a){if(!core.hasFlag("__visited__")){core.setFlag("__visited__",{})}core.getFlag("__visited__")[a]=true};events.prototype._sys_pushBox=function(b,a){this.pushBox(b);if(a){a()}};events.prototype.pushBox=function(b){if(b.event.id!="box"&&b.event.id!="boxed"){return}var c=core.getHeroLoc("direction"),e=b.x+core.utils.scan[c].x,f=b.y+core.utils.scan[c].y;if(!core.canMoveHero()){return}var a=core.flags.canGoDeadZone;core.flags.canGoDeadZone=true;if(!core.canMoveHero(b.x,b.y,c)){core.flags.canGoDeadZone=a;return}core.flags.canGoDeadZone=a;var d=core.getBlockId(e,f);if(d!=null&&d!="flower"){return}core.setBlock(d==null?"box":"boxed",e,f);if(b.event.id=="box"){core.removeBlock(b.x,b.y)}else{core.setBlock("flower",b.x,b.y)}core.insertAction([{type:"moveAction"},{type:"function","function":"function() { core.afterPushBox(); }"}])};events.prototype.afterPushBox=function(){return this.eventdata.afterPushBox()};events.prototype._sys_ski=function(b,a){core.insertAction(["V2.6后，请将滑冰放在背景层！"],b.x,b.y);if(a){a()}};events.prototype.onSki=function(b){if(b==null){b=core.getBgNumber()}var a=core.getBlockByNumber(b);return a&&a.event&&a.event.trigger=="ski"};events.prototype._sys_action=function(b,a){var d=core.clone(b.event.data),e=b.x,f=b.y;if(e==core.nextX()&&f==core.nextY()){var c=core.turnDirection(":back");var g=b.event.id,i=(b.event.faceIds||{})[c];if(i&&g!=i){var h=core.getNumberById(i);if(h>0){core.setBlock(h,e,f)}}}this.insertAction(d,e,f,a)};events.prototype._sys_custom=function(b,a){core.insertAction(["请使用\r[yellow]core.registerSystemEvent('custom', func)\r来处理自己添加的系统触发器！"],b.x,b.y,a)};events.prototype.registerEvent=function(b,a){this.actions[b]=a};events.prototype.unregisterEvent=function(a){delete this.actions[a]};events.prototype.doEvent=function(a,f,g,c){var d=a.type;if(this.actions[d]){try{return core.doFunc(this.actions[d],this,a,f,g,c)}catch(b){console.error(b);console.error("ERROR in actions["+d+"]")}}if(this["_action_"+d]){return this["_action_"+d](a,f,g,c)}core.insertAction("未知的自定义事件: "+d+"！");core.doAction()};events.prototype.setEvents=function(d,e,f,a){var b=core.status.event.data||{};if(d){var c=core.clone(d);if(!(c instanceof Array)){c=[c]}c.push({type:"_label"});b.list=[{todo:c,total:core.clone(c),condition:"false"}];if(d.length==0){core.status.autoEvents.forEach(function(g){core.autoEventExecuting(g.symbol,false)})}}if(e!=null){b.x=e}if(f!=null){b.y=f}if(a){b.callback=a}if(!b.appendingEvents){b.appendingEvents=[]}if(!b.locStack){b.locStack=[]}core.status.event.id="action";core.status.event.data=b};events.prototype.startEvents=function(b,c,d,a){if(!b){return}if(!(b instanceof Array)){b=[b]}this.setEvents(b,c,d,a);core.waitHeroToStop(function(){core.lockControl();core.doAction()})};events.prototype.doAction=function(){clearInterval(core.status.event.interval);clearTimeout(core.status.event.interval);clearInterval(core.status.event.animateUI);core.status.event.interval=null;delete core.status.event.aniamteUI;if(core.status.gameOver||core.status.replay.failed){return}if(this._doAction_finishEvents()){return}core.clearUI();var c=core.status.event.data.floorId||core.status.floorId;var e=core.status.event.data.x,f=core.status.event.data.y;var d=[c||":f",e!=null?e:"x",f!=null?f:"y"].join("@");var a=core.status.event.data.list[0];if(this._popEvents(a,d)){return}var b=a.todo.shift();core.status.event.data.current=b;if(typeof b=="string"){b={type:"text",text:b}}if(b._disabled){return core.doAction()}b.floorId=b.floorId||c;core.status.event.data.type=b.type;this.doEvent(b,e,f,d);return};events.prototype._doAction_finishEvents=function(){if(core.status.event.id!="action"){return true}if(core.status.event.data.list.length==0){if(core.status.event.data.appendingEvents.length>0){this.setEvents(core.status.event.data.appendingEvents.shift());return false}var a=core.status.event.data.callback;core.ui.closePanel();if(a){a()}core.replay();return true}return false};events.prototype._popEvents=function(a,b){if(a.todo.length==0){if(core.calValue(a.condition,b)){a.todo=core.clone(a.total)}else{core.status.event.data.list.shift()}core.doAction();return true}return false};events.prototype.insertAction=function(a,f,g,c,b){if(core.hasFlag("__statistics__")){return}if(core.status.gameOver){return}if(!a){return}core.clearRouteFolding();a=this.precompile(a);if(core.status.event.id!="action"){this.startEvents(a,f,g,c)}else{if(b){var e=core.status.event.data.list[0].todo;var d=0;for(var d=0;d<e.length;d++){if(e[d].type=="_label"){e.splice(d,0,a);break}}}else{core.unshift(core.status.event.data.list[0].todo,a)}this.setEvents(null,f,g,c)}};events.prototype.insertCommonEvent=function(g,b,h,j,c,a){var d=this.getCommonEvent(g);if(!d){if(c){c()}return}core.setFlag("arg0",g);if(b instanceof Array){for(var f=0;f<b.length;++f){try{if(b[f]!=null){core.setFlag("arg"+(f+1),b[f])}}catch(e){console.error(e)}}}this.insertAction({type:"dowhile",condition:"false",data:d},h,j,c,a)};events.prototype.getCommonEvent=function(a){if(!a||typeof a!=="string"){return null}return this.commonEvent[a]||null};events.prototype.recoverEvents=function(a){if(a){core.ui.closePanel();core.lockControl();core.status.event.id="action";core.status.event.data=a;setTimeout(function(){core.doAction()},30);return true}return false};events.prototype.checkAutoEvents=function(){if(!core.isPlaying()||(core.status.lockControl&&core.status.event.id!="action")){return}if(core.hasFlag("__doNotCheckAutoEvents__")){return}var b=[],a=[];core.status.autoEvents.forEach(function(c){var i=c.symbol,j=c.x,k=c.y,g=c.floorId;if(c.currentFloor&&g!=core.status.floorId){return}if(!c.multiExecute&&core.autoEventExecuted(i)){return}if((flags.__removed__||[]).indexOf(g)>=0){return}if(core.autoEventExecuting(i)){return}var h=g+"@"+j+"@"+k;try{if(!core.calValue(c.condition,h)){return}}catch(d){return}core.autoEventExecuting(i,true);core.autoEventExecuted(i,true);var f;if(j==null&&k==null){f=[{type:"dowhile",condition:"false",data:c.data},{type:"function","function":"function() { core.autoEventExecuting('"+i+"', false); }"}]}else{f=[{type:"function","function":"function() { core.pushEventLoc("+j+", "+k+", '"+g+"' ); }"},{type:"dowhile",condition:"false",data:c.data},{type:"function","function":"function() { core.popEventLoc(); core.autoEventExecuting('"+i+"', false); }"}]}if(c.delayExecute){a.push(f)}else{core.push(b,f)}});if(b.length==0&&a.length==0){return}if(core.status.event.id=="action"||b.length>0){core.insertAction(b);core.push(core.status.event.data.appendingEvents,a)}else{core.insertAction(a[0]);if(a.length>0){core.insertAction(a.slice(1))}}};events.prototype.autoEventExecuting=function(b,c){var a=core.getFlag("__aei__",[]);if(c==null){return a.indexOf(b)>=0}else{a=a.filter(function(d){return d!=b});if(c){a.push(b)}core.setFlag("__aei__",a)}};events.prototype.autoEventExecuted=function(b,c){var a=core.getFlag("__aed__",[]);if(c==null){return a.indexOf(b)>=0}else{a=a.filter(function(d){return d!=b});if(c){a.push(b)}core.setFlag("__aed__",a)}};events.prototype.pushEventLoc=function(b,c,a){if(core.status.event.id!="action"){return}core.status.event.data.locStack.push({x:core.status.event.data.x,y:core.status.event.data.y,floorId:core.status.event.data.floorId});core.status.event.data.x=b;core.status.event.data.y=c;core.status.event.data.floorId=a};events.prototype.popEventLoc=function(){if(core.status.event.id!="action"){return}var a=core.status.event.data.locStack.shift();if(a){core.status.event.data.x=a.x;core.status.event.data.y=a.y;core.status.event.data.floorId=a.floorId}};events.prototype.precompile=function(b){var a=this.__precompile_getArray();if(typeof b=="string"){return this.__precompile_text(b)}if(b instanceof Array){for(var c=0;c<b.length;++c){b[c]=this.precompile(b[c])}return b}if(b&&b.type){if(this["_precompile_"+b.type]){b=this["_precompile_"+b.type](b)}if(a.texts.indexOf(b.type)>=0){b.text=this.__precompile_text(b.text)}if(a.locs.indexOf(b.type)>=0){b.loc=this.__precompile_array(b.loc)}if(a.values.indexOf(b.type)>=0){b.value=core.replaceValue(b.value)}if(a.uievents.indexOf(b.type)>=0){b.x=core.replaceValue(b.x);b.y=core.replaceValue(b.y);b.width=core.replaceValue(b.width);b.height=core.replaceValue(b.height)}if(b.type in a.others){a.others[b.type].forEach(function(d){b[d]=core.replaceValue(b[d])})}}return b};events.prototype.__precompile_getArray=function(){var c=["text","autoText","scrollText","tip","textImage","input","input2","choices","confirm","fillText","fillBoldText","drawTextContent"];var a=["show","hide","setBlock","setBlockOpacity","showFloorImg","hideFloorImg","showBgFgMap","hideBgFgMap","setBgFgBlock","animate","setViewport","move","jumoHero","changeFloor","changePos","showTextImage","showGif","openDoor","closeDoor","battle","trigger","insert","setEnemyOnPoint","resetEnemyOnPoint"];var e=["setValue","setEnemy","setEnemyOnPoint","setEquip","setFloor","setGlobalValue",];var d=["clearMap","fillText","fillBoldText","fillRect","strokeRect","fillEllipse","strokeEllipse","fillArc","strokeArc","drawIcon","drawSelector","drawBackground",];var b={fillEllipse:["a","b","angle"],strokeEllipse:["a","b","angle"],fillRect:["radius","angle"],strokeRect:["radius","angle"],fillArc:["r","start","end"],strokeArc:["r","start","end"],drawLine:["x1","y1","x2","y2"],drawArrow:["x1","y1","x2","y2"],drawImage:["x","y","w","h","x1","y1","w1","h1","angle"],drawTextContent:["left","top"],};return{texts:c,locs:a,values:e,uievents:d,others:b}};events.prototype.__precompile_text=function(a){if(typeof a!="string"){return a}return a.replace(/\${(.*?)}/g,function(c,b){return"${"+core.replaceValue(b)+"}"})};events.prototype.__precompile_array=function(b){if(typeof b=="string"){b=core.replaceValue(b);return b}if(b instanceof Array){for(var a=0;a<b.length;++a){b[a]=this.__precompile_array(b[a])}}return b};events.prototype.__action_checkReplaying=function(){if(core.isReplaying()){core.doAction();return true}return false};events.prototype.__action_getLoc=function(a,c,d,b){if(a){c=core.calValue(a[0],b);d=core.calValue(a[1],b)}return[c,d]};events.prototype.__action_getHeroLoc=function(a,b){return this.__action_getLoc(a,core.getHeroLoc("x"),core.getHeroLoc("y"),b)};events.prototype.__action_getLoc2D=function(a,c,d,b){if(!(a&&a[0] instanceof Array)){a=[this.__action_getLoc(a,c,d,b)]}return a};events.prototype.__action_doAsyncFunc=function(b,a){var c=Array.prototype.slice.call(arguments,2);if(b){a.apply(this,c);core.doAction()}else{a.apply(this,c.concat(core.doAction))}};events.prototype._action_text=function(b,d,e,c){if(this.__action_checkReplaying()){return}b.text=core.replaceText(b.text,c);var a=b.code?("__text__"+b.code):null;b.ctx=a;if(core.getContextByName(a)&&!b.showAll){core.ui._animateUI("hide",a,function(){core.ui.drawTextBox(b.text,b);core.ui._animateUI("show",a,function(){if(b.async){core.doAction()}})});return}core.ui.drawTextBox(b.text,b);if(!b.showAll){core.ui._animateUI("show",a,function(){if(b.async){core.doAction()}})}};events.prototype._action_moveTextBox=function(a,c,d,b){if(this.__action_checkReplaying()){return}this.__action_doAsyncFunc(a.async,core.moveTextBox,a.code,this.__action_getLoc(a.loc,c,d,b),a.relative,a.moveMode,a.time)};events.prototype._action_clearTextBox=function(a,c,d,b){if(this.__action_checkReplaying()){return}core.clearTextBox(a.code,core.doAction)};events.prototype._action_autoText=function(a,c,d,b){if(this.__action_checkReplaying()){return}a.text=core.replaceText(a.text,b);core.ui.drawTextBox(a.text);setTimeout(core.doAction,a.time||3000)};events.prototype._action_scrollText=function(a,c,d,b){if(this.__action_checkReplaying()){return}a.text=core.replaceText(a.text,b);this.__action_doAsyncFunc(a.async,core.drawScrollText,a.text,a.time||5000,a.lineHeight||1.4)};events.prototype._action_comment=function(a,c,d,b){core.doAction()};events.prototype._action__label=function(a,c,d,b){core.doAction()};events.prototype._action_setText=function(a,c,d,b){this.setTextAttribute(a);core.doAction()};events.prototype._action_tip=function(a,c,d,b){core.drawTip(core.replaceText(a.text,b),a.icon);core.doAction()};events.prototype._action_show=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);if(a.time>0&&a.floorId==core.status.floorId){this.__action_doAsyncFunc(a.async,core.animateBlock,a.loc,"show",a.time)}else{a.loc.forEach(function(e){core.showBlock(e[0],e[1],a.floorId)});core.doAction()}};events.prototype._action_hide=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);if(a.time>0&&a.floorId==core.status.floorId){this.__action_doAsyncFunc(a.async,core.animateBlock,a.loc,a.remove?"remove":"hide",a.time)}else{a.loc.forEach(function(e){if(a.remove){core.removeBlock(e[0],e[1],a.floorId)}else{core.hideBlock(e[0],e[1],a.floorId)}});core.doAction()}};events.prototype._action_setBlock=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);a.time=a.time||0;a.floorId=a.floorId||core.status.floorId;if(a.time>0&&a.floorId==core.status.floorId){this.__action_doAsyncFunc(a.async,core.animateSetBlocks,a.number,a.loc,a.floorId,a.time)}else{a.loc.forEach(function(e){core.setBlock(a.number,e[0],e[1],a.floorId)});core.doAction()}};events.prototype._action_setBlockOpacity=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);if(a.time>0&&a.floorId==core.status.floorId){this.__action_doAsyncFunc(a.async,core.animateBlock,a.loc,a.opacity,a.time)}else{a.loc.forEach(function(e){core.setBlockOpacity(a.opacity,e[0],e[1],a.floorId)});core.doAction()}};events.prototype._action_setBlockFilter=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);a.loc.forEach(function(e){core.setBlockFilter(a,e[0],e[1],a.floorId)});core.doAction()};events.prototype._action_turnBlock=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);a.loc.forEach(function(e){core.turnBlock(a.direction,e[0],e[1],a.floorId)});core.doAction()};events.prototype._action_showFloorImg=function(a,c,d,b){core.maps.showFloorImage(this.__action_getLoc2D(a.loc,c,d,b),a.floorId,core.doAction)};events.prototype._action_hideFloorImg=function(a,c,d,b){core.maps.hideFloorImage(this.__action_getLoc2D(a.loc,c,d,b),a.floorId,core.doAction)};events.prototype._action_showBgFgMap=function(a,c,d,b){core.maps.showBgFgMap(a.name,this.__action_getLoc2D(a.loc,c,d,b),a.floorId,core.doAction)};events.prototype._action_hideBgFgMap=function(a,c,d,b){core.maps.hideBgFgMap(a.name,this.__action_getLoc2D(a.loc,c,d,b),a.floorId,core.doAction)};events.prototype._action_setBgFgBlock=function(a,c,d,b){a.loc=this.__action_getLoc2D(a.loc,c,d,b);a.loc.forEach(function(e){core.setBgFgBlock(a.name,a.number,e[0],e[1],a.floorId)});core.doAction()};events.prototype._action_follow=function(a,c,d,b){this.follow(a.name);core.doAction()};events.prototype._action_unfollow=function(a,c,d,b){this.unfollow(a.name);core.doAction()};events.prototype._action_animate=function(a,c,d,b){if(a.loc=="hero"){this.__action_doAsyncFunc(a.async,core.drawHeroAnimate,a.name)}else{a.loc=this.__action_getLoc(a.loc,c,d,b);this.__action_doAsyncFunc(a.async,core.drawAnimate,a.name,a.loc[0],a.loc[1],a.alignWindow)}};events.prototype._action_stopAnimate=function(a,c,d,b){core.stopAnimate(null,a.doCallback);core.doAction()};events.prototype._action_setViewport=function(a,c,d,b){if(a.dxy!=null){a.loc=[core.bigmap.offsetX/32+(core.calValue(a.dxy[0],b)||0),core.bigmap.offsetY/32+(core.calValue(a.dxy[1],b)||0)]}else{if(a.loc==null){a.loc=[core.getHeroLoc("x")-core._HALF_WIDTH_,core.getHeroLoc("y")-core._HALF_HEIGHT_]}else{a.loc=this.__action_getLoc(a.loc,c,d,b)}}this.__action_doAsyncFunc(a.async,core.moveViewport,a.loc[0],a.loc[1],a.moveMode,a.time)};events.prototype._action_lockViewport=function(a,c,d,b){core.setFlag("__lockViewport__",a.lock||null);core.doAction()};events.prototype._action_move=function(a,d,e,c){var b=this.__action_getLoc(a.loc,d,e,c);this.__action_doAsyncFunc(a.async,core.moveBlock,b[0],b[1],a.steps,a.time,a.keep)};events.prototype._action_moveAction=function(a,e,f,d){if(core.canMoveHero()){var b=core.nextX(),c=core.nextY();if(core.noPass(b,c)){core.insertAction([{type:"trigger",loc:[b,c]}])}else{core.insertAction([{type:"moveHero",steps:["forward"]},{type:"function","function":"function() { core.moveOneStep(core.doAction); }",async:true},{type:"_label"},])}}core.doAction()};events.prototype._action_moveHero=function(a,c,d,b){this.__action_doAsyncFunc(a.async,core.eventMoveHero,a.steps,a.time)};events.prototype._action_jump=function(a,e,f,c){var b=this.__action_getLoc(a.from,e,f,c),d;if(a.dxy){d=[b[0]+(core.calValue(a.dxy[0],c)||0),b[1]+(core.calValue(a.dxy[1],c)||0)]}else{d=this.__action_getLoc(a.to,e,f,c)}this.__action_doAsyncFunc(a.async,core.jumpBlock,b[0],b[1],d[0],d[1],a.time,a.keep)};events.prototype._precompile_jump=function(a){a.from=this.__precompile_array(a.from);a.to=this.__precompile_array(a.to);a.dxy=this.__precompile_array(a.dxy);return a};events.prototype._action_jumpHero=function(a,d,e,c){var b;if(a.dxy){b=[core.getHeroLoc("x")+(core.calValue(a.dxy[0],c)||0),core.getHeroLoc("y")+(core.calValue(a.dxy[1],c)||0)]}else{b=this.__action_getHeroLoc(a.loc,c)}this.__action_doAsyncFunc(a.async,core.jumpHero,b[0],b[1],a.time)};events.prototype._action_changeFloor=function(a,e,f,d){var c=this.__action_getHeroLoc(a.loc,d);var b={x:c[0],y:c[1],direction:a.direction};core.changeFloor(a.floorId,a.stair,b,a.time,core.doAction)};events.prototype._action_changePos=function(a,d,e,c){core.clearMap("hero");if(!a.loc&&a.direction){core.setHeroLoc("direction",core.turnDirection(a.direction),true);core.drawHero();return core.doAction()}var b=this.__action_getHeroLoc(a.loc,c);core.setHeroLoc("x",b[0]);core.setHeroLoc("y",b[1]);if(a.direction){core.setHeroLoc("direction",core.turnDirection(a.direction))}core.drawHero();core.doAction()};events.prototype._action_showImage=function(a,c,d,b){if(core.isReplaying()){a.time=0}this.__action_doAsyncFunc(a.async||a.time==0,core.showImage,a.code,a.image+(a.reverse||""),a.sloc,a.loc,a.opacity,a.time)};events.prototype._precompile_showImage=function(a){a.sloc=this.__precompile_array(a.sloc);a.loc=this.__precompile_array(a.loc);return a};events.prototype._action_showTextImage=function(b,e,f,d){var c=this.__action_getLoc(b.loc,0,0,d);if(core.isReplaying()){b.time=0}b.text=core.replaceText(b.text,d);var a=(Math.random()+"_"+Math.random()).replace(/\./g,"")+".png";core.material.images.images[a]=core.ui.textImage(b.text);this.__action_doAsyncFunc(b.async||b.time==0,core.showImage,b.code,a+(b.reverse||""),null,c,b.opacity,b.time);delete core.material.images.images[a]};events.prototype._action_hideImage=function(a,c,d,b){if(core.isReplaying()){a.time=0}this.__action_doAsyncFunc(a.async||a.time==0,core.hideImage,a.code,a.time)};events.prototype._action_showGif=function(a,d,e,c){var b=this.__action_getLoc(a.loc,0,0,c);this.showGif(a.name,b[0],b[1]);core.doAction()};events.prototype._action_moveImage=function(a,c,d,b){if(this.__action_checkReplaying()){return}this.__action_doAsyncFunc(a.async,core.moveImage,a.code,a.to,a.opacity,a.moveMode,a.time)};events.prototype._precompile_moveImage=function(a){a.to=this.__precompile_array(a.to);return a};events.prototype._action_rotateImage=function(a,c,d,b){if(this.__action_checkReplaying()){return}this.__action_doAsyncFunc(a.async,core.rotateImage,a.code,a.center,a.angle,a.moveMode,a.time)};events.prototype._precompile_rotateImage=function(a){a.center=this.__precompile_array(a.center);return a};events.prototype._action_scaleImage=function(a,c,d,b){if(this.__action_checkReplaying()){return}this.__action_doAsyncFunc(a.async,core.scaleImage,a.code,a.center,a.scale,a.moveMode,a.time)};events.prototype._precompile_scaleImage=function(a){a.center=this.__precompile_array(a.center);return a};events.prototype._action_setCurtain=function(a,c,d,b){if(a.async){core.setCurtain(a.color||core.status.thisMap.color,a.time,a.moveMode);if(a.color==null||a.keep){core.setFlag("__color__",a.color||null)}core.doAction()}else{core.setCurtain(a.color||core.status.thisMap.color,a.time,a.moveMode,function(){if(a.color==null||a.keep){core.setFlag("__color__",a.color||null)}core.doAction()})}};events.prototype._action_screenFlash=function(a,c,d,b){this.__action_doAsyncFunc(a.async,core.screenFlash,a.color,a.time,a.times,a.moveMode)};events.prototype._action_setWeather=function(a,c,d,b){core.setWeather(a.name,a.level);if(a.keep&&["rain","snow","sun","fog","cloud"].indexOf(a.name)>=0){core.setFlag("__weather__",[a.name,a.level])}else{core.removeFlag("__weather__")}core.doAction()};events.prototype._action_openDoor=function(a,e,f,d){var c=this.__action_getLoc(a.loc,e,f,d);var b=a.floorId;if(b==core.status.floorId){this.__action_doAsyncFunc(a.async,core.openDoor,c[0],c[1],a.needKey)}else{core.removeBlock(c[0],c[1],b);core.doAction()}};events.prototype._action_closeDoor=function(a,d,e,c){var b=this.__action_getLoc(a.loc,d,e,c);this.__action_doAsyncFunc(a.async,core.closeDoor,b[0],b[1],a.id)};events.prototype._action_useItem=function(a,c,d,b){if(a.id!="book"&&core.canUseItem(a.id)){core.useItem(a.id,true,core.doAction)}else{core.playSound("操作失败");core.drawTip("当前无法使用"+((core.material.items[a.id]||{}).name||"未知道具"));core.doAction()}};events.prototype._action_loadEquip=function(a,c,d,b){core.loadEquip(a.id);core.doAction()};events.prototype._action_unloadEquip=function(a,c,d,b){core.unloadEquip(a.pos);core.doAction()};events.prototype._action_openShop=function(a,c,d,b){core.setShopVisited(a.id,true);if(a.open){core.openShop(a.id,true)}core.doAction()};events.prototype._action_disableShop=function(a,c,d,b){core.setShopVisited(a.id,false);core.doAction()};events.prototype._action_battle=function(a,d,e,c){if(a.id){this.battle(a.id,null,null,true,core.doAction)}else{if(a.floorId!=core.status.floorId){core.doAction();return}var b=this.__action_getLoc(a.loc,d,e,c);this.battle(null,b[0],b[1],true,core.doAction)}};events.prototype._action_trigger=function(a,d,e,c){var b=this.__action_getLoc(a.loc,d,e,c);this._trigger_inAction(b[0],b[1])};events.prototype._action_insert=function(a,j,k,g){if(a.name){core.insertCommonEvent(a.name,a.args)}else{if(a.args instanceof Array){for(var e=0;e<a.args.length;++e){try{if(a.args[e]!=null){core.setFlag("arg"+(e+1),a.args[e])}}catch(b){console.error(b)}}}var f=this.__action_getLoc(a.loc,j,k,g);core.setFlag("arg0",f);var d=a.floorId;var h=a.which||"events";var c=(core.floors[d][h]||[])[f[0]+","+f[1]];if(c){this.insertAction(c.data||c)}}core.doAction()};events.prototype._action_playBgm=function(a,c,d,b){core.playBgm(a.name,a.startTime||0);core.setFlag("__bgm__",a.keep?a.name:null);core.doAction()};events.prototype._action_pauseBgm=function(a,c,d,b){core.pauseBgm();core.doAction()};events.prototype._action_resumeBgm=function(a,c,d,b){core.resumeBgm(a.resume);core.doAction()};events.prototype._action_loadBgm=function(a,c,d,b){core.loadBgm(a.name);core.doAction()};events.prototype._action_freeBgm=function(a,c,d,b){core.freeBgm(a.name);core.doAction()};events.prototype._action_playSound=function(a,c,d,b){if(a.stop){core.stopSound()}if(a.sync){core.playSound(a.name,a.pitch,core.doAction)}else{core.playSound(a.name,a.pitch);core.doAction()}};events.prototype._action_stopSound=function(a,c,d,b){core.stopSound();core.doAction()};events.prototype._action_setVolume=function(a,c,d,b){a.value=core.clamp(parseInt(a.value)/100,0,1);core.setFlag("__volume__",a.value);this.__action_doAsyncFunc(a.async,core.setVolume,a.value,a.time||0)};events.prototype._action_setBgmSpeed=function(a,c,d,b){core.setBgmSpeed(a.value,a.pitch||false);core.doAction()};events.prototype._action_setValue=function(a,c,d,b){this.setValue(a.name,a.operator,a.value,b);if(!a.norefresh){if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose()}else{core.updateStatusBar()}}core.doAction()};events.prototype._action_addValue=function(a,c,d,b){a.operator="+=";this._action_setValue(a,c,d,b)};events.prototype._action_setEnemy=function(a,c,d,b){this.setEnemy(a.id,a.name,a.value,a.operator,b,a.norefresh);core.doAction()};events.prototype._action_setEnemyOnPoint=function(a,d,e,c){var b=this.__action_getLoc2D(a.loc,d,e,c);b.forEach(function(f){core.setEnemyOnPoint(f[0],f[1],a.floorId,a.name,a.value,a.operator,c,a.norefresh)});core.doAction()};events.prototype._action_resetEnemyOnPoint=function(a,d,e,c){var b=this.__action_getLoc2D(a.loc,d,e,c);b.forEach(function(f){core.resetEnemyOnPoint(f[0],f[1],a.floorId,a.norefresh)});core.doAction()};events.prototype._precompile_moveEnemyOnPoint=function(a){a.from=this.__precompile_array(a.from);a.to=this.__precompile_array(a.to);a.dxy=this.__precompile_array(a.dxy);return a};events.prototype._action_moveEnemyOnPoint=function(a,e,f,c){var b=this.__action_getLoc(a.from,e,f,c),d;if(a.dxy){d=[b[0]+(core.calValue(a.dxy[0],c)||0),b[1]+(core.calValue(a.dxy[1],c)||0)]}else{d=this.__action_getLoc(a.to,e,f,c)}this.moveEnemyOnPoint(b[0],b[1],d[0],d[1],a.floorId,a.norefresh);core.doAction()};events.prototype._action_setEquip=function(a,c,d,b){core.setEquip(a.id,a.valueType,a.name,a.value,a.operator,b);core.doAction()};events.prototype._action_setFloor=function(a,c,d,b){this.setFloorInfo(a.name,a.value,a.floorId,b);core.doAction()};events.prototype._action_setGlobalAttribute=function(a,c,d,b){this.setGlobalAttribute(a.name,a.value);core.doAction()};events.prototype._action_setGlobalValue=function(a,c,d,b){core.values[a.name]=a.value;core.doAction()};events.prototype._action_setGlobalFlag=function(a,c,d,b){this.setGlobalFlag(a.name,a.value);core.doAction()};events.prototype._action_setNameMap=function(a,c,d,b){this.setNameMap(a.name,a.value);core.doAction()};events.prototype._action_setHeroIcon=function(a,c,d,b){this.setHeroIcon(a.name,a.noDraw);core.doAction()};events.prototype._action_input=function(a,c,d,b){this.__action_getInput(core.replaceText(a.text,b),false,function(e){e=parseInt(e)||0;core.status.route.push("input:"+e);core.setFlag("input",e);core.doAction()})};events.prototype._action_input2=function(a,c,d,b){this.__action_getInput(core.replaceText(a.text,b),true,function(e){e=e||"";core.status.route.push("input2:"+core.encodeBase64(e));core.setFlag("input",e);core.doAction()})};events.prototype.__action_getInput=function(d,f,b){var h,g=f?"input2:":"input:";if(core.isReplaying()){var a=core.status.replay.toReplay.shift();try{if(a.indexOf(g)!=0){console.warn("警告！当前需要一个 "+g+" 项，实际为 "+a);core.status.replay.toReplay.unshift(a);return b(f?"":0)}if(f){h=core.decodeBase64(a.substring(7))}else{h=parseInt(a.substring(6))}b(h)}catch(c){core.control._replay_error(a);return}}else{core.myprompt(core.replaceText(d),null,b)}};events.prototype._action_if=function(a,c,d,b){if(core.calValue(a.condition,b)){core.events.insertAction(a["true"])}else{core.events.insertAction(a["false"])}core.doAction()};events.prototype._precompile_if=function(a){a.condition=core.replaceValue(a.condition);a["true"]=this.precompile(a["true"]);a["false"]=this.precompile(a["false"]);return a};events.prototype._action_switch=function(b,g,h,f){var d=core.calValue(b.condition,f);var e=[];for(var c=0;c<b.caseList.length;c++){if(b.caseList[c]._disabled){continue}var a=b.caseList[c]["case"];if(a=="default"||core.calValue(a,f)===d){core.push(e,b.caseList[c].action);if(!b.caseList[c].nobreak){break}}}core.insertAction(e);core.doAction()};events.prototype._precompile_switch=function(a){a.condition=core.replaceValue(a.condition);for(var b=0;b<a.caseList.length;b++){a.caseList[b]["case"]=core.replaceValue(a.caseList[b]["case"]);a.caseList[b].action=this.precompile(a.caseList[b].action)}return a};events.prototype._action_choices=function(b,f,g,e){b.choices=b.choices.filter(function(i){if(i._disabled){return false}if(i.condition==null||i.condition==""){return true}try{return core.calValue(i.condition,e)}catch(h){return true}});if(b.choices.length==0){return this.doAction()}if(core.isReplaying()){var a=core.status.replay.toReplay.shift();if(a.indexOf("choices:")==0&&!(a=="choices:none"&&!b.timeout)){var d=a.substring(8);if(!this.__action_choices_replaying(b,d)){core.control._replay_error(a);return}}else{if(main.replayChecking){if(a!="choices:none"){core.status.replay.toReplay.unshift(a)}core.events.__action_choices_replaying(b,-1)}else{core.myprompt("录像回放出错！当前需要执行选择项但录像中未记录。\n如需修复请输入您要选的项（从0起），点击取消将不会修复。",0,function(h){if(h==null){core.control._replay_error(a);return}if(a!="choices:none"){core.status.replay.toReplay.unshift(a)}core.events.__action_choices_replaying(b,((parseInt(h)||0)+b.choices.length)%b.choices.length)})}}}else{if(b.timeout){core.status.event.interval=setTimeout(function(){core.status.route.push("choices:none");core.setFlag("timeout",0);core.doAction()},b.timeout)}core.status.event.timeout=new Date().getTime()+(b.timeout||0)}for(var c=0;c<b.choices.length;c++){if(typeof b.choices[c]==="string"){b.choices[c]={text:b.choices[c]}}b.choices[c].text=core.replaceText(b.choices[c].text,e)}core.ui.drawChoices(core.replaceText(b.text,e),b.choices,b.width)};events.prototype.__action_choices_replaying=function(a,b){var c=b;if(b!="none"){c=parseInt(b);if(isNaN(c)){return false}if(c<0){c+=a.choices.length}if(c<0){return false}if(c%100>50){c+=a.choices.length}if(c%100>a.choices.length){return false}var d=Math.floor(c/100)||0;core.setFlag("timeout",d);c%=100}else{core.setFlag("timeout",0)}core.status.event.selection=c;setTimeout(function(){core.status.route.push("choices:"+b);if(c!="none"){var e=a.choices[c];if(e.need!=null&&e.need!=""&&!core.calValue(e.need)){core.control._replay_error("无法选择项："+b);return}else{core.insertAction(e.action)}}core.doAction()},core.status.replay.speed==24?1:750/Math.max(1,core.status.replay.speed));return true};events.prototype._precompile_choices=function(a){if(!(a.choices instanceof Array)){return a}for(var b=0;b<a.choices.length;++b){a.choices[b].condition=core.replaceValue(a.choices[b].condition);a.choices[b].text=this.__precompile_text(a.choices[b].text);a.choices[b].action=this.precompile(a.choices[b].action)}return a};events.prototype._action_confirm=function(b,e,f,d){b.text=core.replaceText(b.text,d);core.status.event.ui={text:b.text,yes:b.yes,no:b.no};if(core.isReplaying()){var a=core.status.replay.toReplay.shift();if(a.indexOf("choices:")==0&&!(a=="choices:none"&&!b.timeout)){var c=a.substring(8);if(c=="none"||((c=parseInt(c))>=0)&&c%100<2){this.__action_confirm_replaying(b,c)}else{core.control._replay_error(a);return}}else{if(a!="choices:none"){core.status.replay.toReplay.unshift(a)}this.__action_confirm_replaying(b,b["default"]?0:1)}}else{core.status.event.selection=b["default"]?0:1;if(b.timeout){core.status.event.interval=setTimeout(function(){core.status.route.push("choices:none");core.setFlag("timeout",0);core.doAction()},b.timeout)}core.status.event.timeout=new Date().getTime()+(b.timeout||0)}core.ui.drawConfirmBox(b.text)};events.prototype.__action_confirm_replaying=function(a,b){if(b!="none"){var c=Math.floor(b/100)||0;core.setFlag("timeout",c);b%=100}else{core.setFlag("timeout",0)}core.status.event.selection=b;setTimeout(function(){core.status.route.push("choices:"+b);if(b!="none"){if(b==0){core.insertAction(a.yes)}else{core.insertAction(a.no)}}core.doAction()},core.status.replay.speed==24?1:750/Math.max(1,core.status.replay.speed))};events.prototype._precompile_confirm=function(a){a.yes=this.precompile(a.yes);a.no=this.precompile(a.no);return a};events.prototype._action_for=function(b,j,k,e){if(!/^temp:[A-Z]$/.test(b.name)){core.insertAction("循环遍历事件只支持临时变量！");return core.doAction()}var c=core.calValue(b.from);var h=core.calValue(b.to);var f=core.calValue(b.step);if(typeof c!="number"||typeof h!="number"||typeof f!="number"){core.insertAction("循环遍历事件要求【起始点】【终止点】【每步】仅能是数字！");return core.doAction()}if((f>0&&c>h)||(f<0&&c<h)){core.doAction();return}var d=b.name.substring(5);core.setFlag("@temp@"+d,c);var i="@temp@for-to@"+d;var g="@temp@for-step@"+d;core.setFlag(i,b.to);core.setFlag(g,b.step);var a="(function () {var to = core.calValue(core.getFlag('"+i+"'));var step = core.calValue(core.getFlag('"+g+"'));if (typeof step != 'number' || typeof to != 'number') return false;if (step == 0) return true;var currentValue = core.getFlag('@temp@"+d+"');currentValue += step;core.setFlag('@temp@"+d+"', currentValue);if (step > 0) { return currentValue <= to; }else { return currentValue >= to; }})()";return this._action_dowhile({condition:a,data:b.data},j,k,e)};events.prototype._precompile_for=function(a){a.from=core.replaceValue(a.from);a.to=core.replaceValue(a.to);a.step=core.replaceValue(a.step);a.data=this.precompile(a.data);return a};events.prototype._action_forEach=function(b,e,f,d){if(!/^temp:[A-Z]$/.test(b.name)){core.insertAction(["循环遍历事件只支持临时变量！"]);return core.doAction()}var c="@temp@forEach@"+b.name.substring(5);core.setFlag(c,core.clone(b.list));var a="(function () {var list = core.getFlag('"+c+"', []);if (list.length == 0) return false;core.setFlag('@temp@'+'"+b.name.substring(5)+"', list.shift());return true;})()";return this._action_while({condition:a,data:b.data},e,f,d)};events.prototype._precompile_forEach=function(a){a.data=this.precompile(a.data);return a};events.prototype._action_while=function(a,d,e,c){if(core.calValue(a.condition,c)){var b=core.clone(a.data);if(!(b instanceof Array)){b=[b]}b.push({type:"_label"});core.unshift(core.status.event.data.list,{todo:b,total:core.clone(b),condition:a.condition})}core.doAction()};events.prototype._precompile_while=function(a){a.condition=core.replaceValue(a.condition);a.data=this.precompile(a.data);return a};events.prototype._action_dowhile=function(a,d,e,c){var b=core.clone(a.data);if(!(b instanceof Array)){b=[b]}b.push({type:"_label"});core.unshift(core.status.event.data.list,{todo:b,total:core.clone(b),condition:a.condition});core.doAction()};events.prototype._precompile_dowhile=function(a){a.condition=core.replaceValue(a.condition);a.data=this.precompile(a.data);return a};events.prototype._action_break=function(a,d,e,c){var b=a.n||1;while(b--){if(core.status.event.data.list.length>1){core.status.event.data.list.shift()}}core.doAction()};events.prototype._action_continue=function(a,d,e,c){var b=a.n||1;while(b-->1){if(core.status.event.data.list.length>1){core.status.event.data.list.shift()}}if(core.status.event.data.list.length>1){if(core.calValue(core.status.event.data.list[0].condition,c)){core.status.event.data.list[0].todo=core.clone(core.status.event.data.list[0].total)}else{core.status.event.data.list.shift()}}core.doAction()};events.prototype._action_win=function(a,c,d,b){this.win(core.replaceText(a.reason,b),a.norank,a.noexit)};events.prototype._action_lose=function(a,c,d,b){this.lose(core.replaceText(a.reason,b))};events.prototype._action_restart=function(a,c,d,b){core.restart()};events.prototype._action_function=function(data,x,y,prefix){var func=data["function"];try{if(typeof func=="string"&&func.indexOf("function")==0){eval("("+func+")()")}}catch(e){console.error(e)}if(!data.async){core.doAction()}};events.prototype._action_update=function(a,c,d,b){core.updateStatusBar(a.doNotCheckAutoEvents,true);core.doAction()};events.prototype._action_showStatusBar=function(a,c,d,b){core.showStatusBar();core.doAction()};events.prototype._action_hideStatusBar=function(a,c,d,b){core.hideStatusBar(a.toolbox);core.doAction()};events.prototype._action_showHero=function(a,c,d,b){a.opacity=1;return this._action_setHeroOpacity(a,c,d,b)};events.prototype._action_hideHero=function(a,c,d,b){a.opacity=0;return this._action_setHeroOpacity(a,c,d,b)};events.prototype._action_setHeroOpacity=function(a,c,d,b){a.time=a.time||0;if(a.opacity==null){a.opacity=1}if(a.time>0){this.__action_doAsyncFunc(a.async,core.setHeroOpacity,a.opacity,a.moveMode,a.time)}else{core.setFlag("__heroOpacity__",a.opacity);core.drawHero();core.doAction()}};events.prototype._action_vibrate=function(a,c,d,b){this.__action_doAsyncFunc(a.async,core.vibrate,a.direction,a.time,a.speed,a.power)};events.prototype._action_sleep=function(a,c,d,b){core.timeout.sleepTimeout=setTimeout(function(){core.timeout.sleepTimeout=null;core.doAction()},core.isReplaying()?Math.min(a.time,20):a.time)};events.prototype._action_wait=function(b,e,f,c){if(core.isReplaying()){var a=core.status.replay.toReplay.shift();if(a.indexOf("input:")==0&&!(a=="input:none"&&!b.timeout)){if(a=="input:none"){core.status.route.push("input:none");core.setFlag("type",-1);core.setFlag("timeout",0);this.__action_wait_afterGet(b);return core.doAction()}else{var d=parseInt(a.substring(6));core.status.route.push("input:"+d);this.__action_wait_getValue(d);if(this.__action_wait_afterGet(b)||!b.forceChild){return core.doAction()}}}core.control._replay_error(a);return}else{if(b.timeout){core.status.event.interval=setTimeout(function(){core.status.route.push("input:none");core.setFlag("type",-1);core.setFlag("timeout",0);core.events.__action_wait_afterGet(b);core.doAction()},b.timeout)}}core.status.event.timeout=new Date().getTime()+(b.timeout||0)};events.prototype.__action_wait_getValue=function(c){core.setFlag("timeout",Math.floor(c/100000000)||0);c%=100000000;if(c>=1000000){core.setFlag("type",1);var a=parseInt((c-1000000)/1000),b=c%1000;core.setFlag("px",a);core.setFlag("py",b);core.setFlag("x",parseInt(a/32));core.setFlag("y",parseInt(b/32))}else{if(c>=10000){core.setFlag("type",1);var d=parseInt((c-10000)/100),e=c%100;core.setFlag("px",32*d+16);core.setFlag("py",32*e+16);core.setFlag("x",d);core.setFlag("y",e)}else{if(c>0){core.setFlag("type",0);core.setFlag("keycode",c)}}}};events.prototype.__action_wait_afterGet=function(a){if(!a.data){return false}var d=[];var c=false;var b=false;a.data.forEach(function(h){if(h._disabled||c){return}if(h["case"]=="keyboard"&&core.getFlag("type")==0){(h.keycode+"").split(",").forEach(function(e){if(core.getFlag("keycode",0)==e){b=true;core.push(d,h.action);if(h["break"]){c=true}}})}if(h["case"]=="mouse"&&h.px instanceof Array&&h.py instanceof Array&&core.getFlag("type")==1){var k=core.calValue(h.px[0]);var j=core.calValue(h.px[1]);var n=core.calValue(h.py[0]);var m=core.calValue(h.py[1]);var i=core.getFlag("px",0),l=core.getFlag("py",0);if(i>=k&&i<=j&&l>=n&&l<=m){b=true;core.push(d,h.action);if(h["break"]){c=true}}}if(h["case"]=="condition"){var f=false;try{f=core.calValue(h.condition)}catch(g){}if(f){b=true;core.push(d,h.action);if(h["break"]){c=true}}}if(h["case"]=="timeout"&&core.getFlag("type")==-1){b=true;core.push(d,h.action);if(h["break"]){c=true}}});if(b){core.insertAction(d);return true}return false};events.prototype._precompile_wait=function(a){if(a.data){a.data.forEach(function(b){if(b.px!=null){b.px=this.__precompile_array(b.px)}if(b.py!=null){b.py=this.__precompile_array(b.py)}if(b.condition!=null){b.condition=this.__precompile_array(b.condition)}b.action=this.precompile(b.action)},this)}return a};events.prototype._action_waitAsync=function(a,d,e,b){var c=window.setInterval(function(){if(!core.hasAsync()&&(a.excludeAnimates||core.isReplaying()||core.getPlayingAnimates().length==0)&&(!a.includeSounds||core.isReplaying()||core.getPlayingSounds().length==0)){clearInterval(c);core.doAction()}},50/core.status.replay.speed)};events.prototype._action_stopAsync=function(a,c,d,b){core.stopAsync();core.doAction()};events.prototype._action_callBook=function(a,d,f,c){if(core.isReplaying()||!core.hasItem("book")){core.doAction()}else{var b=core.clone(core.status.event.data);core.ui.closePanel();core.openBook();core.status.event.interval=b}};events.prototype._action_callSave=function(a,f,g,d){if(core.isReplaying()||core.hasFlag("__events__")){core.removeFlag("__events__");core.doAction()}else{var b=core.clone(core.status.event.data);core.ui.closePanel();var c=core.hasFlag("__forbidSave__");core.removeFlag("__forbidSave__");core.save();if(c){core.setFlag("__forbidSave__",true)}core.status.event.interval=b}};events.prototype._action_autoSave=function(a,d,e,c){var b=core.hasFlag("__forbidSave__");core.removeFlag("__forbidSave__");core.autosave(a.removeLast);if(b){core.setFlag("__forbidSave__",true)}core.doAction()};events.prototype._action_forbidSave=function(a,c,d,b){core.setFlag("__forbidSave__",a.forbid||null);core.doAction()};events.prototype._action_callLoad=function(a,d,f,c){if(this.__action_checkReplaying()){return}var b=core.clone(core.status.event.data);core.ui.closePanel();core.load();core.status.event.interval=b};events.prototype._action_exit=function(a,c,d,b){this.setEvents([]);core.doAction()};events.prototype._action_previewUI=function(a,c,d,b){this.insertAction(a.action);core.doAction()};events.prototype._precompile_previewUI=function(a){a.action=this.precompile(a.action);return a};events.prototype.__action_doUIEvent=function(b){this.__action_doUIEvent_doOne(b);var a=core.status.event.data.list[0];while(a.todo.length>0){b=a.todo[0];if(this.__action_doUIEvent_doOne(a.todo[0])){a.todo.shift()}else{break}}core.doAction()};events.prototype.__action_doUIEvent_doOne=function(a){if(core.ui["_uievent_"+a.type]){core.ui["_uievent_"+a.type](a);return true}return false};events.prototype._action_clearMap=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_fillText=function(a,c,d,b){a.text=core.replaceText(a.text,b);this.__action_doUIEvent(a)};events.prototype._action_fillBoldText=function(a,c,d,b){a.text=core.replaceText(a.text,b);this.__action_doUIEvent(a)};events.prototype._action_fillRect=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_fillPolygon=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._precompile_fillPolygon=function(a){a.nodes=this.__precompile_array(a.nodes);return a};events.prototype._action_strokeRect=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_strokePolygon=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._precompile_strokePolygon=function(a){a.nodes=this.__precompile_array(a.nodes);return a};events.prototype._action_fillEllipse=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_strokeEllipse=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_fillArc=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_strokeArc=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_drawLine=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_drawArrow=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_setAttribute=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_setFilter=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_drawImage=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_drawIcon=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_drawSelector=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_drawBackground=function(a,c,d,b){this.__action_doUIEvent(a)};events.prototype._action_drawTextContent=function(a,c,d,b){a.text=core.replaceText(a.text,b);this.__action_doUIEvent(a)};events.prototype._checkStatus=function(c,b,a){if(b&&core.status.event.id==c){core.ui.closePanel();return false}if(b&&core.status.lockControl){return false}if(a&&!core.hasItem(c)){core.playSound("操作失败");core.drawTip("你没有"+core.material.items[c].name,c);return false}if(core.isMoving()){core.playSound("操作失败");core.drawTip("请先停止勇士行动");return false}core.lockControl();core.status.event.id=c;return true};events.prototype.openBook=function(a){if(core.isReplaying()){return}if(core.status.event.id=="book"&&core.events.recoverEvents(core.status.event.interval)){return}if(core.status.event.id=="book"&&core.status.event.ui){core.status.boxAnimateObjs=[];core.ui._drawViewMaps(core.status.event.ui);return}if(core.status.event.id=="viewMaps"){a=false;core.status.event.ui=core.status.event.data}if(!this._checkStatus("book",a,true)){return}core.playSound("打开界面");core.useItem("book",true)};events.prototype.useFly=function(a){if(core.isReplaying()){return}if(core.status.event.id=="viewMaps"){if(!core.hasItem("fly")){core.playSound("操作失败");core.drawTip("你没有"+core.material.items.fly.name,"fly")}else{if(!core.canUseItem("fly")||(core.flags.flyNearStair&&!core.nearStair())){core.playSound("操作失败");core.drawTip("无法传送到当前层","fly")}else{core.flyTo(core.status.event.data.floorId)}}return}if(!this._checkStatus("fly",a,true)){return}if(core.flags.flyNearStair&&!core.nearStair()){core.playSound("操作失败");core.drawTip("只有在楼梯边才能使用"+core.material.items.fly.name,"fly");core.unlockControl();core.status.event.data=null;core.status.event.id=null;return}if(!core.canUseItem("fly")){core.playSound("操作失败");core.drawTip(core.material.items.fly.name+"好像失效了","fly");core.unlockControl();core.status.event.data=null;core.status.event.id=null;return}core.playSound("打开界面");core.useItem("fly",true);return};events.prototype.flyTo=function(b,a){return this.eventdata.flyTo(b,a)};events.prototype.openEquipbox=function(a){if(core.isReplaying()){return}if(!this._checkStatus("equipbox",a)){return}core.playSound("打开界面");core.ui._drawEquipbox()};events.prototype.openToolbox=function(a){if(core.isReplaying()){return}if(!this._checkStatus("toolbox",a)){return}core.playSound("打开界面");core.ui._drawToolbox()};events.prototype.openQuickShop=function(a){if(core.isReplaying()){return}if(Object.keys(core.status.shops).length==0){core.playSound("操作失败");core.drawTip("本游戏没有快捷商店！");return}if(Object.keys(core.status.shops).length==1){var c=Object.keys(core.status.shops)[0];if(core.status.event.id!=null){return}if(!core.canOpenShop(c)){core.playSound("操作失败");core.drawTip("当前无法打开快捷商店！");return}var b=core.canUseQuickShop(c);if(b!=null){core.playSound("操作失败");core.drawTip(b);return}core.openShop(c,false);return}if(!this._checkStatus("selectShop",a)){return}core.ui._drawQuickShop()};events.prototype.openKeyBoard=function(a){if(core.isReplaying()){return}if(!this._checkStatus("keyBoard",a)){return}core.ui._drawKeyBoard()};events.prototype.save=function(a){if(core.isReplaying()){return}if(core.hasFlag("__forbidSave__")){core.playSound("操作失败");core.drawTip("当前禁止存档");return}if(core.status.event.id=="save"&&core.events.recoverEvents(core.status.event.interval)){return}if(!this._checkStatus("save",a)){return}var d=core.saves.saveIndex;var c=parseInt((d-1)/5),b=d-5*c;core.playSound("打开界面");core.ui._drawSLPanel(10*c+b)};events.prototype.load=function(a){if(core.isReplaying()){return}var d=core.saves.saveIndex;var c=parseInt((d-1)/5),b=d-5*c;if(!core.isPlaying()){core.dom.startPanel.style.display="none";core.clearStatus();core.clearMap("all");core.status.event={id:"load",data:null};core.status.lockControl=true;core.playSound("打开界面");core.ui._drawSLPanel(10*c+b);return}if(core.status.event.id=="load"&&core.events.recoverEvents(core.status.event.interval)){return}if(!this._checkStatus("load",a)){return}core.playSound("打开界面");core.ui._drawSLPanel(10*c+b)};events.prototype.openSettings=function(a){if(core.isReplaying()){return}if(!this._checkStatus("settings",a)){return}core.playSound("打开界面");core.ui._drawSettings()};events.prototype.hasAsync=function(){return Object.keys(core.animateFrame.asyncId).length>0};events.prototype.stopAsync=function(){var a=[];for(var b in core.animateFrame.asyncId){clearInterval(b);a.push(core.animateFrame.asyncId[b])}core.animateFrame.asyncId={};a.forEach(function(c){if(c&&c instanceof Function){c()}})};events.prototype.hasAsyncAnimate=function(){return(core.status.animateObjs||[]).length>0};events.prototype.follow=function(a){a=core.getMappedName(a);if(core.material.images.images[a]){core.status.hero.followers.push({name:a});core.gatherFollowers();core.clearMap("hero");core.drawHero()}core.clearRouteFolding()};events.prototype.unfollow=function(b){if(!b){core.status.hero.followers=[]}else{b=core.getMappedName(b);for(var a=0;a<core.status.hero.followers.length;a++){if(core.status.hero.followers[a].name==b){core.status.hero.followers.splice(a,1);break}}}core.gatherFollowers();core.clearMap("hero");core.drawHero();core.clearRouteFolding()};events.prototype._updateValueByOperator=function(c,b,a){switch(a){case"+=":c=b+c;break;case"-=":c=b-c;break;case"*=":c=b*c;break;case"/=":c=b/c;break;case"**=":c=Math.pow(b,c);break;case"//=":c=Math.trunc(b/c);break;case"%=":c=b%c;break;case"min=":c=Math.min(b,c);break;case"max=":c=Math.max(b,c);break;default:break}return c};events.prototype.setValue=function(a,b,d,c){d=this._updateValueByOperator(core.calValue(d,c),core.calValue(a,c),b);this._setValue_setStatus(a,d);this._setValue_setBuff(a,d);this._setValue_setItem(a,d);this._setValue_setFlag(a,d);this._setValue_setSwitch(a,d,c);this._setValue_setTemp(a,d,c);this._setValue_setGlobal(a,d)};events.prototype._setValue_setStatus=function(a,b){if(a.indexOf("status:")!==0){return}core.setStatus(a.substring(7),b)};events.prototype._setValue_setBuff=function(a,b){if(a.indexOf("buff:")!==0){return}core.setBuff(a.substring(5),b)};events.prototype._setValue_setItem=function(c,d){if(c.indexOf("item:")!==0){return}var b=c.substring(5),a=core.itemCount(b);if(d>a){core.getItem(b,d-a)}else{core.setItem(b,d)}};events.prototype._setValue_setFlag=function(a,b){if(a.indexOf("flag:")!==0){return}core.setFlag(a.substring(5),b)};events.prototype._setValue_setSwitch=function(a,c,b){if(a.indexOf("switch:")!==0){return}core.setFlag((b||":f@x@y")+"@"+a.substring(7),c)};events.prototype._setValue_setTemp=function(a,b){if(a.indexOf("temp:")!==0){return}core.setFlag("@temp@"+a.substring(5),b)};events.prototype._setValue_setGlobal=function(a,b){if(a.indexOf("global:")!==0){return}core.setGlobal(a.substring(7),b)};events.prototype.setEnemy=function(b,c,g,e,f,d){if(!core.hasFlag("enemyInfo")){core.setFlag("enemyInfo",{})}var a=core.getFlag("enemyInfo");if(!a[b]){a[b]={}}if(typeof g==="string"&&c=="name"){g=g.replace(/\r/g,"\\r")}g=this._updateValueByOperator(core.calValue(g,f),(core.material.enemys[b]||{})[c],e);a[b][c]=g;(core.material.enemys[b]||{})[c]=core.clone(g);if(!d){core.updateStatusBar()}};events.prototype.setEnemyOnPoint=function(i,j,c,d,h,f,g,e){c=c||core.status.floorId;var a=core.getBlock(i,j,c);if(a==null){return}if(a.event.cls.indexOf("enemy")!=0){return}var b=core.material.enemys[a.event.id];if(b==null){return}if(typeof h==="string"&&d=="name"){h=h.replaceAll(/\r/g,"\\r")}h=this._updateValueByOperator(core.calValue(h,g),core.getEnemyValue(b,d,i,j,c),f);flags.enemyOnPoint=flags.enemyOnPoint||{};flags.enemyOnPoint[c]=flags.enemyOnPoint[c]||{};flags.enemyOnPoint[c][i+","+j]=flags.enemyOnPoint[c][i+","+j]||{};flags.enemyOnPoint[c][i+","+j][d]=h;if(!e){core.updateStatusBar()}};events.prototype.resetEnemyOnPoint=function(c,d,a,b){delete ((flags.enemyOnPoint||{})[a||core.status.floorId]||{})[c+","+d];if(!b){core.updateStatusBar()}};events.prototype.moveEnemyOnPoint=function(b,c,e,f,a,d){a=a||core.status.floorId;if(((flags.enemyOnPoint||{})[a]||{})[b+","+c]){flags.enemyOnPoint[a][e+","+f]=flags.enemyOnPoint[a][b+","+c];delete flags.enemyOnPoint[a][b+","+c];if(!d){core.updateStatusBar()}}};events.prototype.setFloorInfo=function(b,d,a,c){a=a||core.status.floorId;core.status.maps[a][b]=d;core.updateStatusBar()};events.prototype.setGlobalAttribute=function(name,value){if(typeof value=="string"){if((value.charAt(0)=='"'&&value.charAt(value.length-1)=='"')||(value.charAt(0)=="'"&&value.charAt(value.length-1)=="'")){value=value.substring(1,value.length-1)}if(value.charAt(0)=="["&&value.charAt(value.length-1)=="]"){value=eval(value)}if(/^[0-9 ]+,[0-9 ]+,[0-9 ]+(,[0-9. ]+)?$/.test(value)){value="rgba("+value+")"}}core.status.globalAttribute[name]=value;core.setFlag("globalAttribute",core.status.globalAttribute);core.resize()};events.prototype.setGlobalFlag=function(b,d){var a=core.getFlag("globalFlags",{});if(b.startsWith("s:")){b=b.substring(2);var c=core.flags.statusBarItems.filter(function(e){return e!=b});if(d){c.push(b)}core.flags.statusBarItems=c;a.statusBarItems=core.clone(c)}else{a[b]=core.flags[b]=d}core.setFlag("globalFlags",a);core.resize();if(b=="blurFg"){core.redrawMap()}};events.prototype.setNameMap=function(a,b){if(!core.hasFlag("__nameMap__")){core.setFlag("__nameMap__",{})}flags.__nameMap__[a]=b};events.prototype.setTextAttribute=function(a){if(!core.isPlaying()){return}["position","offset","align","bold","titlefont","textfont","lineHeight","time","letterSpacing","animateTime"].forEach(function(b){if(a[b]!=null){core.status.textAttribute[b]=a[b]}});["background","title","text"].forEach(function(d){if((a[d] instanceof Array)&&a[d].length>=3){if(a[d].length==3){a[d].push(1)}core.status.textAttribute[d]=a[d]}if(d=="background"){var c=core.getMappedName(a[d]);var b=core.material.images.images[c];if(b&&b.width==192&&b.height==128){core.status.textAttribute[d]=c}}});if(main.mode=="play"){core.setFlag("textAttribute",core.status.textAttribute)}};events.prototype.moveTextBox=function(b,f,k,h,n,a){var c=core.getContextByName("__text__"+b);if(!c){if(a){a()}return}var l=parseInt(c.canvas.getAttribute("_text_left"))||0;var m=parseInt(c.canvas.getAttribute("_text_top"))||0;var d=k?f[0]:(f[0]-l);var e=k?f[1]:(f[1]-m);var i=parseInt(c.canvas.getAttribute("_left"))||0;var j=parseInt(c.canvas.getAttribute("_top"))||0;if(!n){core.relocateCanvas(c,i+d,j+e);c.canvas.setAttribute("_text_left",f[0]);c.canvas.setAttribute("_text_top",f[1]);if(a){a()}return}var g={sx:l,sy:m,dx:d,dy:e,ox:i,oy:j,moveMode:h,time:n/Math.max(core.status.replay.speed,1)};this._moveTextBox_moving(c,g,a)};events.prototype._moveTextBox_moving=function(c,e,b){var f=0,g=e.time/10;if(g<=0){g=1}var d=core.applyEasing(e.moveMode);var a=setInterval(function(){f++;var h=e.dx*d(f/g);var i=e.dy*d(f/g);core.relocateCanvas(c,parseInt(e.ox+h),parseInt(e.oy+i));c.canvas.setAttribute("_text_left",e.sx+h);c.canvas.setAttribute("_text_top",e.sy+i);if(f==g){delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}}},10);core.animateFrame.lastAsyncId=a;core.animateFrame.asyncId[a]=b};events.prototype.clearTextBox=function(c,b){if(c==null){c=Object.keys(core.dymCanvas).filter(function(e){return e.startsWith("__text__")}).map(function(e){return e.substring("__text__".length)})}if(!(c instanceof Array)){c=[c]}var d=0;var a=function(){if(d==c.length){if(b){b()}return}var e="__text__"+c[d++];if(!core.getContextByName(e)){return a()}core.ui._animateUI("hide",e,function(){core.deleteCanvas(e);a()})};a()};events.prototype.closeDoor=function(i,j,g,d){g=g||"";if((core.material.icons.animates[g]==null&&core.material.icons.npc48[g]==null)||core.getBlock(i,j)!=null){if(d){d()}return}var b=core.getBlockById(g);var f=(b.event||{}).doorInfo;if(!f){if(d){d()}return}core.playSound(f.closeSound);var c=core.getBlockInfo(b);var h=(f.time||160)/4;c.posX=3;core.maps._drawBlockInfo(c,i,j);var e=function(){core.setBlock(g,i,j);core.showBlock(i,j);if(d){d()}};var a=window.setInterval(function(){c.posX--;if(c.posX<0){clearInterval(a);delete core.animateFrame.asyncId[a];e();return}core.maps._drawBlockInfo(c,i,j)},core.status.replay.speed==24?1:h/Math.max(core.status.replay.speed,1));core.animateFrame.lastAsyncId=a;core.animateFrame.asyncId[a]=e};events.prototype.showImage=function(b,e,l,g,j,p,a){var f=null;if(typeof e=="string"){f=e;if(e.endsWith(":x")||e.endsWith(":y")||e.endsWith(":o")){e=e.substring(0,e.length-2)}e=core.getMappedName(e);e=core.material.images.images[e]}if(!e){if(a){a()}return}l=l||[];var n=core.calValue(l[0])||0,o=core.calValue(l[1])||0;var m=core.calValue(l[2]),k=core.calValue(l[3]);if(m==null){m=e.width}if(k==null){k=e.height}g=g||[];var r=core.calValue(g[0])||0,s=core.calValue(g[1])||0;var q=core.calValue(g[2]),d=core.calValue(g[3]);if(q==null){q=m}if(d==null){d=k}var t=b+100;p=p||0;var i="image"+t;var c=core.createCanvas(i,r,s,q,d,t);core.drawImage(c,f==null?e:f,n,o,m,k,0,0,q,d);if(p==0){core.setOpacity(i,j);if(a){a()}return}core.setOpacity(i,0);this.moveImage(b,null,j,null,p,a)};events.prototype.hideImage=function(b,d,a){d=d||0;var c="image"+(b+100);if(d==0||!core.dymCanvas[c]){core.deleteCanvas(c);if(a){a()}return}this.moveImage(b,null,0,null,d,function(){core.deleteCanvas(c);if(a){a()}})};events.prototype.moveImage=function(c,l,j,g,k,a){l=l||[];var h="image"+(c+100);if(!core.dymCanvas[h]){if(a){a()}return}var f=function(p,q){p=core.calValue(p);return p!=null?p:q};var b=core.dymCanvas[h].canvas;var d=parseFloat(b.getAttribute("_left")),e=parseFloat(b.getAttribute("_top")),n=f(l[0],d),o=f(l[1],e);var i=parseFloat(b.style.opacity),m=f(j,i);if(!k){core.relocateCanvas(h,n,o);core.setOpacity(m);if(a){a()}return}this._moveImage_moving(h,{fromX:d,fromY:e,toX:n,toY:o,opacity:i,toOpacity:m,moveMode:g,time:k/Math.max(core.status.replay.speed,1)},a)};events.prototype._moveImage_moving=function(j,i,b){var l=10,m=0,n=parseInt(i.time/l);if(n<=0){n=1}var f=i.fromX,g=i.fromY,p=i.toX,q=i.toY,k=i.opacity,o=i.toOpacity;var d=f,e=g,c=k;var h=core.applyEasing(i.moveMode);var a=setInterval(function(){m++;c=k+(o-k)*h(m/n);d=parseInt(f+(p-f)*h(m/n));e=parseInt(g+(q-g)*h(m/n));core.setOpacity(j,c);core.relocateCanvas(j,d,e);if(m==n){delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}}},l);core.animateFrame.lastAsyncId=a;core.animateFrame.asyncId[a]=b};events.prototype.rotateImage=function(g,d,a,i,l,b){d=d||[];var j="image"+(g+100);if(!core.dymCanvas[j]){if(b){b()}return}var c=core.dymCanvas[j].canvas;var e=core.calValue(d[0]),f=core.calValue(d[1]);var h=parseFloat(c.getAttribute("_angle"))||0;if(!l){core.rotateCanvas(j,h+a,e,f);if(b){b()}return}var k={fromAngle:h,angle:a,centerX:e,centerY:f,moveMode:i,time:l/Math.max(core.status.replay.speed,1)};this._rotateImage_rotating(j,k,b)};events.prototype._rotateImage_rotating=function(d,f,b){var e=10,g=0,h=parseInt(f.time/e);if(h<=0){h=1}var c=core.applyEasing(f.moveMode);var a=setInterval(function(){g++;var i=f.fromAngle+f.angle*c(g/h);core.rotateCanvas(d,i,f.centerX,f.centerY);if(g==h){delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}}},e);core.animateFrame.lastAsyncId=a;core.animateFrame.asyncId[a]=b};events.prototype.scaleImage=function(e,b,n,k,p,a){b=b||[];var l="image"+(e+100);if(!core.dymCanvas[l]){if(a){a()}return}var f=core.dymCanvas[l];var h=1;if(f.canvas.hasAttribute("_scale")){h=parseFloat(f.canvas.getAttribute("_scale"))}var m=f.canvas.hasAttribute("isHD")?core.domStyle.ratio:1;var q=f.canvas.width/m,j=f.canvas.height/m;var g=parseFloat(f.canvas.getAttribute("_left"));var i=parseFloat(f.canvas.getAttribute("_top"));var c=core.calValue(b[0]),d=core.calValue(b[1]);if(c==null||d==null){c=g+q*h/2;d=i+j*h/2}var o={x:(g-c)/h,y:(i-d)/h,centerX:c,centerY:d,width:q,height:j,currScale:h,scale:n,moveMode:k,time:p};this._scaleImage_scale(f,o,a)};events.prototype._scaleInfo_scale=function(a,c,b){core.resizeCanvas(a,c.width*b,c.height*b,true);core.relocateCanvas(a,c.centerX+c.x*b,c.centerY+c.y*b);a.canvas.setAttribute("_scale",b)};events.prototype._scaleImage_scale=function(c,f,b){if(!f.time){this._scaleInfo_scale(c,f,f.scale);if(b){b()}return}var e=10,g=0,h=parseInt(f.time/e);if(h<=0){h=1}var d=core.applyEasing(f.moveMode);var a=setInterval(function(){g++;var i=f.currScale+(f.scale-f.currScale)*d(g/h);core.events._scaleInfo_scale(c,f,i);if(g==h){delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}}},e);core.animateFrame.lastAsyncId=a;core.animateFrame.asyncId[a]=b};events.prototype.showGif=function(c,d,e){c=core.getMappedName(c);var b=core.material.images.images[c];if(b){var a=new Image();a.src=b.src;a.style.position="absolute";a.style.left=d*core.domStyle.scale+"px";a.style.top=e*core.domStyle.scale+"px";a.style.width=b.width*core.domStyle.scale+"px";a.style.height=b.height*core.domStyle.scale+"px";core.dom.gif2.appendChild(a)}else{core.dom.gif2.innerHTML=""}};events.prototype.setVolume=function(i,h,b){var e=function(j){core.musicStatus.designVolume=j;if(core.musicStatus.playingBgm){core.material.bgms[core.musicStatus.playingBgm].volume=core.musicStatus.userVolume*core.musicStatus.designVolume}};if(!h||h<100){e(i);if(b){b()}return}var c=core.musicStatus.designVolume;h/=Math.max(core.status.replay.speed,1);var d=10,f=0,g=parseInt(h/d);if(g<=0){g=1}var a=setInterval(function(){f++;e(c+(i-c)*f/g);if(f>=g){delete core.animateFrame.asyncId[a];clearInterval(a);if(b){b()}}},d);core.animateFrame.lastAsyncId=a;core.animateFrame.asyncId[a]=b};events.prototype.vibrate=function(d,h,g,e,b){if(core.isReplaying()){if(b){b()}return}if(!h){h=1000}g=g||10;e=e||10;var f={duration:parseInt(h/10),speed:g,power:e,direction:1,shake:0};if(d=="random"){d=["horizontal","vertical","diagonal1","diagonal2"][Math.floor(Math.random()*4)]}var c=function(){core.addGameCanvasTranslate(0,0);if(b){b()}};var a=setInterval(function(){core.events._vibrate_update(f);switch(d){case"vertical":core.addGameCanvasTranslate(0,f.shake);break;case"diagonal1":core.addGameCanvasTranslate(f.shake,f.shake);break;case"diagonal2":core.addGameCanvasTranslate(-f.shake,f.shake);break;default:core.addGameCanvasTranslate(f.shake,0)}if(f.duration===0&&f.shake==0){delete core.animateFrame.asyncId[a];clearInterval(a);c()}},10);core.animateFrame.lastAsyncId=a;core.animateFrame.asyncId[a]=c};events.prototype._vibrate_update=function(b){if(b.duration>=1||b.shake!=0){var a=b.speed*b.direction/6;if(b.duration<=1&&b.shake*(b.shake+a)<0){b.shake=0}else{b.shake+=a}if(b.shake>b.power){b.direction=-1}if(b.shake<-b.power){b.direction=1}if(b.duration>=1){b.duration-=1}}};events.prototype.eventMoveHero=function(e,f,b){f=f||core.values.moveSpeed;var d=0,c=(e||[]).map(function(g){return[g.split(":")[0],parseInt(g.split(":")[1]||"1")]}).filter(function(g){return["up","down","left","right","forward","backward","leftup","leftdown","rightup","rightdown","speed"].indexOf(g[0])>=0&&!(g[0]=="speed"&&g[1]<16)});core.status.heroMoving=-1;var a=function(){var h=function(){core.status.heroMoving=0;core.drawHero();if(b){b()}};var g=window.setInterval(function(){if(c.length==0){delete core.animateFrame.asyncId[g];clearInterval(g);h()}else{if(d==0&&c[0][0]=="speed"&&c[0][1]>=16){f=c[0][1];c.shift();clearInterval(g);delete core.animateFrame.asyncId[g];a()}else{if(core.events._eventMoveHero_moving(++d,c)){d=0}}}},core.status.replay.speed==24?1:f/8/core.status.replay.speed);core.animateFrame.lastAsyncId=g;core.animateFrame.asyncId[g]=h};a()};events.prototype._eventMoveHero_moving=function(f,d){var a=d[0];var b=a[0],g=core.getHeroLoc("x"),h=core.getHeroLoc("y");var e=b=="backward"?-1:1;if(b=="forward"||b=="backward"){b=core.getHeroLoc("direction")}var c=b;if(b=="leftup"||b=="leftdown"){c="left"}if(b=="rightup"||b=="rightdown"){c="right"}core.setHeroLoc("direction",b);if(a[1]<=0){core.setHeroLoc("direction",c);d.shift();return true}if(f<=4){core.drawHero("leftFoot",4*e*f)}else{if(f<=8){core.drawHero("rightFoot",4*e*f)}}if(f==8){core.setHeroLoc("x",g+e*core.utils.scan2[b].x,true);core.setHeroLoc("y",h+e*core.utils.scan2[b].y,true);core.updateFollowers();a[1]--;if(a[1]<=0){d.shift()}core.setHeroLoc("direction",c);return true}return false};events.prototype.jumpHero=function(b,c,g,a){var e=core.getHeroLoc("x"),f=core.getHeroLoc("y");if(b==null){b=e}if(c==null){c=f}var e=core.status.hero.loc.x,f=core.status.hero.loc.y;if(!core.isset(b)){b=e}if(!core.isset(c)){c=f}var d=core.maps.__generateJumpInfo(e,f,b,c,g||500);d.icon=core.material.icons.hero[core.getHeroLoc("direction")];d.width=core.material.icons.hero.width||32;d.height=core.material.icons.hero.height;this._jumpHero_doJump(d,a)};events.prototype._jumpHero_doJump=function(d,b){var c=function(){core.setHeroLoc("x",d.ex);core.setHeroLoc("y",d.ey);core.status.heroMoving=0;core.drawHero();if(b){b()}};core.status.heroMoving=-1;var a=window.setInterval(function(){if(d.jump_count>0){core.events._jumpHero_jumping(d)}else{delete core.animateFrame.asyncId[a];clearInterval(a);c()}},d.per_time);core.animateFrame.lastAsyncId=a;core.animateFrame.asyncId[a]=c};events.prototype._jumpHero_jumping=function(b){core.clearMap("hero");core.maps.__updateJumpInfo(b);var f=core.getHeroLoc("x"),g=core.getHeroLoc("y");var c=b.px,d=b.py,e=b.width||32,a=b.height;core.drawHero("stop",{x:c-32*f,y:d-32*g})};events.prototype.setHeroIcon=function(b,c){b=core.getMappedName(b);var a=core.material.images.images[b];if(!a){console.error("找不到图片: "+a);return}if(core.material.images.hero==a){return}core.status.hero.image=b;core.material.images.hero=a;core.material.icons.hero.width=a.width/4;core.material.icons.hero.height=a.height/4;core.control.updateHeroIcon(b);if(!c){core.drawHero()}};events.prototype.checkLvUp=function(){var a=[];while(true){var b=this._checkLvUp_check();if(b==null){break}a=a.concat(b)}if(a.length>0){core.insertAction(a)}};events.prototype._checkLvUp_check=function(){if(core.flags.statusBarItems.indexOf("enableLevelUp")<0||!core.firstData.levelUp||core.status.hero.lv>=core.firstData.levelUp.length){return null}var b=(core.firstData.levelUp[core.status.hero.lv]||{});var a=core.calValue(b.need);if(a==null){return null}if(core.status.hero.exp>=a){core.status.hero.lv++;if(b.clear){core.status.hero.exp-=a}return b.action||[]}return null};events.prototype.tryUseItem=function(a){if(a=="book"){core.ui.closePanel();return core.openBook(false)}if(a=="fly"){core.ui.closePanel();return core.useFly(false)}if(a=="centerFly"){core.ui.closePanel();return core.ui._drawCenterFly()}if(core.canUseItem(a)){core.ui.closePanel();core.useItem(a)}else{core.playSound("操作失败");core.drawTip("当前无法使用"+core.material.items[a].name,a)}};"use strict";function actions(){this._init();this._HX_=core._HALF_WIDTH_;this._HY_=core._HALF_HEIGHT_;this._out=function(a){return a<this._HX_-2||this._HX_+2<a};this.LAST=core._WIDTH_-1}actions.prototype._init=function(){this.actionsdata=functions_d6ad677b_427a_4623_b50f_a445a3b0ef8a.actions;this.actions={};this.registerAction("onkeyDown","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onkeyDown","_sys_onkeyDown",this._sys_onkeyDown,0);this.registerAction("onkeyUp","_sys_onkeyUp_replay",this._sys_onkeyUp_replay,100);this.registerAction("onkeyUp","_sys_onkeyUp",this._sys_onkeyUp,0);this.registerAction("pressKey","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("pressKey","_sys_pressKey",this._sys_pressKey,0);this.registerAction("keyDown","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("keyDown","_sys_keyDown_lockControl",this._sys_keyDown_lockControl,50);this.registerAction("keyDown","_sys_keyDown",this._sys_keyDown,0);this.registerAction("keyUp","_sys_keyUp_replay",this._sys_keyUp_replay,100);this.registerAction("keyUp","_sys_keyUp_lockControl",this._sys_keyUp_lockControl,50);this.registerAction("keyUp","_sys_keyUp",this._sys_keyUp,0);this.registerAction("ondown","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("ondown","_sys_ondown_lockControl",this._sys_ondown_lockControl,30);this.registerAction("ondown","_sys_ondown",this._sys_ondown,0);this.registerAction("onmove","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onmove","_sys_onmove_choices",this._sys_onmove_choices,30);this.registerAction("onmove","_sys_onmove",this._sys_onmove,0);this.registerAction("onup","_sys_checkReplay",this._sys_checkReplay,100);this.registerAction("onup","_sys_onup",this._sys_onup,0);this.registerAction("onmousewheel","_sys_onmousewheel",this._sys_onmousewheel,0);this.registerAction("keyDownCtrl","_sys_keyDownCtrl",this._sys_keyDownCtrl,0);this.registerAction("longClick","_sys_longClick_lockControl",this._sys_longClick_lockControl,50);this.registerAction("onStatusBarClick","_sys_onStatusBarClick",this._sys_onStatusBarClick,0)};actions.prototype.registerAction=function(a,c,b,d){if(!c||!b){return}if(a=="onclick"){a="ondown"}d=d||0;if(!this.actions[a]){this.actions[a]=[]}this.unregisterAction(a,c);this.actions[a].push({action:a,name:c,func:b,priority:d});this.actions[a]=this.actions[a].sort(function(e,f){return f.priority-e.priority})};actions.prototype.unregisterAction=function(a,b){if(a=="onclick"){a="ondown"}if(!this.actions[a]){return}this.actions[a]=this.actions[a].filter(function(c){return c.name!=b})};actions.prototype.doRegisteredAction=function(a){var b=this.actions[a];if(!b){return false}for(var d=0;d<b.length;++d){try{if(core.doFunc.apply(core,[b[d].func,this].concat(Array.prototype.slice.call(arguments,1)))){return true}}catch(c){console.error(c);console.error("ERROR in actions["+b[d].name+"].")}}return false};actions.prototype._checkReplaying=function(){if(core.isReplaying()&&["save","book","book-detail","viewMaps","toolbox","equipbox","text"].indexOf(core.status.event.id)<0){return true}return false};actions.prototype._sys_checkReplay=function(){if(this._checkReplaying()){return true}};actions.prototype.__checkLeftHandPrefer=function(a){if(!core.flags.leftHandPrefer){return a}var b={87:38,83:40,65:37,68:39,73:87,74:65,75:83,76:68,};var c={};for(var d in a){if(!(a[d] instanceof Function)){c[d]=a[d]}}["stopPropagation","stopImmediatePropagation","preventDefault"].forEach(function(e){c[e]=function(){return a[e]()}});c.keyCode=b[a.keyCode]||a.keyCode;return c};actions.prototype.onkeyDown=function(a){this.doRegisteredAction("onkeyDown",this.__checkLeftHandPrefer(a))};actions.prototype._sys_onkeyDown=function(a){core.status.holdingKeys=core.status.holdingKeys||[];var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){return}}if(a.preventDefault){a.preventDefault()}core.status.holdingKeys.push(a.keyCode);this.pressKey(a.keyCode)}else{if(a.keyCode==17){core.status.ctrlDown=true}this.keyDown(a.keyCode)}};actions.prototype.onkeyUp=function(a){this.doRegisteredAction("onkeyUp",this.__checkLeftHandPrefer(a))};actions.prototype._sys_onkeyUp_replay=function(a){if(this._checkReplaying()){if(a.keyCode==27){core.stopReplay()}else{if(a.keyCode==90){core.speedDownReplay()}else{if(a.keyCode==67){core.speedUpReplay()}else{if(a.keyCode==32){core.triggerReplay()}else{if(a.keyCode==65){core.rewindReplay()}else{if(a.keyCode==83){core.control._replay_SL()}else{if(a.keyCode==88){core.control._replay_book()}else{if(a.keyCode==33||a.keyCode==34){core.control._replay_viewMap()}else{if(a.keyCode==78){core.stepReplay()}else{if(a.keyCode==84){core.control._replay_toolbox()}else{if(a.keyCode==81){core.control._replay_equipbox()}else{if(a.keyCode==66){core.ui._drawStatistics()}else{if(a.keyCode>=49&&a.keyCode<=51){core.setReplaySpeed(a.keyCode-48)}else{if(a.keyCode==52){core.setReplaySpeed(6)}else{if(a.keyCode==53){core.setReplaySpeed(12)}else{if(a.keyCode==54){core.setReplaySpeed(24)}}}}}}}}}}}}}}}}return true}};actions.prototype._sys_onkeyUp=function(a){var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){core.status.holdingKeys=core.status.holdingKeys.slice(0,b).concat(core.status.holdingKeys.slice(b+1));if(b===core.status.holdingKeys.length&&core.status.holdingKeys.length!==0){core.pressKey(core.status.holdingKeys.slice(-1)[0])}break}}if(a.preventDefault){a.preventDefault()}this.keyUp(a.keyCode,a.altKey)}else{if(a.keyCode==17){core.status.ctrlDown=false}this.keyUp(a.keyCode,a.altKey)}};actions.prototype.pressKey=function(a){this.doRegisteredAction("pressKey",a)};actions.prototype._sys_pressKey=function(a){if(a===core.status.holdingKeys.slice(-1)[0]){this.keyDown(a);window.setTimeout(function(){core.pressKey(a)},30)}};actions.prototype.keyDown=function(a){this.doRegisteredAction("keyDown",a)};actions.prototype._sys_keyDown_lockControl=function(a){if(!core.status.lockControl){return false}if(a==17){this.keyDownCtrl();return true}switch(core.status.event.id){case"action":this._keyDownAction(a);break;case"book":this._keyDownBook(a);break;case"fly":this._keyDownFly(a);break;case"viewMaps":this._keyDownViewMaps(a);break;case"equipbox":this._keyDownEquipbox(a);break;case"toolbox":this._keyDownToolbox(a);break;case"save":case"load":case"replayLoad":case"replayRemain":case"replaySince":this._keyDownSL(a);break;case"selectShop":case"switchs":case"switchs-sounds":case"switchs-display":case"switchs-action":case"notes":case"settings":case"syncSave":case"syncSelect":case"localSaveSelect":case"storageRemove":case"replay":case"gameInfo":this._keyDownChoices(a);break;case"cursor":this._keyDownCursor(a);break}return true};actions.prototype._sys_keyDown=function(a){if(!core.status.played){return true}switch(a){case 37:core.moveHero("left");break;case 38:core.moveHero("up");break;case 39:core.moveHero("right");break;case 40:core.moveHero("down");break}return true};actions.prototype.keyUp=function(c,a,b){this.doRegisteredAction("keyUp",c,a,b)};actions.prototype._sys_keyUp_replay=function(c,a,b){if(!b&&this._checkReplaying()){return true}};actions.prototype._sys_keyUp_lockControl=function(b,a){if(!core.status.lockControl){return false}var c=function(){return b==27||b==88||b==13||b==32||b==67};core.status.holdingKeys=[];switch(core.status.event.id){case"text":c()&&core.drawText();break;case"confirmBox":this._keyUpConfirmBox(b);break;case"action":this._keyUpAction(b);break;case"about":c()&&core.closePanel();break;case"help":c()&&core.closePanel();break;case"book":this._keyUpBook(b);break;case"book-detail":c()&&this._clickBookDetail();break;case"fly":this._keyUpFly(b);break;case"viewMaps":this._keyUpViewMaps(b);break;case"selectShop":this._keyUpQuickShop(b);break;case"toolbox":this._keyUpToolbox(b);break;case"equipbox":this._keyUpEquipbox(b,a);break;case"save":case"load":case"replayLoad":case"replayRemain":case"replaySince":this._keyUpSL(b);break;case"keyBoard":c()&&core.closePanel();break;case"switchs":this._keyUpSwitchs(b);break;case"switchs-sounds":this._keyUpSwitchs_sounds(b);break;case"switchs-display":this._keyUpSwitchs_display(b);break;case"switchs-action":this._keyUpSwitchs_action(b);break;case"settings":this._keyUpSettings(b);break;case"notes":this._keyUpNotes(b);break;case"syncSave":this._keyUpSyncSave(b);break;case"syncSelect":this._keyUpSyncSelect(b);break;case"localSaveSelect":this._keyUpLocalSaveSelect(b);break;case"storageRemove":this._keyUpStorageRemove(b);break;case"cursor":this._keyUpCursor(b);break;case"replay":this._keyUpReplay(b);break;case"gameInfo":this._keyUpGameInfo(b);break;case"centerFly":this._keyUpCenterFly(b);break}return true};actions.prototype._sys_keyUp=function(b,a){if(!core.status.played){return true}this.actionsdata.onKeyUp(b,a);if(core.status.automaticRoute&&core.status.automaticRoute.autoHeroMove){core.stopAutomaticRoute()}core.status.heroStop=true;return true};actions.prototype.ondown=function(a){var d=parseInt(a.x/a.size),e=parseInt(a.y/a.size);var b=parseInt(a.x/core.domStyle.scale),c=parseInt(a.y/core.domStyle.scale);this.doRegisteredAction("ondown",d,e,b,c)};actions.prototype._sys_ondown_lockControl=function(c,d,a,b){if(core.status.played&&!core.status.lockControl){return false}switch(core.status.event.id){case"centerFly":this._clickCenterFly(c,d,a,b);break;case"book":this._clickBook(c,d,a,b);break;case"book-detail":this._clickBookDetail(c,d,a,b);break;case"fly":this._clickFly(c,d,a,b);break;case"viewMaps":this._clickViewMaps(c,d,a,b);break;case"switchs":this._clickSwitchs(c,d,a,b);break;case"switchs-sounds":this._clickSwitchs_sounds(c,d,a,b);break;case"switchs-display":this._clickSwitchs_display(c,d,a,b);break;case"switchs-action":this._clickSwitchs_action(c,d,a,b);break;case"settings":this._clickSettings(c,d,a,b);break;case"selectShop":this._clickQuickShop(c,d,a,b);break;case"equipbox":this._clickEquipbox(c,d,a,b);break;case"toolbox":this._clickToolbox(c,d,a,b);break;case"save":case"load":case"replayLoad":case"replayRemain":case"replaySince":this._clickSL(c,d,a,b);break;case"confirmBox":this._clickConfirmBox(c,d,a,b);break;case"keyBoard":this._clickKeyBoard(c,d,a,b);break;case"action":this._clickAction(c,d,a,b);break;case"text":core.drawText();break;case"notes":this._clickNotes(c,d,a,b);break;case"syncSave":this._clickSyncSave(c,d,a,b);break;case"syncSelect":this._clickSyncSelect(c,d,a,b);break;case"localSaveSelect":this._clickLocalSaveSelect(c,d,a,b);break;case"storageRemove":this._clickStorageRemove(c,d,a,b);break;case"cursor":this._clickCursor(c,d,a,b);break;case"replay":this._clickReplay(c,d,a,b);break;case"gameInfo":this._clickGameInfo(c,d,a,b);break;case"about":case"help":core.ui.closePanel();break}if(core.timeout.onDownTimeout==null){core.timeout.onDownTimeout=setTimeout(function(){if(core.interval.onDownInterval==null){core.interval.onDownInterval=setInterval(function(){if(!core.actions.longClick(c,d,a,b)){clearInterval(core.interval.onDownInterval);core.interval.onDownInterval=null}},40)}},500)}return true};actions.prototype._sys_ondown=function(d,e,b,c){if(core.status.lockControl){return false}core.status.downTime=new Date();core.deleteCanvas("route");var a={x:parseInt((b+core.bigmap.offsetX)/32),y:parseInt((c+core.bigmap.offsetY)/32)};core.status.stepPostfix=[];core.status.stepPostfix.push(a);core.fillRect("ui",a.x*32+12-core.bigmap.offsetX,a.y*32+12-core.bigmap.offsetY,8,8,"#bfbfbf");clearTimeout(core.timeout.onDownTimeout);core.timeout.onDownTimeout=null;core.status.preview.prepareDragging=false;if(!core.hasFlag("__lockViewport__")&&(core.status.thisMap.width>core._WIDTH_||core.status.thisMap.height>core._HEIGHT_)){core.status.preview.prepareDragging=true;core.status.preview.px=b;core.status.preview.py=c;core.timeout.onDownTimeout=setTimeout(function(){core.clearMap("ui");core.status.preview.prepareDragging=false;core.status.preview.enabled=true;core.status.preview.dragging=true;core.drawTip("已进入预览模式，可直接拖动大地图");core.status.stepPostfix=[]},500)}};actions.prototype.onmove=function(a){var d=parseInt(a.x/a.size),e=parseInt(a.y/a.size);var b=parseInt(a.x/core.domStyle.scale),c=parseInt(a.y/core.domStyle.scale);this.doRegisteredAction("onmove",d,e,b,c)};actions.prototype._sys_onmove_choices=function(c,d,a,b){if(!core.status.lockControl){return false}switch(core.status.event.id){case"action":if(core.status.event.data.type=="choices"){this._onMoveChoices(c,d);return true}if(core.status.event.data.type=="confirm"){this._onMoveConfirmBox(c,d,a,b);return true}break;case"selectShop":case"switchs":case"switchs-sounds":case"switchs-display":case"switchs-action":case"notes":case"settings":case"syncSave":case"syncSelect":case"localSaveSelect":case"storageRemove":case"replay":case"gameInfo":this._onMoveChoices(c,d);return true;case"confirmBox":this._onMoveConfirmBox(c,d,a,b);return true;default:break}return false};actions.prototype._sys_onmove=function(i,j,g,h){if(core.status.lockControl){return false}if(core.status.preview.dragging){core.setViewport(core.bigmap.offsetX-g+core.status.preview.px,core.bigmap.offsetY-h+core.status.preview.py);core.status.preview.px=g;core.status.preview.py=h;return true}if(core.status.preview.prepareDragging){if(Math.abs(g-core.status.preview.px)<=20&&Math.abs(h-core.status.preview.py)<=20){return true}else{core.status.preview.prepareDragging=false}}clearTimeout(core.timeout.onDownTimeout);core.timeout.onDownTimeout=null;if((core.status.stepPostfix||[]).length>0){var e={x:parseInt((g+core.bigmap.offsetX)/32),y:parseInt((h+core.bigmap.offsetY)/32)};var f=core.status.stepPostfix[core.status.stepPostfix.length-1];var a=[e.y-f.y,f.x-e.x,f.y-e.y,e.x-f.x];var d=0,c=4;for(var b=0;b<4;b++){if(a[b]>d){c=b;d=a[b]}}e=[{x:0,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:0},false][c];if(e){e.x+=f.x;e.y+=f.y;core.status.stepPostfix.push(e);core.fillRect("ui",e.x*32+12-core.bigmap.offsetX,e.y*32+12-core.bigmap.offsetY,8,8,"#bfbfbf")}}return true};actions.prototype.onup=function(a){var d=parseInt(a.x/a.size),e=parseInt(a.y/a.size);var b=parseInt(a.x/core.domStyle.scale),c=parseInt(a.y/core.domStyle.scale);this.doRegisteredAction("onup",d,e,b,c)};actions.prototype._sys_onup=function(j,k,g,h){clearTimeout(core.timeout.onDownTimeout);core.timeout.onDownTimeout=null;clearInterval(core.interval.onDownInterval);core.interval.onDownInterval=null;if(core.isPlaying()){core.status.preview.prepareDragging=false;if(core.status.preview.dragging){core.status.preview.dragging=false;return true}}if((core.status.stepPostfix||[]).length==0){return false}var i=[];var a={"0":{"1":"down","-1":"up"},"-1":{"0":"left"},"1":{"0":"right"}};for(var b=1;b<core.status.stepPostfix.length;b++){var d=core.status.stepPostfix[b-1];var c=core.status.stepPostfix[b];i.push({direction:a[c.x-d.x][c.y-d.y],x:c.x,y:c.y})}var e=core.status.stepPostfix[0].x;var f=core.status.stepPostfix[0].y;core.status.stepPostfix=[];if(!core.status.lockControl){core.clearMap("ui")}if(!core.status.lockControl&&i.length==0&&core.status.downTime!=null&&new Date()-core.status.downTime>=1000){core.actions.longClick(j,k,g,h)}else{core.setAutomaticRoute(e,f,i)}core.status.downTime=null;return true};actions.prototype._getClickLoc=function(f,g){var d={x:0,y:0};var c=32;c=c*core.domStyle.scale;if(core.domStyle.isVertical){d.x=3;d.y=core.dom.statusBar.offsetHeight+3}else{d.x=core.dom.statusBar.offsetWidth+3;d.y=3}var a=core.dom.gameGroup.offsetLeft+d.x;var e=core.dom.gameGroup.offsetTop+d.y;var b={x:Math.max(f-a),y:Math.max(g-e,0),size:c};return b};actions.prototype.onmousewheel=function(a){this.doRegisteredAction("onmousewheel",a)};actions.prototype._sys_onmousewheel=function(a){if(this._checkReplaying()){if(a==1){core.speedUpReplay()}if(a==-1){core.speedDownReplay()}return}if(core.status.lockControl&&core.status.event.id=="fly"){if(a==1){core.ui.drawFly(this._getNextFlyFloor(1))}if(a==-1){core.ui.drawFly(this._getNextFlyFloor(-1))}return}if(core.status.lockControl&&core.status.event.id=="book"){var e=core.ui._drawBook_pageinfo();if(a==1){core.ui.drawBook(core.status.event.data-e.per_page)}if(a==-1){core.ui.drawBook(core.status.event.data+e.per_page)}return}if(core.status.lockControl&&(core.status.event.id=="save"||core.status.event.id=="load")){var c=core.status.event.data.page*10+core.status.event.data.offset;if(a==1){core.ui._drawSLPanel(c-10)}if(a==-1){core.ui._drawSLPanel(c+10)}return}if(core.status.lockControl&&core.status.event.id=="viewMaps"){if(a==1){this._clickViewMaps(this._HX_,this._HY_-3,core._PX_/2,core._PY_/5*1.5)}if(a==-1){this._clickViewMaps(this._HX_,this._HY_+3,core._PX_/2,core._PY_/5*3.5)}return}if(core.status.lockControl&&core.status.event.id=="action"&&core.status.event.data.type=="wait"){var f=Math.max(0,core.status.event.timeout-new Date().getTime())||0;core.setFlag("type",0);var d=a==1?33:34;core.setFlag("keycode",d);core.setFlag("timeout",f);var b=core.events.__action_wait_afterGet(core.status.event.data.current);if(b||!core.status.event.data.current.forceChild){core.status.route.push("input:"+(100000000*f+d));clearTimeout(core.status.event.interval);delete core.status.event.timeout;core.doAction()}return}};actions.prototype.keyDownCtrl=function(){this.doRegisteredAction("keyDownCtrl")};actions.prototype._sys_keyDownCtrl=function(){if(core.status.event.id=="text"){core.drawText();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="text"){core.doAction();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="sleep"&&!core.status.event.data.current.noSkip){if(core.timeout.sleepTimeout&&!core.hasAsync()){clearTimeout(core.timeout.sleepTimeout);core.timeout.sleepTimeout=null;core.doAction()}return true}};actions.prototype.longClick=function(c,d,a,b){if(!core.isPlaying()){return false}return this.doRegisteredAction("longClick",c,d,a,b)};actions.prototype._sys_longClick_lockControl=function(c,d,a,b){if(!core.status.lockControl){return false}if(core.status.event.id=="text"){core.drawText();return true}if(core.status.event.id=="action"&&core.status.event.data.type=="text"){core.doAction();return true}if(core.status.event.id=="fly"){if((c==core._WIDTH_-2||c==core._WIDTH_-3)&&(d==this._HY_-1||d==this._HY_+3)){this._clickFly(c,d);return true}}if(["save","load","replayLoad","replayRemain","replaySince"].indexOf(core.status.event.id)>=0){if([this._HX_-2,this._HX_-3,this._HX_+2,this._HX_+3].indexOf(c)>=0&&d===core._HEIGHT_-1){this._clickSL(c,d);return true}}if(core.status.event.id=="action"&&core.status.event.data.type=="sleep"&&!core.status.event.data.current.noSkip){if(core.timeout.sleepTimeout&&!core.hasAsync()){clearTimeout(core.timeout.sleepTimeout);core.timeout.sleepTimeout=null;core.doAction();return true}}return false};actions.prototype.onStatusBarClick=function(a){if(!core.isPlaying()){return false}var b=core.dom.gameGroup.offsetLeft+3;var f=core.dom.gameGroup.offsetTop+3;var c=parseInt((a.clientX-b)/core.domStyle.scale),d=parseInt((a.clientY-f)/core.domStyle.scale);return this.doRegisteredAction("onStatusBarClick",Math.max(c,0),Math.max(d,0))};actions.prototype._sys_onStatusBarClick=function(a,b,c){if(this.actionsdata.onStatusBarClick){return this.actionsdata.onStatusBarClick(a,b,c)}};actions.prototype._getChoicesTopIndex=function(a){return this._HY_-parseInt((a-1)/2)+(core.status.event.ui.offset||0)};actions.prototype._selectChoices=function(d,c,a){var e=this._getChoicesTopIndex(d);if(c==13||c==32||c==67){a.apply(this,[this._HX_,e+core.status.event.selection])}if(c>=49&&c<=57){var b=c-49;if(b<d){a.apply(this,[this._HX_,e+b])}}};actions.prototype._keyDownChoices=function(a){if(a==38){core.status.event.selection--;core.playSound("光标移动");core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices,core.status.event.ui.width)}if(a==40){core.status.event.selection++;core.playSound("光标移动");core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices,core.status.event.ui.width)}};actions.prototype._onMoveChoices=function(d,e){if(this._out(d)){return}var a=core.status.event.ui.choices;var c=this._getChoicesTopIndex(a.length);if(e>=c&&e<c+a.length){var b=e-c;if(b==core.status.event.selection){return}core.status.event.selection=b;core.playSound("光标移动");core.ui.drawChoices(core.status.event.ui.text,core.status.event.ui.choices,core.status.event.ui.width)}};actions.prototype._clickCenterFly=function(c,d){var a=core.status.event.data.posX,b=core.status.event.data.posY;core.ui.closePanel();if(c==a&&d==b){if(core.canUseItem("centerFly")){core.useItem("centerFly")}else{core.playSound("操作失败");core.drawTip("当前不能使用"+core.material.items.centerFly.name,"centerFly")}}};actions.prototype._keyUpCenterFly=function(a){core.ui.closePanel();if(a==51||a==13||a==32||a==67){if(core.canUseItem("centerFly")){core.useItem("centerFly")}else{core.playSound("操作失败");core.drawTip("当前不能使用"+core.material.items.centerFly.name,"centerFly")}}};actions.prototype._clickConfirmBox=function(c,d,a,b){if(a>=core._PX_/2-70&&a<=core._PX_/2-10&&b>=core._PY_/2&&b<=core._PY_/2+64&&core.status.event.data.yes){core.status.event.data.yes()}if(a>=core._PX_/2+10&&a<=core._PX_/2+70&&b>=core._PY_/2&&b<=core._PY_/2+64&&core.status.event.data.no){core.status.event.data.no()}};actions.prototype._keyUpConfirmBox=function(a){if(a==37||a==39){core.status.event.selection=1-core.status.event.selection;core.playSound("光标移动");core.ui.drawConfirmBox(core.status.event.ui,core.status.event.data.yes,core.status.event.data.no);return}if(a==13||a==32||a==67){if(core.status.event.selection==0&&core.status.event.data.yes){core.status.event.selection=null;core.status.event.data.yes();return}if(core.status.event.selection==1&&core.status.event.data.no){core.status.event.selection=null;core.status.event.data.no();return}}};actions.prototype._onMoveConfirmBox=function(c,d,a,b){if(b>=core._PY_/2&&b<=core._PY_/2+64){if(a>=core._PX_/2-70&&a<=core._PX_/2-10){if(core.status.event.selection!=0){core.status.event.selection=0;core.playSound("光标移动");if(core.status.event.id=="action"){core.ui.drawConfirmBox(core.status.event.ui.text)}else{core.ui.drawConfirmBox(core.status.event.ui,core.status.event.data.yes,core.status.event.data.no)}}return}if(a>=core._PX_/2+10&&a<=core._PX_/2+70){if(core.status.event.selection!=1){core.status.event.selection=1;core.playSound("光标移动");if(core.status.event.id=="action"){core.ui.drawConfirmBox(core.status.event.ui.text)}else{core.ui.drawConfirmBox(core.status.event.ui,core.status.event.data.yes,core.status.event.data.no)}}return}}};actions.prototype._clickAction_text=function(){if(core.status.event.animateUI){return}var a=core.clone(core.status.event.data.current);if(typeof a=="string"){a={type:"text",text:a}}if(core.status.event.interval!=null){a.showAll=true;core.insertAction(a);core.doAction();return}if(!a.code){core.ui._animateUI("hide",null,core.doAction)}else{core.doAction()}};actions.prototype._clickAction=function(j,k,f,g){if(core.status.event.data.type=="text"){return this._clickAction_text()}if(core.status.event.data.type=="wait"){var h=Math.max(0,core.status.event.timeout-new Date().getTime())||0;core.setFlag("type",1);core.setFlag("x",j);core.setFlag("y",k);core.setFlag("px",f);core.setFlag("py",g);core.setFlag("timeout",h);var d=core.events.__action_wait_afterGet(core.status.event.data.current);if(d||!core.status.event.data.current.forceChild){core.status.route.push("input:"+(100000000*h+1000000+1000*f+g));clearTimeout(core.status.event.interval);delete core.status.event.timeout;core.doAction()}return}if(core.status.event.data.type=="choices"){var c=core.status.event.data.current;var b=c.choices;if(b.length==0){return}if(this._out(j)){return}var i=this._getChoicesTopIndex(b.length);if(k>=i&&k<i+b.length){var a=b[k-i];if(a.need!=null&&a.need!=""&&!core.calValue(a.need)){core.playSound("操作失败");core.drawTip("无法选择此项");return}clearTimeout(core.status.event.interval);var h=Math.max(0,core.status.event.timeout-new Date().getTime())||0;delete core.status.event.timeout;core.setFlag("timeout",h);var e=k-i;if(e==b.length-1&&core.hasFlag("@temp@shop")){e=-1}core.status.route.push("choices:"+(100*h+e));core.insertAction(a.action);core.doAction()}return}if(core.status.event.data.type=="confirm"){if((j==this._HX_-2||j==this._HX_-1)&&k==this._HY_+1){clearTimeout(core.status.event.interval);var h=Math.max(0,core.status.event.timeout-new Date().getTime())||0;delete core.status.event.timeout;core.setFlag("timeout",h);core.status.route.push("choices:"+100*h);core.insertAction(core.status.event.ui.yes);core.doAction()}else{if((j==this._HX_+2||j==this._HX_+1)&&k==this._HY_+1){clearTimeout(core.status.event.interval);var h=Math.max(0,core.status.event.timeout-new Date().getTime())||0;delete core.status.event.timeout;core.setFlag("timeout",h);core.status.route.push("choices:"+(100*h+1));core.insertAction(core.status.event.ui.no);core.doAction()}}return}};actions.prototype._keyDownAction=function(a){if(core.status.event.data.type=="choices"){this._keyDownChoices(a);return}if(core.status.event.data.type=="confirm"&&(a==37||a==39)){core.status.event.selection=1-core.status.event.selection;core.playSound("光标移动");core.drawConfirmBox(core.status.event.ui.text);return}};actions.prototype._keyUpAction=function(d){if(core.status.event.data.type=="text"&&(d==13||d==32||d==67)){return this._clickAction_text()}if(core.status.event.data.type=="wait"){var e=Math.max(0,core.status.event.timeout-new Date().getTime())||0;core.setFlag("type",0);core.setFlag("keycode",d);core.setFlag("timeout",e);var c=core.events.__action_wait_afterGet(core.status.event.data.current);if(c||!core.status.event.data.current.forceChild){core.status.route.push("input:"+(100000000*e+d));clearTimeout(core.status.event.interval);delete core.status.event.timeout;core.doAction()}return}if(core.status.event.data.type=="choices"){var b=core.status.event.data.current;var a=b.choices;if(a.length>0){this._selectChoices(a.length,d,this._clickAction)}return}if(core.status.event.data.type=="confirm"&&(d==13||d==32||d==67)){var e=Math.max(0,core.status.event.timeout-new Date().getTime())||0;delete core.status.event.timeout;core.setFlag("timeout",e);core.status.route.push("choices:"+(100*e+core.status.event.selection));if(core.status.event.selection==0){core.insertAction(core.status.event.ui.yes)}else{core.insertAction(core.status.event.ui.no)}core.doAction();return}};actions.prototype._clickBook=function(h,j){var e=core.ui._drawBook_pageinfo();if((h==this._HX_-2||h==this._HX_-3)&&j===core._HEIGHT_-1){core.playSound("光标移动");core.ui.drawBook(core.status.event.data-e.per_page);return}if((h==this._HX_+2||h==this._HX_+3)&&j===core._HEIGHT_-1){core.playSound("光标移动");core.ui.drawBook(core.status.event.data+e.per_page);return}if(h>=this.LAST-2&&j===core._HEIGHT_-1){core.playSound("取消");if(core.events.recoverEvents(core.status.event.interval)){return}else{if(core.status.event.ui!=null){core.status.boxAnimateObjs=[];core.ui._drawViewMaps(core.status.event.ui)}else{core.ui.closePanel()}}return}var a=core.status.event.data;if(a!=null&&j<core._HEIGHT_-1){var f=e.per_page,d=parseInt(a/f);var g=this.LAST/f;for(var b=0;b<f;++b){if(j>=g*b&&j<g*(b+1)){var c=f*d+b;core.ui.drawBook(c);core.ui._drawBookDetail(c);break}}return}return};actions.prototype._keyDownBook=function(a){var b=core.ui._drawBook_pageinfo();if(a==37){core.playSound("光标移动");core.ui.drawBook(core.status.event.data-b.per_page)}if(a==38){core.playSound("光标移动");core.ui.drawBook(core.status.event.data-1)}if(a==39){core.playSound("光标移动");core.ui.drawBook(core.status.event.data+b.per_page)}if(a==40){core.playSound("光标移动");core.ui.drawBook(core.status.event.data+1)}if(a==33){core.playSound("光标移动");core.ui.drawBook(core.status.event.data-b.per_page)}if(a==34){core.playSound("光标移动");core.ui.drawBook(core.status.event.data+b.per_page)}return};actions.prototype._keyUpBook=function(b){if(b==27||b==88){core.playSound("取消");if(core.events.recoverEvents(core.status.event.interval)){return}else{if(core.status.event.ui!=null){core.status.boxAnimateObjs=[];core.ui._drawViewMaps(core.status.event.ui)}else{core.ui.closePanel()}}return}if(b==13||b==32||b==67){var a=core.status.event.data;if(a!=null){core.ui._drawBookDetail(a)}return}};actions.prototype._clickBookDetail=function(){core.clearMap("data");core.playSound("取消");core.status.event.id="book"};actions.prototype._clickFly=function(a,b){if((a==core._WIDTH_-2||a==core._WIDTH_-3)&&b==this._HY_+3){core.playSound("光标移动");core.ui.drawFly(this._getNextFlyFloor(-1))}if((a==core._WIDTH_-2||a==core._WIDTH_-3)&&b==this._HY_-1){core.playSound("光标移动");core.ui.drawFly(this._getNextFlyFloor(1))}if((a==core._WIDTH_-2||a==core._WIDTH_-3)&&b==this._HY_+4){core.playSound("光标移动");core.ui.drawFly(this._getNextFlyFloor(-10))}if((a==core._WIDTH_-2||a==core._WIDTH_-3)&&b==this._HY_-2){core.playSound("光标移动");core.ui.drawFly(this._getNextFlyFloor(10))}if(a>=this._HX_-1&&a<=this._HX_+1&&b===core._HEIGHT_-1){core.playSound("取消");core.ui.closePanel()}if(a>=0&&a<=this._HX_+3&&b>=3&&b<=core._HEIGHT_-1-1){core.flyTo(core.floorIds[core.status.event.data])}return};actions.prototype._keyDownFly=function(a){if(a==37){core.playSound("光标移动");core.ui.drawFly(this._getNextFlyFloor(-10))}else{if(a==38){core.playSound("光标移动");core.ui.drawFly(this._getNextFlyFloor(1))}else{if(a==39){core.playSound("光标移动");core.ui.drawFly(this._getNextFlyFloor(10))}else{if(a==40){core.playSound("光标移动");core.ui.drawFly(this._getNextFlyFloor(-1))}}}}return};actions.prototype._getNextFlyFloor=function(b,d){if(d==null){d=core.status.event.data}if(b==0){return d}var e=Math.sign(b);b=Math.abs(b);var a=d;while(true){d+=e;if(d<0||d>=core.floorIds.length){break}var c=core.floorIds[d];if(core.status.maps[c].canFlyTo&&core.hasVisitedFloor(c)){b--;a=d}if(b==0){break}}return a};actions.prototype._keyUpFly=function(a){if(a==71||a==27||a==88){core.playSound("取消");core.ui.closePanel()}if(a==13||a==32||a==67){this._clickFly(this._HX_-1,this._HY_-1)}return};actions.prototype._clickViewMaps=function(m,n,k,l){if(core.status.event.data==null){core.ui._drawViewMaps(core.floorIds.indexOf(core.status.floorId));return}var h=core.floorIds.indexOf(core.status.floorId);var f=core.status.event.data.index;var c=core.status.event.data.x,d=core.status.event.data.y;var e=core.floorIds[f],g=core.floors[e].height;var i=core._PX_/5,a=i*3/4,j=core._PY_/5,b=j*3/4;if(k<=a&&l<=b){core.status.event.data.damage=!core.status.event.data.damage;core.playSound("光标移动");core.ui._drawViewMaps(f,c,d);return}if(k<=a&&l>=core._PY_-b){if(core.markedFloorIds[e]){delete core.markedFloorIds[e]}else{core.markedFloorIds[e]=true}core.playSound("光标移动");core.ui._drawViewMaps(f,c,d);return}if(k>=core._PX_-a&&l<=b){core.status.event.data.all=!core.status.event.data.all;core.playSound("光标移动");core.ui._drawViewMaps(f,c,d);return}if(k>=i&&k<=core._PX_-i&&l<=j&&(!core.status.event.data.all&&g>core._HEIGHT_)){core.playSound("光标移动");core.ui._drawViewMaps(f,c,d-1);return}if(k>=i&&k<=core._PX_-i&&l>=core._PY_-j&&(!core.status.event.data.all&&g>core._HEIGHT_)){core.playSound("光标移动");core.ui._drawViewMaps(f,c,d+1);return}if(k<=i&&l>=j&&l<=core._PY_-j){core.playSound("光标移动");core.ui._drawViewMaps(f,c-1,d);return}if(k>=core._PX_-i&&l>=j&&l<=core._PY_-j){core.playSound("光标移动");core.ui._drawViewMaps(f,c+1,d);return}if(l<=2*j&&(g==core._HEIGHT_||(k>=i&&k<=core._PX_-i))){core.playSound("光标移动");f++;while(f<core.floorIds.length&&f!=h&&core.status.maps[core.floorIds[f]].cannotViewMap){f++}if(f<core.floorIds.length){core.ui._drawViewMaps(f)}return}if(l>=3*j&&(g==core._HEIGHT_||(k>=i&&k<=core._PX_-i))){core.playSound("光标移动");f--;while(f>=0&&f!=h&&core.status.maps[core.floorIds[f]].cannotViewMap){f--}if(f>=0){core.ui._drawViewMaps(f)}return}if(k>=i&&k<=core._PX_-i&&l>=j*2&&l<=j*3){core.clearMap("data");core.playSound("取消");core.ui.closePanel();return}};actions.prototype._keyDownViewMaps=function(b){if(core.status.event.data==null){return}var a=core.floorIds[core.status.event.data.index],c=core.floors[a].height;if(b==38||b==33){this._clickViewMaps(this._HX_,this._HY_-3,core._PX_/2,core._PY_/5*1.5)}if(b==40||b==34){this._clickViewMaps(this._HX_,this._HY_+3,core._PX_/2,core._PY_/5*3.5)}if(b==87&&c>core._HEIGHT_){this._clickViewMaps(this._HX_,0,core._PX_/2,1)}if(b==65){this._clickViewMaps(0,this._HY_,1,core._PY_/2)}if(b==83&&c>core._HEIGHT_){this._clickViewMaps(this._HX_,core._HEIGHT_-1,core._PX_/2,core._PY_-1)}if(b==68){this._clickViewMaps(core._WIDTH_-1,this._HY_,core._PX_,core._PY_/2-1)}return};actions.prototype._keyUpViewMaps=function(b){if(core.status.event.data==null){core.ui._drawViewMaps(core.floorIds.indexOf(core.status.floorId));return}var a=core.floorIds[core.status.event.data.index];if(b==27||b==13||b==32||(!core.isReplaying()&&b==67)){core.clearMap("data");core.playSound("取消");core.ui.closePanel();return}if(b==86){core.status.event.data.damage=!core.status.event.data.damage;core.playSound("光标移动");core.ui._drawViewMaps(core.status.event.data);return}if(b==90){core.status.event.data.all=!core.status.event.data.all;core.playSound("光标移动");core.ui._drawViewMaps(core.status.event.data);return}if(b==66){if(core.markedFloorIds[a]){delete core.markedFloorIds[a]}else{core.markedFloorIds[a]=true}core.playSound("光标移动");core.ui._drawViewMaps(core.status.event.data);return}if(b==88||(core.isReplaying()&&b==67)){if(core.isReplaying()){core.control._replay_book()}else{core.openBook(false)}return}if(b==71&&!core.isReplaying()){core.useFly(false);return}return};actions.prototype._clickQuickShop=function(e,f){var c=core.listShopIds();if(this._out(e)){return}var d=this._HY_-parseInt(c.length/2)+(core.status.event.ui.offset||0);if(f>=d&&f<d+c.length){var b=c[f-d];if(!core.canOpenShop(b)){core.playSound("操作失败");core.drawTip("当前项尚未开启");return}var a=core.canUseQuickShop(b);if(a==null){core.openShop(c[f-d],false)}else{core.playSound("操作失败");core.drawTip(a)}}else{if(f==d+c.length){core.playSound("取消");core.ui.closePanel()}}};actions.prototype._keyUpQuickShop=function(a){if(a==27||a==75||a==88||a==86){core.playSound("取消");core.ui.closePanel();return}this._selectChoices(core.listShopIds().length+1,a,this._clickQuickShop);return};actions.prototype._clickToolbox=function(g,h){var e=core.getToolboxItems("tools"),a=core.getToolboxItems("constants");if(g>=this.LAST-2&&h==0){core.ui.closePanel();if(core.isReplaying()){core.control._replay_equipbox()}else{core.openEquipbox()}return}if(g>=this.LAST-2&&h===core._HEIGHT_-1){core.playSound("取消");core.ui.closePanel();var d=core.status.route[core.status.route.length-1]||"";if(d.startsWith("equip:")||d.startsWith("unEquip:")){core.status.route.push("no")}core.checkAutoEvents();return}var f=core.status.event.data.toolsPage;var b=core.status.event.data.constantsPage;if(g==this._HX_-2||g==this._HX_-3){if(h===core._HEIGHT_-1-5&&f>1){core.status.event.data.toolsPage--;core.playSound("光标移动");core.ui._drawToolbox(core.status.event.selection)}if(h===core._HEIGHT_-1&&b>1){core.status.event.data.constantsPage--;core.playSound("光标移动");core.ui._drawToolbox(core.status.event.selection)}}if(g==this._HX_+2||g==this._HX_+3){if(h===core._HEIGHT_-1-5&&f<Math.ceil(e.length/this.LAST)){core.status.event.data.toolsPage++;core.playSound("光标移动");core.ui._drawToolbox(core.status.event.selection)}if(h===core._HEIGHT_-1&&b<Math.ceil(a.length/this.LAST)){core.status.event.data.constantsPage++;core.playSound("光标移动");core.ui._drawToolbox(core.status.event.selection)}}var c=parseInt(g/2);if(h===core._HEIGHT_-1-8){c+=0}else{if(h===core._HEIGHT_-1-6){c+=this._HX_}else{if(h===core._HEIGHT_-1-3){c+=this.LAST}else{if(h===core._HEIGHT_-1-1){c+=this.LAST+this._HX_}else{c=-1}}}}if(c>=0){this._clickToolboxIndex(c)}};actions.prototype._clickToolboxIndex=function(b){var f=core.getToolboxItems("tools"),a=core.getToolboxItems("constants");var d=null;var e;if(b<this.LAST){e=b+this.LAST*(core.status.event.data.toolsPage-1);d=f}else{e=b%this.LAST+this.LAST*(core.status.event.data.constantsPage-1);d=a}if(d==null){return}if(e>=d.length){return}var c=d[e];if(c==core.status.event.data.selectId){if(core.isReplaying()){return}core.events.tryUseItem(c)}else{core.playSound("光标移动");core.ui._drawToolbox(b)}};actions.prototype._keyDownToolbox=function(f){if(core.status.event.data==null){return}var g=this.LAST-1;var i=core.getToolboxItems("tools"),a=core.getToolboxItems("constants");var e=core.status.event.selection;var k=core.status.event.data.toolsPage;var c=core.status.event.data.constantsPage;var l=Math.ceil(i.length/this.LAST);var d=Math.ceil(a.length/this.LAST);var j=k<l?g:(i.length+g)%this.LAST;var b=this.LAST+(c<d?g:(a.length+g)%this.LAST);if(f==37){if(e==0){if(k>1){core.status.event.data.toolsPage--;e=g}else{return}}else{if(e==this.LAST){if(c==1){if(l==0){return}core.status.event.data.toolsPage=l;e=(i.length+g)%this.LAST}else{core.status.event.data.constantsPage--;e=2*this.LAST-1}}else{e-=1}}this._clickToolboxIndex(e);return}if(f==38){if(e>=this.LAST&&e<this.LAST+this._HX_){if(l==0){return}if(j>=this._HX_){e=Math.min(j,e-this._HX_)}else{e=Math.min(j,e-this.LAST)}}else{if(e<this._HX_){return}else{e-=this._HX_}}this._clickToolboxIndex(e);return}if(f==39){if(k<l&&e==g){core.status.event.data.toolsPage++;e=0}else{if(c<d&&e==2*this.LAST-1){core.status.event.data.constantsPage++;e=this.LAST}else{if(e==j){if(d==0){return}core.status.event.data.constantsPage=1;e=this.LAST}else{if(e==b){return}else{e++}}}}this._clickToolboxIndex(e);return}if(f==40){var h=null;if(e<this._HX_){if(j>=this._HX_){h=Math.min(j,e+this._HX_)}else{e+=this._HX_}}if(h==null&&e<this.LAST){if(d==0){return}h=Math.min(e+this._HX_,b)}if(h==null&&e<this.LAST+this._HX_){if(b>=this.LAST+this._HX_){h=Math.min(b,e+this._HX_)}}if(h!=null){this._clickToolboxIndex(h)}return}};actions.prototype._keyUpToolbox=function(a){if(a==81){core.playSound("确定");core.ui.closePanel();if(core.isReplaying()){core.control._replay_equipbox()}else{core.openEquipbox()}return}if(a==84||a==27||a==88){core.playSound("取消");core.ui.closePanel();var b=core.status.route[core.status.route.length-1]||"";if(b.startsWith("equip:")||b.startsWith("unEquip:")){core.status.route.push("no")}core.checkAutoEvents();return}if(core.status.event.data==null){return}if(a==13||a==32||a==67){this._clickToolboxIndex(core.status.event.selection);return}};actions.prototype._clickEquipbox=function(h,j,e,f){if(h>=this.LAST-2&&j==0){core.playSound("确定");core.ui.closePanel();if(core.isReplaying()){core.control._replay_toolbox()}else{core.openToolbox()}return}if(h>=this.LAST-2&&j===core._HEIGHT_-1){core.playSound("取消");core.ui.closePanel();var b=core.status.route[core.status.route.length-1]||"";if(b.startsWith("equip:")||b.startsWith("unEquip:")){core.status.route.push("no")}core.checkAutoEvents();return}if((h==this._HX_-2||h==this._HX_-3)&&j===core._HEIGHT_-1){if(core.status.event.data.page>1){core.status.event.data.page--;core.playSound("光标移动");core.ui._drawEquipbox(core.status.event.selection)}return}if((h==this._HX_+2||h==this._HX_+3)&&j===core._HEIGHT_-1){var c=Math.ceil(core.getToolboxItems("equips").length/this.LAST);if(core.status.event.data.page<c){core.status.event.data.page++;core.playSound("光标移动");core.ui._drawEquipbox(core.status.event.selection)}return}var d=this._HX_-3,g=core._WIDTH_/d;if(j===core._HEIGHT_-9){for(var a=0;a<d;++a){if(h>=a*g&&h<=(a+1)*g){return this._clickEquipboxIndex(a)}}}else{if(j===core._HEIGHT_-7){for(var a=0;a<d;++a){if(h>=a*g&&h<=(a+1)*g){return this._clickEquipboxIndex(d+a)}}}else{if(Math.abs(core._HEIGHT_-5-f/32)<0.5){for(var a=0;a<d;++a){if(h>=a*g&&h<=(a+1)*g){return this._clickEquipboxIndex(2*d+a)}}}else{if(j===core._HEIGHT_-4){this._clickEquipboxIndex(this.LAST+parseInt(h/2))}else{if(j===core._HEIGHT_-2){this._clickEquipboxIndex(this.LAST+this._HX_+parseInt(h/2))}}}}}};actions.prototype._clickEquipboxIndex=function(c){if(c<this.LAST){if(c>=core.status.globalAttribute.equipName.length){return}if(c==core.status.event.selection&&core.status.hero.equipment[c]){if(core.isReplaying()){return}core.unloadEquip(c);core.status.route.push("unEquip:"+c)}else{core.playSound("光标移动")}}else{var b=core.getToolboxItems("equips");if(c==core.status.event.selection){if(core.isReplaying()){return}var a=b[c-this.LAST+(core.status.event.data.page-1)*this.LAST];core.loadEquip(a);core.status.route.push("equip:"+a)}else{core.playSound("光标移动")}}core.ui._drawEquipbox(c)};actions.prototype._keyDownEquipbox=function(c){if(core.status.event.data==null){return}var d=this.LAST-1;var g=this._HX_-3;var a=core.status.globalAttribute.equipName.length;var e=core.getToolboxItems("equips");var b=core.status.event.selection;var f=core.status.event.data.page;var i=Math.ceil(e.length/this.LAST);var h=this.LAST+(f<i?d:(e.length+d)%this.LAST);if(c==37){if(b==0){return}if(b==this.LAST){if(f>1){core.status.event.data.page--;core.playSound("光标移动");b=this.LAST+d}else{if(f==1){b=a-1}else{return}}}else{b-=1}this._clickEquipboxIndex(b);return}if(c==38){if(b<g){return}else{if(b<2*g){b-=g}else{if(b<this.LAST+this._HX_){b=parseInt((b-this.LAST)/2);if(a>g){b=Math.min(a-1,b+g)}else{b=Math.min(a-1,b)}}else{b-=this._HX_}}}this._clickEquipboxIndex(b);return}if(c==39){if(f<i&&b==this.LAST+d){core.status.event.data.page++;core.playSound("光标移动");b=this.LAST}else{if(b==a-1){if(i==0){return}b=this.LAST}else{if(b==h){return}else{b++}}}this._clickEquipboxIndex(b);return}if(c==40){if(b<g){if(a>g){b=Math.min(b+g,a-1)}else{if(i==0){return}b=Math.min(2*b+1+this.LAST,h)}}else{if(b<2*g){if(i==0){return}b=Math.min(2*(b-g)+1+this.LAST,h)}else{if(b<this.LAST+this._HX_){b=Math.min(b+this._HX_,h)}else{return}}}this._clickEquipboxIndex(b);return}};actions.prototype._keyUpEquipbox=function(b,a){if(a&&b>=48&&b<=57){core.items.quickSaveEquip(b-48);return}if(b==84){core.playSound("确定");core.ui.closePanel();if(core.isReplaying()){core.control._replay_toolbox()}else{core.openToolbox()}return}if(b==81||b==27||b==88){core.playSound("取消");core.ui.closePanel();var c=core.status.route[core.status.route.length-1]||"";if(c.startsWith("equip:")||c.startsWith("unEquip:")){core.status.route.push("no")}core.checkAutoEvents();return}if(!core.status.event.data.selectId){return}if(b==13||b==32||b==67){this._clickEquipboxIndex(core.status.event.selection);return}};actions.prototype._clickSL=function(g,j){var d=core.status.event.data.page,c=core.status.event.data.offset;var b=d*10+c;if((g==this._HX_-2||g==this._HX_-3)&&j===core._HEIGHT_-1){core.playSound("光标移动");core.ui._drawSLPanel(10*(d-1)+c);return}if((g==this._HX_+2||g==this._HX_+3)&&j===core._HEIGHT_-1){core.playSound("光标移动");core.ui._drawSLPanel(10*(d+1)+c);return}if(g>=this.LAST-2&&j===core._HEIGHT_-1){core.playSound("取消");if(core.events.recoverEvents(core.status.event.interval)){return}core.ui.closePanel();delete core.status.tempRoute;if(!core.isPlaying()){core.showStartAnimate(true)}return}if(g>=0&&g<=2&&j===core._HEIGHT_-1){if(core.status.event.id=="save"){core.status.event.selection=!core.status.event.selection;core.ui._drawSLPanel(b)}else{core.status.event.data.mode=core.status.event.data.mode=="all"?"fav":"all";if(core.status.event.data.mode=="fav"){core.ui._drawSLPanel(1,true)}else{d=parseInt((core.saves.saveIndex-1)/5);c=core.saves.saveIndex-5*d;core.ui._drawSLPanel(10*d+c,true)}}return}var h=parseInt(core._WIDTH_/3),i=parseInt(core._WIDTH_*2/3);var e=0,f=this._HY_;if(j>=e&&j<=e+1){if(g>=h&&g<i){return this._clickSL_favorite(d,1)}if(g>=i){return this._clickSL_favorite(d,2)}}if(j>=f&&j<=f+1){if(g<h){return this._clickSL_favorite(d,3)}if(g>=h&&g<i){return this._clickSL_favorite(d,4)}if(g>=i){return this._clickSL_favorite(d,5)}}var a=null;if(j>=e+2&&j<this._HY_-1){if(g<h){a="autoSave"}if(g>=h&&g<i){a=5*d+1}if(g>=i){a=5*d+2}}if(j>=f+2&&j<core._HEIGHT_-1){if(g<h){a=5*d+3}if(g>=h&&g<i){a=5*d+4}if(g>=i){a=5*d+5}}if(a!=null){if(core.status.event.selection){if(a=="autoSave"){core.playSound("操作失败");core.drawTip("无法删除自动存档！")}else{core.removeSave(a,function(){core.ui._drawSLPanel(b,true)})}}else{if(core.status.event.data.mode=="fav"&&a!="autoSave"){a=core.saves.favorite[a-1]}core.doSL(a,core.status.event.id)}}};actions.prototype._clickSL_favorite=function(c,b){if(b==0){return}var a=5*c+b;if(core.status.event.data.mode=="fav"){a=core.saves.favorite[a-1];core.myprompt("请输入想要显示的存档名(长度不超过5字符)",null,function(e){if(e&&e.length<=5){core.saves.favoriteName[a]=e;core.control._updateFavoriteSaves();core.ui._drawSLPanel(10*c+b)}else{if(e){alert("无效的输入！")}}})}else{var d=core.saves.favorite.indexOf(a);core.playSound("确定");if(d>=0){core.saves.favorite.splice(d,1);delete core.saves.favoriteName[a]}else{if(core.hasSave(a)){core.saves.favorite.push(a);core.saves.favorite=core.saves.favorite.sort(function(e,f){return e-f});core.drawTip("收藏成功！")}}core.control._updateFavoriteSaves();core.ui._drawSLPanel(10*c+b)}};actions.prototype._keyDownSL=function(b){var d=core.status.event.data.page,c=core.status.event.data.offset;var a=d*10+c;if(b==37){core.playSound("光标移动");if(c==0){core.ui._drawSLPanel(10*(d-1)+5)}else{core.ui._drawSLPanel(a-1)}return}if(b==38){core.playSound("光标移动");if(c<3){core.ui._drawSLPanel(10*(d-1)+c+3)}else{core.ui._drawSLPanel(a-3)}return}if(b==39){core.playSound("光标移动");if(c==5){core.ui._drawSLPanel(10*(d+1)+1)}else{core.ui._drawSLPanel(a+1)}return}if(b==40){core.playSound("光标移动");if(c>=3){core.ui._drawSLPanel(10*(d+1)+c-3)}else{core.ui._drawSLPanel(a+3)}return}if(b==33){core.playSound("光标移动");core.ui._drawSLPanel(10*(d-1)+c);return}if(b==34){core.playSound("光标移动");core.ui._drawSLPanel(10*(d+1)+c);return}};actions.prototype._keyUpSL=function(c){var e=core.status.event.data.page,d=core.status.event.data.offset;var b=e*10+d;if(c==27||c==88||(core.status.event.id=="save"&&c==83)||(core.status.event.id=="load"&&c==68)){this._clickSL(core._WIDTH_-1,core._HEIGHT_-1);return}if(c>=48&&c<=57){if(c==48){c=58}core.ui._drawSLPanel((c-49)*1000+1);return}if(c==13||c==32||c==67){if(d==0){core.doSL("autoSave",core.status.event.id)}else{var a=5*e+d;if(core.status.event.data.mode=="fav"){a=core.saves.favorite[a-1]}core.doSL(a,core.status.event.id)}return}if(c==69&&core.status.event.id!="save"){this._clickSL(0,core._HEIGHT_-1);return}if(c==46){if(d==0){core.playSound("操作失败");core.drawTip("无法删除自动存档！")}else{var a=5*e+d;if(core.status.event.data.mode=="fav"){a=core.saves.favorite[a-1]}core.removeSave(a,function(){core.ui._drawSLPanel(b,true)})}}if(c==70&&core.status.event.data.mode=="all"){this._clickSL_favorite(e,d)}};actions.prototype._clickSwitchs=function(d,e){var a=core.status.event.ui.choices;var c=this._getChoicesTopIndex(a.length);var b=e-c;if(this._out(d)){return}if(b>=0&&b<a.length){core.status.event.selection=b;switch(b){case 0:core.status.event.selection=0;core.playSound("确定");return core.ui._drawSwitchs_sounds();case 1:core.status.event.selection=0;core.playSound("确定");return core.ui._drawSwitchs_display();case 2:core.status.event.selection=0;core.playSound("确定");return core.ui._drawSwitchs_action();case 3:core.status.event.selection=0;core.playSound("取消");return core.ui._drawSettings()}}};actions.prototype._keyUpSwitchs=function(a){if(a==27||a==88){core.status.event.selection=0;core.playSound("取消");core.ui._drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSwitchs)};actions.prototype._clickSwitchs_sounds=function(i,j){var a=core.status.event.ui.choices;var g=this._getChoicesTopIndex(a.length);var f=j-g;if(this._out(i)){if(f!=2){return}}if(f>=0&&f<a.length){var h=a[f].width;var c=(core._PX_-h)/2,e=(core._PX_+h)/2;var b=parseInt(c/32),d=parseInt(e/32)-1;core.status.event.selection=f;switch(f){case 0:return this._clickSwitchs_sounds_bgm();case 1:return this._clickSwitchs_sounds_se();case 2:if(i==b||i==b+1){return this._clickSwitchs_sounds_userVolume(-1)}if(i==d||i==d+1){return this._clickSwitchs_sounds_userVolume(1)}return;case 3:core.status.event.selection=0;core.playSound("取消");core.ui._drawSwitchs();return}}};actions.prototype._clickSwitchs_sounds_bgm=function(){core.triggerBgm();core.playSound("确定");core.ui._drawSwitchs_sounds()};actions.prototype._clickSwitchs_sounds_se=function(){core.musicStatus.soundStatus=!core.musicStatus.soundStatus;core.setLocalStorage("soundStatus",core.musicStatus.soundStatus);core.playSound("确定");core.ui._drawSwitchs_sounds()};actions.prototype._clickSwitchs_sounds_userVolume=function(a){var b=Math.round(Math.sqrt(100*core.musicStatus.userVolume));if(b==0&&a<0){return}core.musicStatus.userVolume=core.clamp(Math.pow(b+a,2)/100,0,1);if(core.musicStatus.gainNode!=null){core.musicStatus.gainNode.gain.value=core.musicStatus.userVolume}if(core.musicStatus.playingBgm){core.material.bgms[core.musicStatus.playingBgm].volume=core.musicStatus.userVolume*core.musicStatus.designVolume}core.setLocalStorage("userVolume",core.musicStatus.userVolume);core.playSound("确定");core.ui._drawSwitchs_sounds()};actions.prototype._keyUpSwitchs_sounds=function(a){if(a==27||a==88){core.status.event.selection=0;core.playSound("取消");core.ui._drawSwitchs();return}if(a==37){switch(core.status.event.selection){case 2:core.playSound("确定");return this._clickSwitchs_sounds_userVolume(-1)}}else{if(a==39){switch(core.status.event.selection){case 2:core.playSound("确定");return this._clickSwitchs_sounds_userVolume(1)}}}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSwitchs_sounds)};actions.prototype._clickSwitchs_display=function(i,j){var a=core.status.event.ui.choices;var g=this._getChoicesTopIndex(a.length);var f=j-g;if(this._out(i)){if(f!=0){return}}if(f>=0&&f<a.length){var h=a[f].width;var c=(core._PX_-h)/2,e=(core._PX_+h)/2;var b=parseInt(c/32),d=parseInt(e/32)-1;core.status.event.selection=f;switch(f){case 0:if(i==b||i==b+1){return this._clickSwitchs_display_setSize(-1)}if(i==d||i==d+1){return this._clickSwitchs_display_setSize(1)}return;case 1:core.playSound("确定");return this._clickSwitchs_display_enableHDCanvas();case 2:core.playSound("确定");return this._clickSwitchs_display_enableEnemyPoint();case 3:core.playSound("确定");return this._clickSwitchs_display_enemyDamage();case 4:core.playSound("确定");return this._clickSwitchs_display_critical();case 5:core.playSound("确定");return this._clickSwitchs_display_extraDamage();case 6:core.playSound("确定");return this._clickSwitchs_display_extraDamageType();case 7:core.playSound("确定");core.setLocalStorage("autoScale",core.getLocalStorage("autoScale")?false:true);core.ui._drawSwitchs_display();break;case 8:core.status.event.selection=1;core.playSound("取消");core.ui._drawSwitchs();return}}};actions.prototype._clickSwitchs_display_setSize=function(b){core.setDisplayScale(b);var a=Math.max(window.devicePixelRatio||1,core.domStyle.scale);if(a>core.domStyle.ratio){core.drawTip("需刷新页面以调整UI清晰度")}core.ui._drawSwitchs_display()};actions.prototype._clickSwitchs_display_enableHDCanvas=function(){core.flags.enableHDCanvas=!core.flags.enableHDCanvas;core.setLocalStorage("enableHDCanvas",core.flags.enableHDCanvas);core.drawTip("开关高清UI，需刷新页面方可生效");core.ui._drawSwitchs_display()};actions.prototype._clickSwitchs_display_enableEnemyPoint=function(){core.flags.enableEnemyPoint=!core.flags.enableEnemyPoint;core.setLocalStorage("enableEnemyPoint",core.flags.enableEnemyPoint);core.ui._drawSwitchs_display()};actions.prototype._clickSwitchs_display_enemyDamage=function(){core.flags.displayEnemyDamage=!core.flags.displayEnemyDamage;core.updateDamage();core.setLocalStorage("enemyDamage",core.flags.displayEnemyDamage);core.ui._drawSwitchs_display()};actions.prototype._clickSwitchs_display_critical=function(){core.flags.displayCritical=!core.flags.displayCritical;core.updateDamage();core.setLocalStorage("critical",core.flags.displayCritical);core.ui._drawSwitchs_display()};actions.prototype._clickSwitchs_display_extraDamage=function(){core.flags.displayExtraDamage=!core.flags.displayExtraDamage;core.updateDamage();core.setLocalStorage("extraDamage",core.flags.displayExtraDamage);core.ui._drawSwitchs_display()};actions.prototype._clickSwitchs_display_extraDamageType=function(){core.flags.extraDamageType=(core.flags.extraDamageType+1)%3;core.updateDamage();core.setLocalStorage("extraDamageType",core.flags.extraDamageType);core.ui._drawSwitchs_display()};actions.prototype._keyUpSwitchs_display=function(a){if(a==27||a==88){core.status.event.selection=1;core.playSound("取消");core.ui._drawSwitchs();return}if(a==37){switch(core.status.event.selection){case 0:core.playSound("确定");return this._clickSwitchs_display_setSize(-1)}}else{if(a==39){switch(core.status.event.selection){case 0:core.playSound("确定");return this._clickSwitchs_display_setSize(1)}}}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSwitchs_display)};actions.prototype._clickSwitchs_action=function(i,j){var a=core.status.event.ui.choices;var g=this._getChoicesTopIndex(a.length);var f=j-g;if(this._out(i)){if(f!=0&&f!=1){return}}if(f>=0&&f<a.length){var h=a[f].width;var c=(core._PX_-h)/2,e=(core._PX_+h)/2;var b=parseInt(c/32),d=parseInt(e/32)-1;core.status.event.selection=f;switch(f){case 0:if(i==b||i==b+1){core.playSound("确定");return this._clickSwitchs_action_moveSpeed(-10)}if(i==d||i==d+1){core.playSound("确定");return this._clickSwitchs_action_moveSpeed(10)}return;case 1:if(i==b||i==b+1){core.playSound("确定");return this._clickSwitchs_action_floorChangeTime(-100)}if(i==d||i==d+1){core.playSound("确定");return this._clickSwitchs_action_floorChangeTime(100)}case 2:core.playSound("确定");return this._clickSwitchs_action_potionNoRouting();case 3:core.playSound("确定");return this._clickSwitchs_action_clickMove();case 4:core.playSound("确定");return this._clickSwitchs_action_leftHandPrefer();case 5:core.status.event.selection=2;core.playSound("取消");core.ui._drawSwitchs();return}}};actions.prototype._clickSwitchs_action_moveSpeed=function(a){core.values.moveSpeed=core.clamp(core.values.moveSpeed+a,50,200);core.setLocalStorage("moveSpeed",core.values.moveSpeed);core.ui._drawSwitchs_action()};actions.prototype._clickSwitchs_action_floorChangeTime=function(a){core.values.floorChangeTime=core.clamp(core.values.floorChangeTime+a,0,2000);core.setLocalStorage("floorChangeTime",core.values.floorChangeTime);core.ui._drawSwitchs_action()};actions.prototype._clickSwitchs_action_potionNoRouting=function(){if(core.hasFlag("__potionNoRouting__")){core.removeFlag("__potionNoRouting__")}else{core.setFlag("__potionNoRouting__",true)}core.ui._drawSwitchs_action()};actions.prototype._clickSwitchs_action_clickMove=function(){if(core.hasFlag("__noClickMove__")){core.removeFlag("__noClickMove__")}else{core.setFlag("__noClickMove__",true)}core.ui._drawSwitchs_action()};actions.prototype._clickSwitchs_action_leftHandPrefer=function(){core.flags.leftHandPrefer=!core.flags.leftHandPrefer;core.setLocalStorage("leftHandPrefer",core.flags.leftHandPrefer);if(core.flags.leftHandPrefer){core.myconfirm("左手模式已开启！\n此模式下WASD将用于移动勇士，IJKL对应于原始的WASD进行存读档等操作。")}core.ui._drawSwitchs_action()};actions.prototype._keyUpSwitchs_action=function(a){if(a==27||a==88){core.status.event.selection=2;core.playSound("取消");core.ui._drawSwitchs();return}if(a==37){switch(core.status.event.selection){case 0:core.playSound("确定");return this._clickSwitchs_action_moveSpeed(-10);case 1:core.playSound("确定");return this._clickSwitchs_action_floorChangeTime(-100)}}else{if(a==39){switch(core.status.event.selection){case 0:core.playSound("确定");return this._clickSwitchs_action_moveSpeed(10);case 1:core.playSound("确定");return this._clickSwitchs_action_floorChangeTime(100)}}}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSwitchs_action)};actions.prototype._clickSettings=function(d,e){if(this._out(d)){return}var a=core.status.event.ui.choices;var c=this._getChoicesTopIndex(a.length);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.status.event.selection=0;core.playSound("确定");core.ui._drawSwitchs();break;case 1:core.ui._drawKeyBoard();break;case 2:core.clearUI();core.ui._drawViewMaps();break;case 3:core.status.event.selection=0;core.playSound("确定");core.ui._drawNotes();break;case 4:core.status.event.selection=0;core.playSound("确定");core.ui._drawSyncSave();break;case 5:core.status.event.selection=0;core.playSound("确定");core.ui._drawGameInfo();break;case 6:return core.confirmRestart();case 7:core.playSound("取消");core.ui.closePanel();break}}return};actions.prototype._keyUpSettings=function(a){if(a==27||a==88){core.playSound("取消");core.ui.closePanel();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSettings)};actions.prototype._clickNotes=function(d,e){if(this._out(d)){return}var a=core.status.event.ui.choices;var c=this._getChoicesTopIndex(a.length);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.playSound("确定");this._clickNotes_new();break;case 1:this._clickNotes_show();break;case 2:core.playSound("确定");this._clickNotes_edit();break;case 3:core.playSound("确定");this._clickNotes_delete();break;case 4:core.status.event.selection=3;core.playSound("取消");core.ui._drawSettings();break}}};actions.prototype.__clickNotes_replaceText=function(a){a=(a||"").replace(/[\${}]/g,"_").replace(/(\t|\\t)\[.*?\]/g,"").replace("\b","\\b").replace(/\\b\[.*?\]/g,"").replace(/\n|\\n/g," ");if(a.length>45){a=a.substring(0,43)+"..."}return a};actions.prototype._clickNotes_new=function(){core.status.hero.notes=core.status.hero.notes||[];core.myprompt("请输入一段笔记，不超过45字",null,function(a){a=core.actions.__clickNotes_replaceText(a);if(a){core.status.hero.notes.push(a);core.drawText("存档笔记新增成功！")}else{core.ui.closePanel()}})};actions.prototype._clickNotes_show=function(){core.playSound("确定");core.status.hero.notes=core.status.hero.notes||[];var c=[];for(var a=0;a<core.status.hero.notes.length;a+=5){var d=[];for(var b=a;b<a+5&&b<core.status.hero.notes.length;++b){d.push(b+1+". "+this.__clickNotes_replaceText(core.status.hero.notes[b]))}c.push("\t[存档笔记]"+d.join("\n"))}if(c.length==0){c.push("当前没有存档笔记，试着新增一个吧！\n（菜单栏 -> 存档笔记 -> 新增存档笔记）")}core.drawText(c)};actions.prototype._clickNotes_edit=function(){core.status.hero.notes=core.status.hero.notes||[];if(core.status.hero.notes.length==0){core.drawText("当前没有存档笔记，试着新增一个吧！")}else{core.myprompt("请输入要编辑的存档笔记编号（1 - "+core.status.hero.notes.length+"）","1",function(a){if(!a){core.ui.closePanel()}var b=parseInt(a)||0;if(!b||b<=0||b>core.status.hero.notes.length){core.drawText("不合法的输入！")}else{core.myprompt("请输入新内容，不超过45字",core.status.hero.notes[b-1],function(c){c=core.actions.__clickNotes_replaceText(c);if(c){core.status.hero.notes[b-1]=c;core.drawText("存档笔记编辑成功！")}else{core.ui.closePanel()}})}})}};actions.prototype._clickNotes_delete=function(){core.status.hero.notes=core.status.hero.notes||[];if(core.status.hero.notes.length==0){core.stopSound();core.playSound("操作失败");core.drawText("当前没有存档笔记，无法删除！")}else{core.myprompt("请输入要删除的所有存档笔记编号，以逗号分隔。不填则代表删除全部笔记。",null,function(a){if(a==null){core.ui.closePanel();return}else{if(!a){core.status.hero.notes=[];core.drawText("所有存档笔记删除成功！")}else{a=a.split(",").map(function(b){return parseInt(b)}).filter(function(b){return b&&b>0&&b<=core.status.hero.notes.length});if(a.length==0){core.drawText("没有要删除的笔记！")}else{a.sort(function(c,d){return d-c}).forEach(function(b){core.status.hero.notes.splice(b-1,1)});core.drawText("已删除 "+a.sort().join(",")+" 号笔记")}}}})}};actions.prototype._keyUpNotes=function(a){if(a==27||a==88){core.status.event.selection=3;core.playSound("取消");core.ui._drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickNotes)};actions.prototype._clickSyncSave=function(d,e){if(this._out(d)){return}var a=core.status.event.ui.choices;var c=this._getChoicesTopIndex(a.length);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.status.event.selection=0;core.playSound("确定");core.ui._drawSyncSelect();break;case 1:core.playSound("确定");core.syncLoad();break;case 2:core.playSound("确定");core.status.event.selection=0;core.ui._drawLocalSaveSelect();break;case 3:core.playSound("确定");return this._clickSyncSave_readFile();case 4:return this._clickSyncSave_replay();case 5:core.status.event.selection=0;core.playSound("确定");core.ui._drawStorageRemove();break;case 6:core.status.event.selection=4;core.playSound("取消");core.ui._drawSettings();break}}return};actions.prototype._clickSyncSave_readFile=function(){core.readFile(function(a){if(a.name!=core.firstData.name){return alert("存档和游戏不一致！")}if(a.version!=core.firstData.version){return alert("游戏版本不一致！")}if(!a.data){return alert("无效的存档！")}core.control._syncLoad_write(a.data)},null,".h5save")};actions.prototype._clickSyncSave_replay=function(){core.ui._drawReplay()};actions.prototype._keyUpSyncSave=function(a){if(a==27||a==88){core.status.event.selection=4;core.playSound("取消");core.ui._drawSettings();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSyncSave)};actions.prototype._clickSyncSelect=function(d,e){if(this._out(d)){return}var a=core.status.event.ui.choices;var c=this._getChoicesTopIndex(a.length);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.playSound("确定");core.myconfirm("你确定要同步全部存档么？\n这可能在存档较多的时候比较慢。",function(){core.syncSave("all")});break;case 1:core.playSound("确定");core.syncSave();break;case 2:core.status.event.selection=0;core.playSound("取消");core.ui._drawSyncSave();break}}};actions.prototype._keyUpSyncSelect=function(a){if(a==27||a==88){core.status.event.selection=0;core.playSound("取消");core.ui._drawSyncSave();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickSyncSelect)};actions.prototype._clickLocalSaveSelect=function(e,f){if(this._out(e)){return}var b=core.status.event.ui.choices;var d=this._getChoicesTopIndex(b.length);if(f>=d&&f<d+b.length){var c=f-d;core.status.event.selection=c;if(c<2){var a=function(h){if(h){var g={name:core.firstData.name,version:core.firstData.version,data:h};core.download(core.firstData.name+"_"+core.formatDate2(new Date())+".h5save",LZString.compressToBase64(JSON.stringify(g)))}};if(c==0){core.getAllSaves(a)}else{core.getSave(core.saves.saveIndex,a)}}core.status.event.selection=2;core.playSound("取消");core.ui._drawSyncSave()}};actions.prototype._keyUpLocalSaveSelect=function(a){if(a==27||a==88){core.status.event.selection=2;core.playSound("取消");core.ui._drawSyncSave();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickLocalSaveSelect)};actions.prototype._clickStorageRemove=function(d,e){if(this._out(d)){return}var a=core.status.event.ui.choices;var c=this._getChoicesTopIndex(a.length);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:return this._clickStorageRemove_all();case 1:return this._clickStorageRemove_current();case 2:core.status.event.selection=5;core.playSound("取消");core.ui._drawSyncSave();break}}};actions.prototype._clickStorageRemove_all=function(){core.myconfirm("你确定要清除【全部游戏】的所有本地存档？\n此行为不可逆！！！",function(){core.ui.drawWaiting("正在清空，请稍候...");core.clearLocalForage(function(){core.saves.ids={};core.saves.autosave.data=null;core.saves.autosave.updated=false;core.saves.autosave.now=0;core.saves.cache={};core.ui.closePanel();core.saves.saveIndex=1;core.saves.favorite=[];core.saves.favoriteName={};core.control._updateFavoriteSaves();core.removeLocalStorage("saveIndex");core.drawText("\t[操作成功]你的所有存档已被清空。")})})};actions.prototype._clickStorageRemove_current=function(){core.myconfirm("你确定要清除本游戏的所有本地存档？\n此行为不可逆！！！",function(){var a=function(){core.saves.ids={};core.saves.autosave.data=null;core.saves.autosave.updated=false;core.saves.autosave.now=0;core.ui.closePanel();core.saves.saveIndex=1;core.saves.favorite=[];core.saves.favoriteName={};core.control._updateFavoriteSaves();core.removeLocalStorage("saveIndex");core.drawText("\t[操作成功]当前塔的存档已被清空。")};core.ui.drawWaiting("正在清空，请稍候...");Object.keys(core.saves.ids).forEach(function(b){core.removeLocalForage("save"+b)});core.removeLocalForage("autoSave",a)})};actions.prototype._keyUpStorageRemove=function(a){if(a==27||a==88){core.status.event.selection=5;core.playSound("取消");core.ui._drawSyncSave();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickStorageRemove)};actions.prototype._clickReplay=function(d,e){if(this._out(d)){return}var a=core.status.event.ui.choices;var c=this._getChoicesTopIndex(a.length);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:core.playSound("确定");return this._clickReplay_fromBeginning();case 1:core.playSound("确定");return this._clickReplay_fromLoad();case 2:core.playSound("确定");return this._clickReplay_replayRemain();case 3:core.playSound("确定");return this._clickReplay_replaySince();case 4:core.playSound("确定");return core.chooseReplayFile();case 5:core.playSound("确定");return this._clickReplay_download();case 6:core.playSound("取消");return core.ui.closePanel()}}};actions.prototype._clickReplay_fromBeginning=function(){core.ui.closePanel();core.startGame(core.status.hard,core.getFlag("__seed__"),core.cloneArray(core.status.route))};actions.prototype._clickReplay_fromLoad=function(){core.status.event.id="replayLoad";core.status.event.selection=null;core.clearUI();var c=core.saves.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui._drawSLPanel(10*b+a)};actions.prototype._clickReplay_replayRemain=function(){core.closePanel();core.drawText(["\t[接续播放录像]该功能允许你播放\r[yellow]两个存档之间的录像\r，常常用于\r[yellow]区域优化\r。\n例如，有若干个区，已经全部通关；之后重打一区并进行了优化，则可以对剩余区域直接播放录像而无需全部重打。\n\n详细使用方法参见露珠录制的视频教程：\n\r[yellow]https://bilibili.com/video/BV1az4y1C78x","\t[步骤1]请选择一个存档。\n\r[yellow]该存档的坐标必须和当前勇士坐标完全相同。\r\n将尝试从此处开始回放。",],function(){core.status.event.id="replayRemain";core.lockControl();var c=core.saves.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui._drawSLPanel(10*b+a)})};actions.prototype._clickReplay_replaySince=function(){core.closePanel();core.drawText(["\t[播放存档剩余录像]该功能为【接续播放录像】的简化版本，允许你播放\r[yellow]一个存档中剩余的录像\r，常常用于\r[yellow]录像局部优化\r。\n在录像正常播放中，你随时可以暂停并按S键进行存档；此时\r[yellow]剩余录像\r也会被记在存档中（在读档界面用\r[yellow][R]\r标识。）\n之后，你可以选择在路线优化后直接播放该存档的\r[yellow]剩余录像\r，而无需再像接续播放一样选择录像起点和终点。\n\n详细使用方法参见露珠录制的视频教程：\n\r[yellow]https://bilibili.com/video/BV1az4y1C78x","请选择一个存档。\n\n\r[yellow]该存档需为录像播放中存的，且坐标必须和当前勇士坐标完全相同。\r\n将尝试播放此存档的剩余录像。",],function(){core.status.event.id="replaySince";core.lockControl();var c=core.saves.saveIndex;var b=parseInt((c-1)/5),a=c-5*b;core.ui._drawSLPanel(10*b+a)})};actions.prototype._clickReplay_download=function(){core.download(core.firstData.name+"_"+core.formatDate2()+".h5route",LZString.compressToBase64(JSON.stringify({name:core.firstData.name,hard:core.status.hard,seed:core.getFlag("__seed__"),route:core.encodeRoute(core.status.route)})))};actions.prototype._keyUpReplay=function(a){if(a==27||a==88){core.playSound("取消");core.ui.closePanel();return}this._selectChoices(core.status.event.ui.choices.length,a,this._clickReplay)};actions.prototype._clickGameInfo=function(d,e){if(this._out(d)){return}var a=core.status.event.ui.choices;var c=this._getChoicesTopIndex(a.length);if(e>=c&&e<c+a.length){var b=e-c;core.status.event.selection=b;switch(b){case 0:return core.ui._drawStatistics();case 1:return this._clickGameInfo_openProject();case 2:return this._clickGameInfo_openComments();case 3:return core.ui._drawHelp();case 4:return core.ui._drawAbout();case 5:return this._clickGameInfo_download();case 6:core.status.event.selection=5;core.playSound("取消");core.ui._drawSettings();break}}};actions.prototype._clickGameInfo_openProject=function(){if(core.platform.isPC){window.open("editor.html","_blank")}else{core.myconfirm("即将离开本游戏，跳转至工程页面，确认？",function(){window.location.href="editor-mobile.html"})}};actions.prototype._clickGameInfo_openComments=function(){if(core.platform.isPC){window.open("/score.php?name="+core.firstData.name,"_blank")}else{core.myconfirm("即将离开本游戏，跳转至评论页面，确认？",function(){window.location.href="/score.php?name="+core.firstData.name})}};actions.prototype._clickGameInfo_download=function(){if(core.platform.isPC){window.open(core.firstData.name+".zip")}else{window.location.href=core.firstData.name+".zip"}};actions.prototype._keyUpGameInfo=function(a){if(a==27||a==88){core.status.event.selection=5;core.playSound("取消");return core.ui._drawSettings()}this._selectChoices(core.status.event.ui.choices.length,a,this._clickGameInfo)};actions.prototype._clickKeyBoard=function(c,d){var b=this._HX_;if(d==this._HY_-3&&c>=b-5&&c<=b+5){core.ui.closePanel();core.keyUp(112+c+5-b)}if(d==this._HY_-2&&c>=b-5&&c<=b+4){core.ui.closePanel();core.keyUp(c==b+4?48:49+c+5-b)}var a=[["Q","W","E","R","T","Y","U","I","O","P"],["A","S","D","F","G","H","J","K","L"],["Z","X","C","V","B","N","M"],];if(d==this._HY_-1&&c>=b-5&&c<=b+4){core.ui.closePanel();core.keyUp(a[0][c+5-b].charCodeAt(0))}if(d==this._HY_&&c>=b-5&&c<=b+3){core.ui.closePanel();core.keyUp(a[1][c+5-b].charCodeAt(0))}if(d==this._HY_+1&&c>=b-5&&c<=b+1){core.ui.closePanel();core.keyUp(a[2][c+5-b].charCodeAt(0))}if(d==this._HY_+2&&c>=b-5&&c<=b+5){core.ui.closePanel();if(c==b-5){core.keyUp(189)}if(c==b-4){core.keyUp(187)}if(c==b-3){core.keyUp(219)}if(c==b-2){core.keyUp(221)}if(c==b-1){core.keyUp(220)}if(c==b){core.keyUp(186)}if(c==b+1){core.keyUp(222)}if(c==b+2){core.keyUp(188)}if(c==b+3){core.keyUp(190)}if(c==b+4){core.keyUp(191)}if(c==b+5){core.keyUp(192)}}if(d==this._HY_+3&&c>=b-5&&c<=b+4){core.ui.closePanel();if(c==b-5){core.keyUp(27)}if(c==b-4){core.keyUp(9)}if(c==b-3){core.keyUp(20)}if(c==b-2){core.keyUp(16)}if(c==b-1){core.keyUp(17)}if(c==b){core.keyUp(18)}if(c==b+1){core.keyUp(32)}if(c==b+2){core.keyUp(8)}if(c==b+3){core.keyUp(13)}if(c==b+4){core.keyUp(46)}}if(d==this._HY_+4&&c>=b+3&&c<=b+5){core.playSound("取消");core.ui.closePanel()}};actions.prototype._clickCursor=function(c,d,a,b){if(c==core.status.automaticRoute.cursorX&&d==core.status.automaticRoute.cursorY){core.ui.closePanel();this.doRegisteredAction("ondown",c,d,a,b);this.doRegisteredAction("onup",c,d,a,b);return}core.status.automaticRoute.cursorX=c;core.status.automaticRoute.cursorY=d;core.ui._drawCursor()};actions.prototype._keyDownCursor=function(a){if(a==37){core.status.automaticRoute.cursorX--;core.playSound("光标移动");core.ui._drawCursor();return}if(a==38){core.status.automaticRoute.cursorY--;core.playSound("光标移动");core.ui._drawCursor();return}if(a==39){core.status.automaticRoute.cursorX++;core.playSound("光标移动");core.ui._drawCursor();return}if(a==40){core.status.automaticRoute.cursorY++;core.playSound("光标移动");core.ui._drawCursor();return}};actions.prototype._keyUpCursor=function(a){if(a==27||a==88){core.playSound("取消");core.ui.closePanel();return}if(a==13||a==32||a==67||a==69){core.playSound("确定");core.ui.closePanel();var b=core.status.automaticRoute.cursorX;var c=core.status.automaticRoute.cursorY;this.doRegisteredAction("ondown",b,c,32*b+16,32*c+16);this.doRegisteredAction("onup",b,c,32*b+16,32*c+16);return}};"use strict";function data(){this._init()}data.prototype._init=function(){this.firstData=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d.firstData;this.values=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d.values;this.flags=data_a1e2fb4a_e986_4524_b0da_9b7ba7c0874d.flags};"use strict";function extensions(){}extensions.prototype._load=function(a){if(main.replayChecking){return a()}if(!window.fs){this._loadJs("_server/fs.js",function(){core.extensions._listExtensions(a)},a)}else{this._listExtensions(a)}};extensions.prototype._loadJs=function(b,a,c){var d=document.createElement("script");d.src=b+"?v="+main.version;d.onload=a;d.onerror=c;main.dom.body.appendChild(d)};extensions.prototype._listExtensions=function(a){if(!window.fs){return a()}fs.readdir("extensions",function(c,b){if(c||!(b instanceof Array)){return a()}var d=[];b.forEach(function(e){if(/^[\w.-]+\.js$/.test(e)){d.push(e)}});d.sort();core.extensions._loadExtensions(d,a)})};extensions.prototype._loadExtensions=function(c,a){var b=0;var d=function(){if(b==c.length){return a()}core.extensions._loadJs("extensions/"+c[b++],d,d)};d()};"use strict";function core(){this._WIDTH_=15;this._HEIGHT_=15;this._PX_=this._WIDTH_*32;this._PY_=this._HEIGHT_*32;this._HALF_WIDTH_=Math.floor(this._WIDTH_/2);this._HALF_HEIGHT_=Math.floor(this._HEIGHT_/2);this.__SIZE__=main.mode=="editor"?13:this._HEIGHT_;this.__PIXELS__=this.__SIZE__*32;this.__HALF_SIZE__=Math.floor(this.__SIZE__/2);this.material={animates:{},images:{},bgms:{},sounds:{},items:{},enemys:{},icons:{},ground:null,grundCanvas:null,groundPattern:null,autotileEdges:{},};this.timeout={turnHeroTimeout:null,onDownTimeout:null,sleepTimeout:null,};this.interval={heroMoveInterval:null,onDownInterval:null,};this.animateFrame={totalTime:0,totalTimeStart:0,globalAnimate:false,globalTime:0,selectorTime:0,selectorUp:true,animateTime:0,moveTime:0,lastLegTime:0,leftLeg:true,weather:{time:0,type:null,level:1,nodes:[],data:null,fog:null,cloud:null,sun:null},tip:null,asyncId:{},lastAsyncId:null};this.musicStatus={audioContext:null,bgmStatus:false,soundStatus:true,playingBgm:null,pauseTime:0,lastBgm:null,gainNode:null,playingSounds:{},userVolume:1,designVolume:1,bgmSpeed:100,bgmUsePitch:null,cachedBgms:[],cachedBgmCount:8,};this.platform={isOnline:true,isPC:true,isAndroid:false,isIOS:false,string:"PC",isWeChat:false,isQQ:false,isChrome:false,supportCopy:false,fileInput:null,fileReader:null,successCallback:null,errorCallback:null,};this.domStyle={scale:1,ratio:1,hdCanvas:["damage","ui","data"],availableScale:[],isVertical:false,showStatusBar:true,toolbarBtn:false,};this.bigmap={canvas:["bg","event","event2","fg","damage"],offsetX:0,offsetY:0,posX:0,posY:0,width:main.mode=="editor"?this.__SIZE__:this._WIDTH_,height:main.mode=="editor"?this.__SIZE__:this._HEIGHT_,v2:false,threshold:1024,extend:10,scale:1,tempCanvas:null,cacheCanvas:null,};this.saves={saveIndex:null,ids:{},autosave:{data:null,time:0,updated:false,storage:true,max:20,now:0,},favorite:[],favoriteName:{},cache:{}};this.initStatus={played:false,gameOver:false,hero:{},heroCenter:{px:null,py:null},floorId:null,thisMap:null,maps:null,bgmaps:{},fgmaps:{},mapBlockObjs:{},checkBlock:{},damage:{posX:0,posY:0,data:[],extraData:[],},lockControl:false,heroMoving:0,heroStop:true,automaticRoute:{autoHeroMove:false,autoStep:0,movedStep:0,destStep:0,destX:null,destY:null,offsetX:null,offsetY:null,autoStepRoutes:[],moveStepBeforeStop:[],lastDirection:null,cursorX:0,cursorY:0,moveDirectly:false,},downTime:null,ctrlDown:false,preview:{enabled:false,prepareDragging:false,dragging:false,px:0,py:0,},route:[],replay:{replaying:false,pausing:false,animate:false,failed:false,toReplay:[],totalList:[],speed:1,steps:0,save:[],},routeFolding:{},shops:{},event:{id:null,data:null,selection:null,ui:null,interval:null,},autoEvents:[],textAttribute:{position:"center",offset:0,title:[255,215,0,1],background:[0,0,0,0.85],text:[255,255,255,1],titlefont:22,textfont:16,bold:false,time:0,letterSpacing:0,animateTime:0,},globalAttribute:{equipName:main.equipName||[],statusLeftBackground:main.styles.statusLeftBackground||"url(project/materials/ground.png) repeat",statusTopBackground:main.styles.statusTopBackground||"url(project/materials/ground.png) repeat",toolsBackground:main.styles.toolsBackground||"url(project/materials/ground.png) repeat",borderColor:main.styles.borderColor||[204,204,204,1],statusBarColor:main.styles.statusBarColor||[255,255,255,1],floorChangingStyle:main.styles.floorChangingStyle||"background-color: black; color: white",selectColor:main.styles.selectColor||[255,215,0,1],font:main.styles.font||"Verdana"},curtainColor:null,globalAnimateObjs:[],floorAnimateObjs:[],boxAnimateObjs:[],autotileAnimateObjs:[],globalAnimateStatus:0,animateObjs:[],};this.markedFloorIds={};this.status={};this.dymCanvas={};if(main.mode=="editor"){document.documentElement.style.setProperty("--size",this.__SIZE__);document.documentElement.style.setProperty("--pixel",this.__PIXELS__+"px")}}core.prototype.init=function(d,c){this._forwardFuncs();for(var e in d){core[e]=d[e]}this._init_flags();this._init_platform();this._init_others();this._init_plugins();var a=main.mode=="editor";for(var f in core.canvas){if(core.domStyle.hdCanvas.indexOf(f)>=0){core.maps._setHDCanvasSize(core.canvas[f],a?core.__PIXELS__:core._PX_,a?core.__PIXELS__:core._PY_)}else{core.canvas[f].canvas.width=(a?core.__PIXELS__:core._PX_);core.canvas[f].canvas.height=(a?core.__PIXELS__:core._PY_)}}core.loader._load(function(){core.extensions._load(function(){core._afterLoadResources(c)})});core.dom.musicBtn.style.display="block";core.setMusicBtn()};core.prototype._init_flags=function(){core.flags=core.clone(core.data.flags);core.values=core.clone(core.data.values);core.firstData=core.clone(core.data.firstData);this._init_sys_flags();window.on=true;window.off=false;window.ture=true;window.flase=false;core.dom.versionLabel.innerText=core.firstData.version;core.dom.logoLabel.innerText=core.firstData.title;document.title=core.firstData.title+" - HTML5魔塔";document.getElementById("startLogo").innerText=core.firstData.title;(core.firstData.shops||[]).forEach(function(n){core.initStatus.shops[n.id]=n});core.maps._initFloors();core.material.enemys=core.enemys.getEnemys();core.material.items=core.items.getItems();core.material.icons=core.icons.getIcons();for(var h in core.floors){var d=core.floors[h].autoEvent||{};for(var j in d){var k=j.split(","),l=parseInt(k[0]),m=parseInt(k[1]);for(var i in d[j]){var a=core.clone(d[j][i]);if(a&&a.condition&&a.data){a.floorId=h;a.x=l;a.y=m;a.index=i;a.symbol=h+"@"+l+"@"+m+"@"+i;a.condition=core.replaceValue(a.condition);a.data=core.precompile(a.data);core.initStatus.autoEvents.push(a)}}}}for(var g in core.material.items){var e=core.material.items[g];if(e.cls!="equips"||!e.equip){continue}if(!e.equip.equipEvent&&!e.equip.unequipEvent){continue}var f="_equipEvent_"+g;var b={symbol:"_equipEvent_"+g,currentFloor:false,multiExecute:true,condition:"core.hasEquip('"+g+"') && !core.hasFlag('"+f+"')",data:core.precompile([{type:"setValue",name:"flag:"+f,value:"true"}].concat(e.equip.equipEvent||[])),};var c={symbol:"_unequipEvent_"+g,currentFloor:false,multiExecute:true,condition:"!core.hasEquip('"+g+"') && core.hasFlag('"+f+"')",data:core.precompile([{type:"setValue",name:"flag:"+f,value:"null"}].concat(e.equip.unequipEvent||[])),};core.initStatus.autoEvents.push(b);core.initStatus.autoEvents.push(c)}core.initStatus.autoEvents.sort(function(n,o){if(n.floorId==null){return 1}if(o.floorId==null){return -1}if(n.priority!=o.priority){return o.priority-n.priority}if(n.floorId!=o.floorId){return core.floorIds.indexOf(n.floorId)-core.floorIds.indexOf(o.floorId)}if(n.x!=o.x){return n.x-o.x}if(n.y!=o.y){return n.y-o.y}return n.index-o.index})};core.prototype._init_sys_flags=function(){if(core.flags.equipboxButton){core.flags.equipment=true}core.flags.displayEnemyDamage=core.getLocalStorage("enemyDamage",true);core.flags.displayCritical=core.getLocalStorage("critical",true);core.flags.displayExtraDamage=core.getLocalStorage("extraDamage",true);core.flags.enableEnemyPoint=core.getLocalStorage("enableEnemyPoint",core.flags.enableEnemyPoint);core.flags.leftHandPrefer=core.getLocalStorage("leftHandPrefer",false);core.flags.extraDamageType=core.getLocalStorage("extraDamageType",2);core.values.moveSpeed=core.getLocalStorage("moveSpeed",core.values.moveSpeed||100);core.values.floorChangeTime=core.getLocalStorage("floorChangeTime",core.values.floorChangeTime);if(core.values.floorChangeTime==null){core.values.floorChangeTime=500}core.flags.enableHDCanvas=core.getLocalStorage("enableHDCanvas",!core.platform.isIOS)};core.prototype._init_platform=function(){core.platform.isOnline=location.protocol.indexOf("http")==0;if(!core.platform.isOnline){alert("请勿直接打开html文件！使用启动服务或者APP进行离线游戏。")}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;core.musicStatus.bgmStatus=core.getLocalStorage("bgmStatus",true);core.musicStatus.soundStatus=core.getLocalStorage("soundStatus",true);core.musicStatus.userVolume=core.getLocalStorage("userVolume",0.7);try{core.musicStatus.audioContext=new window.AudioContext();core.musicStatus.gainNode=core.musicStatus.audioContext.createGain();core.musicStatus.gainNode.gain.value=core.musicStatus.userVolume;core.musicStatus.gainNode.connect(core.musicStatus.audioContext.destination)}catch(b){console.log("该浏览器不支持AudioContext");core.musicStatus.audioContext=null}["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"].forEach(function(c){if(navigator.userAgent.indexOf(c)>=0){if(c=="iPhone"||c=="iPad"||c=="iPod"){core.platform.isIOS=true}if(c=="Android"){core.platform.isAndroid=true}core.platform.isPC=false}});core.platform.string=core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"";core.platform.supportCopy=document.queryCommandSupported&&document.queryCommandSupported("copy");var a=/Chrome\/(\d+)\./i.exec(navigator.userAgent);if(a&&parseInt(a[1])>=50){core.platform.isChrome=true}core.platform.isSafari=/Safari/i.test(navigator.userAgent)&&!/Chrome/i.test(navigator.userAgent);core.platform.isQQ=/QQ/i.test(navigator.userAgent);core.platform.isWeChat=/MicroMessenger/i.test(navigator.userAgent);if(window.FileReader){core.platform.fileReader=new FileReader();core.platform.fileReader.onload=function(){core.readFileContent(core.platform.fileReader.result)};core.platform.fileReader.onerror=function(){if(core.platform.errorCallback){core.platform.errorCallback()}}}core.flags.enableHDCanvas=core.getLocalStorage("enableHDCanvas",!core.platform.isIOS);if(main.mode!="editor"){core.domStyle.scale=core.getLocalStorage("scale",1);if(core.flags.enableHDCanvas){core.domStyle.ratio=Math.max(window.devicePixelRatio||1,core.domStyle.scale)}}};core.prototype._init_others=function(){core.material.groundCanvas=document.createElement("canvas").getContext("2d");core.material.groundCanvas.canvas.width=core.material.groundCanvas.canvas.height=32;core.material.groundPattern=core.material.groundCanvas.createPattern(core.material.groundCanvas.canvas,"repeat");core.bigmap.tempCanvas=document.createElement("canvas").getContext("2d");core.bigmap.cacheCanvas=document.createElement("canvas").getContext("2d");core.loadImage("materials","fog",function(b,a){core.animateFrame.weather.fog=a});core.loadImage("materials","cloud",function(b,a){core.animateFrame.weather.cloud=a});core.loadImage("materials","sun",function(b,a){core.animateFrame.weather.sun=a});core.loadImage("materials","keyboard",function(b,a){core.material.images.keyboard=a});core.saves.saveIndex=core.getLocalStorage("saveIndex",1);core.control.getSaveIndexes(function(a){core.saves.ids=a})};core.prototype._afterLoadResources=function(a){core.initStatus.maps=core.maps._initMaps();core.control._setRequestAnimationFrame();(main.splitImages||[]).forEach(function(e){var d=core.getMappedName(e.name);if(!core.material.images.images[d]){console.warn("找不到图片："+d+"，无法裁剪");return}if(!d.endsWith(".png")){console.warn("无法裁剪非png格式图片："+d);return}var b=core.splitImage(core.material.images.images[d],e.width,e.height);for(var c=0;c<b.length;++c){core.material.images.images[(e.prefix||"")+c+".png"]=b[c]}});if(core.plugin._afterLoadResources){core.plugin._afterLoadResources()}core.showStartAnimate();if(a){a()}};core.prototype._init_plugins=function(){core.plugin=new function(){};for(var b in plugins_bb40132b_638b_4a9f_b028_d3fe47acc8d1){if(plugins_bb40132b_638b_4a9f_b028_d3fe47acc8d1[b] instanceof Function){try{plugins_bb40132b_638b_4a9f_b028_d3fe47acc8d1[b].apply(core.plugin)}catch(a){console.error(a);console.error("无法初始化插件"+b)}}}core._forwardFunc("plugin")};core.prototype._forwardFuncs=function(){for(var a=0;a<main.loadList.length;++a){var b=main.loadList[a];if(b=="core"){continue}this._forwardFunc(b)}};core.prototype._forwardFunc=function(name,funcname){if(funcname==null){for(funcname in core[name]){if(funcname.charAt(0)!="_"&&core[name][funcname] instanceof Function){this._forwardFunc(name,funcname)}}return}if(core[funcname]){console.error("ERROR: 无法转发 "+name+" 中的函数 "+funcname+" 到 core 中！同名函数已存在。");return}var parameterInfo=/^\s*function\s*[\w_$]*\(([\w_,$\s]*)\)\s*\{/.exec(core[name][funcname].toString());var parameters=(parameterInfo==null?"":parameterInfo[1]).replace(/\s*/g,"").replace(/,/g,", ");eval("core."+funcname+" = function ("+parameters+") {\n\treturn core."+name+"."+funcname+".apply(core."+name+", arguments);\n}")};core.prototype.doFunc=function(b,a){if(typeof b=="string"){b=core.plugin[b];a=core.plugin}return b.apply(a,Array.prototype.slice.call(arguments,2))};var core=new core();